"use strict";function _instanceof(t,i){return null!=i&&"undefined"!=typeof Symbol&&i[Symbol.hasInstance]?!!i[Symbol.hasInstance](t):t instanceof i}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).OIMO={}),null==window.OIMO&&(window.OIMO=exports)}(this,function(t){void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),s=1;s<arguments.length;s++){var h=arguments[s];if(null!=h)for(var e in h)Object.prototype.hasOwnProperty.call(h,e)&&(i[e]=h[e])}return i});var s,h,e,o,a="1.0.9",n=0,r=1,l=2,c=3,m=0,p=0,u=1,y=2,x=3,d=4,f=5,b=0,v=1,z=2,N=3,k=4,V=5,w=6,M={sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,degtorad:.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,INF:1/0,EPZ:1e-5,EPZ2:1e-6,lerp:function(t,i,s){return(1-s)*t+s*i},randInt:function(t,i){return t+M.floor(M.random()*(i-t+1))},rand:function(t,i){return t+M.random()*(i-t)},generateUUID:(h="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),e=new Array(36),o=0,function(){for(var t=0;t<36;t++)8===t||13===t||18===t||23===t?e[t]="-":14===t?e[t]="4":(o<=2&&(o=33554432+16777216*Math.random()|0),s=15&o,o>>=4,e[t]=h[19===t?3&s|8:s]);return e.join("")}),int:function(t){return M.floor(t)},fix:function(t,i){return t.toFixed(i||3,10)},clamp:function(t,i,s){return M.max(i,M.min(s,t))},distance:function(t,i){var s=i[0]-t[0],h=i[1]-t[1],e=i[2]-t[2];return M.sqrt(s*s+h*h+e*e)},acosClamp:function(t){return t>1?0:t<-1?M.PI:M.acos(t)},distanceVector:function(t,i){var s=t.x-i.x,h=t.y-i.y,e=t.z-i.z;return s*s+h*h+e*e},dotVectors:function(t,i){return t.x*i.x+t.y*i.y+t.z*i.z}};function printError(t,i){console.error("[OIMO] "+t+": "+i)}function InfoDisplay(t){this.parent=t,this.infos=new Float32Array(13),this.f=[0,0,0],this.times=[0,0,0,0],this.broadPhase=this.parent.broadPhaseType,this.version=a,this.fps=0,this.tt=0,this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.totalTime=0,this.updateTime=0,this.MaxBroadPhaseTime=0,this.MaxNarrowPhaseTime=0,this.MaxSolvingTime=0,this.MaxTotalTime=0,this.MaxUpdateTime=0}function Vec3(t,i,s){this.x=t||0,this.y=i||0,this.z=s||0}function Quat(t,i,s,h){this.x=t||0,this.y=i||0,this.z=s||0,this.w=void 0!==h?h:1}function Mat33(t,i,s,h,e,o,a,n,r){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("OIMO.Mat33: the constructor no longer reads arguments. use .set() instead.")}function AABB(t,i,s,h,e,o){this.elements=new Float32Array(6);var a=this.elements;a[0]=t||0,a[1]=s||0,a[2]=e||0,a[3]=i||0,a[4]=h||0,a[5]=o||0}Object.assign(InfoDisplay.prototype,{setTime:function(t){this.times[t||0]=performance.now()},resetMax:function(){this.MaxBroadPhaseTime=0,this.MaxNarrowPhaseTime=0,this.MaxSolvingTime=0,this.MaxTotalTime=0,this.MaxUpdateTime=0},calcBroadPhase:function(){this.setTime(2),this.broadPhaseTime=this.times[2]-this.times[1]},calcNarrowPhase:function(){this.setTime(3),this.narrowPhaseTime=this.times[3]-this.times[2]},calcEnd:function(){this.setTime(2),this.solvingTime=this.times[2]-this.times[1],this.totalTime=this.times[2]-this.times[0],this.updateTime=this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime),100===this.tt&&this.resetMax(),this.tt>100&&(this.broadPhaseTime>this.MaxBroadPhaseTime&&(this.MaxBroadPhaseTime=this.broadPhaseTime),this.narrowPhaseTime>this.MaxNarrowPhaseTime&&(this.MaxNarrowPhaseTime=this.narrowPhaseTime),this.solvingTime>this.MaxSolvingTime&&(this.MaxSolvingTime=this.solvingTime),this.totalTime>this.MaxTotalTime&&(this.MaxTotalTime=this.totalTime),this.updateTime>this.MaxUpdateTime&&(this.MaxUpdateTime=this.updateTime)),this.upfps(),this.tt++,this.tt>500&&(this.tt=0)},upfps:function(){this.f[1]=Date.now(),this.f[1]-1e3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0),this.f[2]++},show:function(){return["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconds<br><br>","broadphase &nbsp;"+M.fix(this.broadPhaseTime)+" | "+M.fix(this.MaxBroadPhaseTime)+"<br>","narrowphase "+M.fix(this.narrowPhaseTime)+" | "+M.fix(this.MaxNarrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;"+M.fix(this.solvingTime)+" | "+M.fix(this.MaxSolvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+M.fix(this.totalTime)+" | "+M.fix(this.MaxTotalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;"+M.fix(this.updateTime)+" | "+M.fix(this.MaxUpdateTime)+"<br>"].join("\n")},toArray:function(){return this.infos[0]=this.parent.broadPhase.types,this.infos[1]=this.parent.numRigidBodies,this.infos[2]=this.parent.numContacts,this.infos[3]=this.parent.broadPhase.numPairChecks,this.infos[4]=this.parent.numContactPoints,this.infos[5]=this.parent.numIslands,this.infos[6]=this.broadPhaseTime,this.infos[7]=this.narrowPhaseTime,this.infos[8]=this.solvingTime,this.infos[9]=this.updateTime,this.infos[10]=this.totalTime,this.infos[11]=this.fps,this.infos}}),Object.assign(Vec3.prototype,{Vec3:!0,set:function(t,i,s){return this.x=t,this.y=i,this.z=s,this},add:function(t,i){return void 0!==i?this.addVectors(t,i):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},addVectors:function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addEqual:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},sub:function(t,i){return void 0!==i?this.subVectors(t,i):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)},subVectors:function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},subEqual:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},scale:function(t,i){return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},scaleEqual:function(t){return this.x*=t,this.y*=t,this.z*=t,this},multiply:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},addScaledVector:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},subScaledVector:function(t,i){return this.x-=t.x*i,this.y-=t.y*i,this.z-=t.z*i,this},cross:function(t,i){if(void 0!==i)return this.crossVectors(t,i);var s=this.x,h=this.y,e=this.z;return this.x=h*t.z-e*t.y,this.y=e*t.x-s*t.z,this.z=s*t.y-h*t.x,this},crossVectors:function(t,i){var s=t.x,h=t.y,e=t.z,o=i.x,a=i.y,n=i.z;return this.x=h*n-e*a,this.y=e*o-s*n,this.z=s*a-h*o,this},tangent:function(t){var i=t.x,s=t.y,h=t.z;return this.x=s*i-h*h,this.y=-h*s-i*i,this.z=i*h+s*s,this},invert:function(t){return this.x=-t.x,this.y=-t.y,this.z=-t.z,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},addition:function(){return this.x+this.y+this.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return M.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},applyMatrix3:function(t,i){var s=this.x,h=this.y,e=this.z,o=t.elements;return i?(this.x=o[0]*s+o[1]*h+o[2]*e,this.y=o[3]*s+o[4]*h+o[5]*e,this.z=o[6]*s+o[7]*h+o[8]*e):(this.x=o[0]*s+o[3]*h+o[6]*e,this.y=o[1]*s+o[4]*h+o[7]*e,this.z=o[2]*s+o[5]*h+o[8]*e),this},applyQuaternion:function(t){var i=this.x,s=this.y,h=this.z,e=t.x,o=t.y,a=t.z,n=t.w,r=n*i+o*h-a*s,l=n*s+a*i-e*h,c=n*h+e*s-o*i,m=-e*i-o*s-a*h;return this.x=r*n+m*-e+l*-a-c*-o,this.y=l*n+m*-o+c*-e-r*-a,this.z=c*n+m*-a+r*-o-l*-e,this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z},testDiff:function(t){return!this.equals(t)},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this},divideScalar:function(t){return this.multiplyScalar(1/t)},normalize:function(){return this.divideScalar(this.length())},toArray:function(t,i){void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z},fromArray:function(t,i){return void 0===i&&(i=0),this.x=t[i],this.y=t[i+1],this.z=t[i+2],this}}),Object.assign(Quat.prototype,{Quat:!0,set:function(t,i,s,h){return this.x=t,this.y=i,this.z=s,this.w=h,this},addTime:function(t,i){var s=t.x,h=t.y,e=t.z,o=this.w,a=this.x,n=this.y,r=this.z;return i*=.5,this.x+=i*(s*o+h*r-e*n),this.y+=i*(h*o+e*a-s*r),this.z+=i*(e*o+s*n-h*a),this.w+=i*(-s*a-h*n-e*r),this.normalize(),this},multiply:function(t,i){return void 0!==i?this.multiplyQuaternions(t,i):this.multiplyQuaternions(this,t)},multiplyQuaternions:function(t,i){var s=t.x,h=t.y,e=t.z,o=t.w,a=i.x,n=i.y,r=i.z,l=i.w;return this.x=s*l+o*a+h*r-e*n,this.y=h*l+o*n+e*a-s*r,this.z=e*l+o*r+s*n-h*a,this.w=o*l-s*a-h*n-e*r,this},setFromUnitVectors:function(t,i){var s=new Vec3,h=t.dot(i)+1;return h<M.EPS2?(h=0,M.abs(t.x)>M.abs(t.z)?s.set(-t.y,t.x,0):s.set(0,-t.z,t.y)):s.crossVectors(t,i),this._x=s.x,this._y=s.y,this._z=s.z,this._w=h,this.normalize()},arc:function(t,i){var s=t.x,h=t.y,e=t.z,o=i.x,a=i.y,n=i.z,r=s*o+h*a+e*n;if(-1==r)return o=h*s-e*e,a=-e*h-s*s,n=s*e+h*h,r=1/M.sqrt(o*o+a*a+n*n),this.w=0,this.x=o*r,this.y=a*r,this.z=n*r,this;var l=h*n-e*a,c=e*o-s*n,m=s*a-h*o;return this.w=M.sqrt(.5*(1+r)),r=.5/this.w,this.x=l*r,this.y=c*r,this.z=m*r,this},normalize:function(){var t=this.length();return 0===t?this.set(0,0,0,1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this},inverse:function(){return this.conjugate().normalize()},invert:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this.conjugate().normalize(),this},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},length:function(){return M.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},clone:function(t){return new Quat(this.x,this.y,this.z,this.w)},testDiff:function(t){return!this.equals(t)},equals:function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},toString:function(){return"Quat["+this.x.toFixed(4)+", ("+this.y.toFixed(4)+", "+this.z.toFixed(4)+", "+this.w.toFixed(4)+")]"},setFromEuler:function(t,i,s){var h=Math.cos(.5*t),e=Math.cos(.5*i),o=Math.cos(.5*s),a=Math.sin(.5*t),n=Math.sin(.5*i),r=Math.sin(.5*s);return this.x=a*e*o+h*n*r,this.y=h*n*o-a*e*r,this.z=h*e*r+a*n*o,this.w=h*e*o-a*n*r,this},setFromAxis:function(t,i){t.normalize(),i*=.5;var s=M.sin(i);return this.x=s*t.x,this.y=s*t.y,this.z=s*t.z,this.w=M.cos(i),this},setFromMat33:function(t){var i,s=t[0]+t[4]+t[8];if(s>0)i=M.sqrt(s+1),this.w=.5/i,i=.5/i,this.x=(t[5]-t[7])*i,this.y=(t[6]-t[2])*i,this.z=(t[1]-t[3])*i;else{var h=[],e=0;t[4]>t[0]&&(e=1),t[8]>t[3*e+e]&&(e=2);var o=(e+1)%3,a=(e+2)%3;i=M.sqrt(t[3*e+e]-t[3*o+o]-t[3*a+a]+1),h[e]=.5*fRoot,i=.5/fRoot,this.w=(t[3*o+a]-t[3*a+o])*i,h[o]=(t[3*o+e]+t[3*e+o])*i,h[a]=(t[3*a+e]+t[3*e+a])*i,this.x=h[1],this.y=h[2],this.z=h[3]}return this},toArray:function(t,i){t[i=i||0]=this.x,t[i+1]=this.y,t[i+2]=this.z,t[i+3]=this.w},fromArray:function(t,i){return i=i||0,this.set(t[i],t[i+1],t[i+2],t[i+3]),this}}),Object.assign(Mat33.prototype,{Mat33:!0,set:function(t,i,s,h,e,o,a,n,r){var l=this.elements;return l[0]=t,l[1]=i,l[2]=s,l[3]=h,l[4]=e,l[5]=o,l[6]=a,l[7]=n,l[8]=r,this},add:function(t,i){if(void 0!==i)return this.addMatrixs(t,i);var s=this.elements,h=t.elements;return s[0]+=h[0],s[1]+=h[1],s[2]+=h[2],s[3]+=h[3],s[4]+=h[4],s[5]+=h[5],s[6]+=h[6],s[7]+=h[7],s[8]+=h[8],this},addMatrixs:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]+e[0],s[1]=h[1]+e[1],s[2]=h[2]+e[2],s[3]=h[3]+e[3],s[4]=h[4]+e[4],s[5]=h[5]+e[5],s[6]=h[6]+e[6],s[7]=h[7]+e[7],s[8]=h[8]+e[8],this},addEqual:function(t){var i=this.elements,s=t.elements;return i[0]+=s[0],i[1]+=s[1],i[2]+=s[2],i[3]+=s[3],i[4]+=s[4],i[5]+=s[5],i[6]+=s[6],i[7]+=s[7],i[8]+=s[8],this},sub:function(t,i){if(void 0!==i)return this.subMatrixs(t,i);var s=this.elements,h=t.elements;return s[0]-=h[0],s[1]-=h[1],s[2]-=h[2],s[3]-=h[3],s[4]-=h[4],s[5]-=h[5],s[6]-=h[6],s[7]-=h[7],s[8]-=h[8],this},subMatrixs:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]-e[0],s[1]=h[1]-e[1],s[2]=h[2]-e[2],s[3]=h[3]-e[3],s[4]=h[4]-e[4],s[5]=h[5]-e[5],s[6]=h[6]-e[6],s[7]=h[7]-e[7],s[8]=h[8]-e[8],this},subEqual:function(t){var i=this.elements,s=t.elements;return i[0]-=s[0],i[1]-=s[1],i[2]-=s[2],i[3]-=s[3],i[4]-=s[4],i[5]-=s[5],i[6]-=s[6],i[7]-=s[7],i[8]-=s[8],this},scale:function(t,i){var s=this.elements,h=t.elements;return s[0]=h[0]*i,s[1]=h[1]*i,s[2]=h[2]*i,s[3]=h[3]*i,s[4]=h[4]*i,s[5]=h[5]*i,s[6]=h[6]*i,s[7]=h[7]*i,s[8]=h[8]*i,this},scaleEqual:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},multiplyMatrices:function(t,i,s){s&&(i=i.clone().transpose());var h=this.elements,e=t.elements,o=i.elements,a=e[0],n=e[3],r=e[6],l=e[1],c=e[4],m=e[7],p=e[2],u=e[5],y=e[8],x=o[0],d=o[3],f=o[6],b=o[1],v=o[4],z=o[7],N=o[2],k=o[5],V=o[8];return h[0]=a*x+l*d+p*f,h[1]=a*b+l*v+p*z,h[2]=a*N+l*k+p*V,h[3]=n*x+c*d+u*f,h[4]=n*b+c*v+u*z,h[5]=n*N+c*k+u*V,h[6]=r*x+m*d+y*f,h[7]=r*b+m*v+y*z,h[8]=r*N+m*k+y*V,this},transpose:function(t){if(void 0!==t){var i=t.elements;return this.set(i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]),this}var s=this.elements,h=s[1],e=s[2],o=s[5];return s[1]=s[3],s[2]=s[6],s[3]=h,s[5]=s[7],s[6]=e,s[7]=o,this},setQuat:function(t){var i=this.elements,s=t.x,h=t.y,e=t.z,o=t.w,a=s+s,n=h+h,r=e+e,l=s*a,c=s*n,m=s*r,p=h*n,u=h*r,y=e*r,x=o*a,d=o*n,f=o*r;return i[0]=1-(p+y),i[1]=c-f,i[2]=m+d,i[3]=c+f,i[4]=1-(l+y),i[5]=u-x,i[6]=m-d,i[7]=u+x,i[8]=1-(l+p),this},invert:function(t){var i=this.elements,s=t.elements,h=s[0],e=s[3],o=s[6],a=s[1],n=s[4],r=s[7],l=s[2],c=s[5],m=s[8],p=m*n-c*r,u=-m*e+c*o,y=r*e-n*o,x=h*p+a*u+l*y;return 0===x?(console.log("can't invert matrix, determinant is 0"),this.identity()):(x=1/x,i[0]=p*x,i[1]=(-m*a+l*r)*x,i[2]=(c*a-l*n)*x,i[3]=u*x,i[4]=(m*h-l*o)*x,i[5]=(-c*h+l*e)*x,i[6]=y*x,i[7]=(-r*h+a*o)*x,i[8]=(n*h-a*e)*x,this)},addOffset:function(t,i){var s=i.x,h=i.y,e=i.z,o=this.elements;o[0]+=t*(h*h+e*e),o[4]+=t*(s*s+e*e),o[8]+=t*(s*s+h*h);var a=t*s*h,n=t*h*e,r=t*e*s;return o[1]-=a,o[3]-=a,o[2]-=n,o[6]-=n,o[5]-=r,o[7]-=r,this},subOffset:function(t,i){var s=i.x,h=i.y,e=i.z,o=this.elements;o[0]-=t*(h*h+e*e),o[4]-=t*(s*s+e*e),o[8]-=t*(s*s+h*h);var a=t*s*h,n=t*h*e,r=t*e*s;return o[1]+=a,o[3]+=a,o[2]+=n,o[6]+=n,o[5]+=r,o[7]+=r,this},multiplyScalar:function(t){var i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=t,i[4]*=t,i[7]*=t,i[2]*=t,i[5]*=t,i[8]*=t,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new Mat33).fromArray(this.elements)},copy:function(t){for(var i=0;i<9;i++)this.elements[i]=t.elements[i];return this},determinant:function(){var t=this.elements,i=t[0],s=t[1],h=t[2],e=t[3],o=t[4],a=t[5],n=t[6],r=t[7],l=t[8];return i*o*l-i*a*r-s*e*l+s*a*n+h*e*r-h*o*n},fromArray:function(t,i){void 0===i&&(i=0);for(var s=0;s<9;s++)this.elements[s]=t[s+i];return this},toArray:function(t,i){void 0===t&&(t=[]),void 0===i&&(i=0);var s=this.elements;return t[i]=s[0],t[i+1]=s[1],t[i+2]=s[2],t[i+3]=s[3],t[i+4]=s[4],t[i+5]=s[5],t[i+6]=s[6],t[i+7]=s[7],t[i+8]=s[8],t}}),Object.assign(AABB.prototype,{AABB:!0,set:function(t,i,s,h,e,o){var a=this.elements;return a[0]=t,a[3]=i,a[1]=s,a[4]=h,a[2]=e,a[5]=o,this},intersectTest:function(t){var i=this.elements,s=t.elements;return i[0]>s[3]||i[1]>s[4]||i[2]>s[5]||i[3]<s[0]||i[4]<s[1]||i[5]<s[2]},intersectTestTwo:function(t){var i=this.elements,s=t.elements;return i[0]<s[0]||i[1]<s[1]||i[2]<s[2]||i[3]>s[3]||i[4]>s[4]||i[5]>s[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t,i){var s=i||0,h=t.elements;return this.set(h[0]-s,h[3]+s,h[1]-s,h[4]+s,h[2]-s,h[5]+s),this},fromArray:function(t){return this.elements.set(t),this},combine:function(t,i){var s=t.elements,h=i.elements,e=this.elements;return e[0]=s[0]<h[0]?s[0]:h[0],e[1]=s[1]<h[1]?s[1]:h[1],e[2]=s[2]<h[2]?s[2]:h[2],e[3]=s[3]>h[3]?s[3]:h[3],e[4]=s[4]>h[4]?s[4]:h[4],e[5]=s[5]>h[5]?s[5]:h[5],this},surfaceArea:function(){var t=this.elements,i=t[3]-t[0],s=t[4]-t[1],h=t[5]-t[2];return 2*(i*(s+h)+s*h)},intersectsWithPoint:function(t,i,s){var h=this.elements;return t>=h[0]&&t<=h[3]&&i>=h[1]&&i<=h[4]&&s>=h[2]&&s<=h[5]},setFromPoints:function(t){this.makeEmpty();for(var i=0;i<t.length;i++)this.expandByPoint(t[i])},makeEmpty:function(){this.set(-1/0,-1/0,-1/0,1/0,1/0,1/0)},expandByPoint:function(t){var i=this.elements;this.set(M.min(i[0],t.x),M.min(i[1],t.y),M.min(i[2],t.z),M.max(i[3],t.x),M.max(i[4],t.y),M.max(i[5],t.z))},expandByScalar:function(t){var i=this.elements;i[0]+=-t,i[1]+=-t,i[2]+=-t,i[3]+=t,i[4]+=t,i[5]+=t}});var P=0;function Shape(t){this.type=p,this.id=P++,this.prev=null,this.next=null,this.proxy=null,this.parent=null,this.contactLink=null,this.numContacts=0,this.position=new Vec3,this.rotation=new Mat33,this.relativePosition=(new Vec3).copy(t.relativePosition),this.relativeRotation=(new Mat33).copy(t.relativeRotation),this.aabb=new AABB,this.density=t.density,this.friction=t.friction,this.restitution=t.restitution,this.belongsTo=t.belongsTo,this.collidesWith=t.collidesWith}function Box(t,i,s,h){Shape.call(this,t),this.type=y,this.width=i,this.height=s,this.depth=h,this.halfWidth=.5*i,this.halfHeight=.5*s,this.halfDepth=.5*h,this.dimentions=new Float32Array(18),this.elements=new Float32Array(24)}function Sphere(t,i){Shape.call(this,t),this.type=u,this.radius=i}function Cylinder(t,i,s){Shape.call(this,t),this.type=x,this.radius=i,this.height=s,this.halfHeight=.5*s,this.normalDirection=new Vec3,this.halfDirection=new Vec3}function Plane(t,i){Shape.call(this,t),this.type=d,this.normal=new Vec3(0,1,0)}function Particle(t,i){Shape.call(this,t),this.type=f}function ShapeConfig(){this.relativePosition=new Vec3,this.relativeRotation=new Mat33,this.friction=.2,this.restitution=.2,this.density=1,this.belongsTo=1,this.collidesWith=4294967295}function LimitMotor(t,i){i=i||!1,this.axis=t,this.angle=0,this.lowerLimit=i?0:1,this.upperLimit=0,this.motorSpeed=0,this.maxMotorForce=0,this.frequency=0,this.dampingRatio=0}function Constraint(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1}function JointLink(t){this.prev=null,this.next=null,this.body=null,this.joint=t}function Joint(t){Constraint.call(this),this.scale=1,this.invScale=1,this.name="",this.id=NaN,this.type=b,this.prev=null,this.next=null,this.body1=t.body1,this.body2=t.body2,this.localAnchorPoint1=(new Vec3).copy(t.localAnchorPoint1),this.localAnchorPoint2=(new Vec3).copy(t.localAnchorPoint2),this.relativeAnchorPoint1=new Vec3,this.relativeAnchorPoint2=new Vec3,this.anchorPoint1=new Vec3,this.anchorPoint2=new Vec3,this.allowCollision=t.allowCollision,this.b1Link=new JointLink(this),this.b2Link=new JointLink(this)}function LinearConstraint(t){this.m1=NaN,this.m2=NaN,this.ii1=null,this.ii2=null,this.dd=null,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.ax1x=NaN,this.ax1y=NaN,this.ax1z=NaN,this.ay1x=NaN,this.ay1y=NaN,this.ay1z=NaN,this.az1x=NaN,this.az1y=NaN,this.az1z=NaN,this.ax2x=NaN,this.ax2y=NaN,this.ax2z=NaN,this.ay2x=NaN,this.ay2y=NaN,this.ay2z=NaN,this.az2x=NaN,this.az2y=NaN,this.az2z=NaN,this.vel=NaN,this.velx=NaN,this.vely=NaN,this.velz=NaN,this.joint=t,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.b1=t.body1,this.b2=t.body2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0}function Rotational3Constraint(t,i,s,h){this.cfm1=NaN,this.cfm2=NaN,this.cfm3=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0}function HingeJoint(t,i,s){Joint.call(this,t),this.type=N,this.localAxis1=t.localAxis1.clone().normalize(),this.localAxis2=t.localAxis2.clone().normalize();var h=(new Mat33).setQuat((new Quat).setFromUnitVectors(this.localAxis1,this.localAxis2));this.localAngle1=(new Vec3).tangent(this.localAxis1).normalize(),this.localAngle2=this.localAngle1.clone().applyMatrix3(h,!0),this.ax1=new Vec3,this.ax2=new Vec3,this.an1=new Vec3,this.an2=new Vec3,this.tmp=new Vec3,this.nor=new Vec3,this.tan=new Vec3,this.bin=new Vec3,this.limitMotor=new LimitMotor(this.nor,!1),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.lc=new LinearConstraint(this),this.r3=new Rotational3Constraint(this,this.limitMotor,new LimitMotor(this.tan,!0),new LimitMotor(this.bin,!0))}function BallAndSocketJoint(t){Joint.call(this,t),this.type=z,this.lc=new LinearConstraint(this)}function TranslationalConstraint(t,i){this.cfm=NaN,this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x=NaN,this.t1y=NaN,this.t1z=NaN,this.t2x=NaN,this.t2y=NaN,this.t2z=NaN,this.l1x=NaN,this.l1y=NaN,this.l1z=NaN,this.l2x=NaN,this.l2y=NaN,this.l2z=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0}function DistanceJoint(t,i,s){Joint.call(this,t),this.type=v,this.nor=new Vec3,this.limitMotor=new LimitMotor(this.nor,!0),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.t=new TranslationalConstraint(this,this.limitMotor)}function AngularConstraint(t,i){this.joint=t,this.targetOrientation=(new Quat).invert(i),this.relativeOrientation=new Quat,this.ii1=null,this.ii2=null,this.dd=null,this.vel=new Vec3,this.imp=new Vec3,this.rn0=new Vec3,this.rn1=new Vec3,this.rn2=new Vec3,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia}function Translational3Constraint(t,i,s,h){this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x1=NaN,this.t1y1=NaN,this.t1z1=NaN,this.t2x1=NaN,this.t2y1=NaN,this.t2z1=NaN,this.l1x1=NaN,this.l1y1=NaN,this.l1z1=NaN,this.l2x1=NaN,this.l2y1=NaN,this.l2z1=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.t1x2=NaN,this.t1y2=NaN,this.t1z2=NaN,this.t2x2=NaN,this.t2y2=NaN,this.t2z2=NaN,this.l1x2=NaN,this.l1y2=NaN,this.l1z2=NaN,this.l2x2=NaN,this.l2y2=NaN,this.l2z2=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.t1x3=NaN,this.t1y3=NaN,this.t1z3=NaN,this.t2x3=NaN,this.t2y3=NaN,this.t2z3=NaN,this.l1x3=NaN,this.l1y3=NaN,this.l1z3=NaN,this.l2x3=NaN,this.l2y3=NaN,this.l2z3=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0,this.cfm1=0,this.cfm2=0,this.cfm3=0,this.weight=-1}function PrismaticJoint(t,i,s){Joint.call(this,t),this.type=w,this.localAxis1=t.localAxis1.clone().normalize(),this.localAxis2=t.localAxis2.clone().normalize(),this.ax1=new Vec3,this.ax2=new Vec3,this.nor=new Vec3,this.tan=new Vec3,this.bin=new Vec3,this.ac=new AngularConstraint(this,(new Quat).setFromUnitVectors(this.localAxis1,this.localAxis2)),this.limitMotor=new LimitMotor(this.nor,!0),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.t3=new Translational3Constraint(this,this.limitMotor,new LimitMotor(this.tan,!0),new LimitMotor(this.bin,!0))}function SliderJoint(t,i,s){Joint.call(this,t),this.type=V,this.localAxis1=t.localAxis1.clone().normalize(),this.localAxis2=t.localAxis2.clone().normalize();var h=(new Mat33).setQuat((new Quat).setFromUnitVectors(this.localAxis1,this.localAxis2));this.localAngle1=(new Vec3).tangent(this.localAxis1).normalize(),this.localAngle2=this.localAngle1.clone().applyMatrix3(h,!0),this.ax1=new Vec3,this.ax2=new Vec3,this.an1=new Vec3,this.an2=new Vec3,this.tmp=new Vec3,this.nor=new Vec3,this.tan=new Vec3,this.bin=new Vec3,this.rotationalLimitMotor=new LimitMotor(this.nor,!1),this.r3=new Rotational3Constraint(this,this.rotationalLimitMotor,new LimitMotor(this.tan,!0),new LimitMotor(this.bin,!0)),this.translationalLimitMotor=new LimitMotor(this.nor,!0),this.translationalLimitMotor.lowerLimit=i,this.translationalLimitMotor.upperLimit=s,this.t3=new Translational3Constraint(this,this.translationalLimitMotor,new LimitMotor(this.tan,!0),new LimitMotor(this.bin,!0))}function WheelJoint(t){Joint.call(this,t),this.type=k,this.localAxis1=t.localAxis1.clone().normalize(),this.localAxis2=t.localAxis2.clone().normalize(),this.localAngle1=new Vec3,this.localAngle2=new Vec3;var i=M.dotVectors(this.localAxis1,this.localAxis2);if(i>-1&&i<1)this.localAngle1.set(this.localAxis2.x-i*this.localAxis1.x,this.localAxis2.y-i*this.localAxis1.y,this.localAxis2.z-i*this.localAxis1.z).normalize(),this.localAngle2.set(this.localAxis1.x-i*this.localAxis2.x,this.localAxis1.y-i*this.localAxis2.y,this.localAxis1.z-i*this.localAxis2.z).normalize();else{var s=(new Mat33).setQuat((new Quat).setFromUnitVectors(this.localAxis1,this.localAxis2));this.localAngle1.tangent(this.localAxis1).normalize(),this.localAngle2=this.localAngle1.clone().applyMatrix3(s,!0)}this.ax1=new Vec3,this.ax2=new Vec3,this.an1=new Vec3,this.an2=new Vec3,this.tmp=new Vec3,this.nor=new Vec3,this.tan=new Vec3,this.bin=new Vec3,this.translationalLimitMotor=new LimitMotor(this.tan,!0),this.translationalLimitMotor.frequency=8,this.translationalLimitMotor.dampingRatio=1,this.rotationalLimitMotor1=new LimitMotor(this.tan,!1),this.rotationalLimitMotor2=new LimitMotor(this.bin,!1),this.t3=new Translational3Constraint(this,new LimitMotor(this.nor,!0),this.translationalLimitMotor,new LimitMotor(this.bin,!0)),this.t3.weight=1,this.r3=new Rotational3Constraint(this,new LimitMotor(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)}function JointConfig(){this.scale=1,this.invScale=1,this.body1=null,this.body2=null,this.localAnchorPoint1=new Vec3,this.localAnchorPoint2=new Vec3,this.localAxis1=new Vec3,this.localAxis2=new Vec3,this.allowCollision=!1}function MassInfo(){this.mass=0,this.inertia=new Mat33}function ContactLink(t){this.prev=null,this.next=null,this.shape=null,this.body=null,this.contact=t}function ImpulseDataBuffer(){this.lp1X=NaN,this.lp1Y=NaN,this.lp1Z=NaN,this.lp2X=NaN,this.lp2Y=NaN,this.lp2Z=NaN,this.impulse=NaN}function ManifoldPoint(){this.warmStarted=!1,this.position=new Vec3,this.localPoint1=new Vec3,this.localPoint2=new Vec3,this.normal=new Vec3,this.tangent=new Vec3,this.binormal=new Vec3,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.normalDenominator=0,this.tangentDenominator=0,this.binormalDenominator=0,this.penetration=0}function ContactManifold(){this.body1=null,this.body2=null,this.numPoints=0,this.points=[new ManifoldPoint,new ManifoldPoint,new ManifoldPoint,new ManifoldPoint]}function ContactPointDataBuffer(){this.nor=new Vec3,this.tan=new Vec3,this.bin=new Vec3,this.norU1=new Vec3,this.tanU1=new Vec3,this.binU1=new Vec3,this.norU2=new Vec3,this.tanU2=new Vec3,this.binU2=new Vec3,this.norT1=new Vec3,this.tanT1=new Vec3,this.binT1=new Vec3,this.norT2=new Vec3,this.tanT2=new Vec3,this.binT2=new Vec3,this.norTU1=new Vec3,this.tanTU1=new Vec3,this.binTU1=new Vec3,this.norTU2=new Vec3,this.tanTU2=new Vec3,this.binTU2=new Vec3,this.norImp=0,this.tanImp=0,this.binImp=0,this.norDen=0,this.tanDen=0,this.binDen=0,this.norTar=0,this.next=null,this.last=!1}function ContactConstraint(t){Constraint.call(this),this.manifold=t,this.restitution=NaN,this.friction=NaN,this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null,this.tmp=new Vec3,this.tmpC1=new Vec3,this.tmpC2=new Vec3,this.tmpP1=new Vec3,this.tmpP2=new Vec3,this.tmplv1=new Vec3,this.tmplv2=new Vec3,this.tmpav1=new Vec3,this.tmpav2=new Vec3,this.m1=NaN,this.m2=NaN,this.num=0,this.ps=t.points,this.cs=new ContactPointDataBuffer,this.cs.next=new ContactPointDataBuffer,this.cs.next.next=new ContactPointDataBuffer,this.cs.next.next.next=new ContactPointDataBuffer}function Contact(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.prev=null,this.next=null,this.persisting=!1,this.sleeping=!1,this.detector=null,this.constraint=null,this.touching=!1,this.close=!1,this.dist=M.INF,this.b1Link=new ContactLink(this),this.b2Link=new ContactLink(this),this.s1Link=new ContactLink(this),this.s2Link=new ContactLink(this),this.manifold=new ContactManifold,this.buffer=[new ImpulseDataBuffer,new ImpulseDataBuffer,new ImpulseDataBuffer,new ImpulseDataBuffer],this.points=this.manifold.points,this.constraint=new ContactConstraint(this.manifold)}function RigidBody(t,i){this.position=t||new Vec3,this.orientation=i||new Quat,this.scale=1,this.invScale=1,this.mesh=null,this.id=NaN,this.name="",this.prev=null,this.next=null,this.type=m,this.massInfo=new MassInfo,this.newPosition=new Vec3,this.controlPos=!1,this.newOrientation=new Quat,this.newRotation=new Vec3,this.currentRotation=new Vec3,this.controlRot=!1,this.controlRotInTime=!1,this.quaternion=new Quat,this.pos=new Vec3,this.linearVelocity=new Vec3,this.angularVelocity=new Vec3,this.parent=null,this.contactLink=null,this.numContacts=0,this.shapes=null,this.numShapes=0,this.jointLink=null,this.numJoints=0,this.sleepPosition=new Vec3,this.sleepOrientation=new Quat,this.isStatic=!1,this.isDynamic=!1,this.isKinematic=!1,this.rotation=new Mat33,this.mass=0,this.inverseMass=0,this.inverseInertia=new Mat33,this.localInertia=new Mat33,this.inverseLocalInertia=new Mat33,this.tmpInertia=new Mat33,this.addedToIsland=!1,this.allowSleep=!0,this.sleepTime=0,this.sleeping=!1}function Pair(t,i){this.shape1=t||null,this.shape2=i||null}function BroadPhase(){this.types=n,this.numPairChecks=0,this.numPairs=0,this.pairs=[]}Object.assign(Shape.prototype,{Shape:!0,calculateMassInfo:function(t){printError("Shape","Inheritance error.")},updateProxy:function(){printError("Shape","Inheritance error.")}}),Box.prototype=Object.assign(Object.create(Shape.prototype),{constructor:Box,calculateMassInfo:function(t){var i=this.width*this.height*this.depth*this.density;t.mass=i,t.inertia.set(i*(this.height*this.height+this.depth*this.depth)*(1/12),0,0,0,i*(this.width*this.width+this.depth*this.depth)*(1/12),0,0,0,i*(this.width*this.width+this.height*this.height)*(1/12))},updateProxy:function(){var t=this.rotation.elements,i=this.dimentions;i[0]=t[0],i[1]=t[3],i[2]=t[6],i[3]=t[1],i[4]=t[4],i[5]=t[7],i[6]=t[2],i[7]=t[5],i[8]=t[8],i[9]=t[0]*this.halfWidth,i[10]=t[3]*this.halfWidth,i[11]=t[6]*this.halfWidth,i[12]=t[1]*this.halfHeight,i[13]=t[4]*this.halfHeight,i[14]=t[7]*this.halfHeight,i[15]=t[2]*this.halfDepth,i[16]=t[5]*this.halfDepth,i[17]=t[8]*this.halfDepth;var s=i[9],h=i[10],e=i[11],o=i[12],a=i[13],n=i[14],r=i[15],l=i[16],c=i[17],m=this.position.x,p=this.position.y,u=this.position.z,y=this.elements;y[0]=m+s+o+r,y[1]=p+h+a+l,y[2]=u+e+n+c,y[3]=m+s+o-r,y[4]=p+h+a-l,y[5]=u+e+n-c,y[6]=m+s-o+r,y[7]=p+h-a+l,y[8]=u+e-n+c,y[9]=m+s-o-r,y[10]=p+h-a-l,y[11]=u+e-n-c,y[12]=m-s+o+r,y[13]=p-h+a+l,y[14]=u-e+n+c,y[15]=m-s+o-r,y[16]=p-h+a-l,y[17]=u-e+n-c,y[18]=m-s-o+r,y[19]=p-h-a+l,y[20]=u-e-n+c,y[21]=m-s-o-r,y[22]=p-h-a-l,y[23]=u-e-n-c;var x=i[9]<0?-i[9]:i[9],d=i[10]<0?-i[10]:i[10],f=i[11]<0?-i[11]:i[11];x=i[12]<0?x-i[12]:x+i[12],d=i[13]<0?d-i[13]:d+i[13],f=i[14]<0?f-i[14]:f+i[14],x=i[15]<0?x-i[15]:x+i[15],d=i[16]<0?d-i[16]:d+i[16],f=i[17]<0?f-i[17]:f+i[17];var b=.005;this.aabb.set(this.position.x-x-b,this.position.x+x+b,this.position.y-d-b,this.position.y+d+b,this.position.z-f-b,this.position.z+f+b),null!=this.proxy&&this.proxy.update()}}),Sphere.prototype=Object.assign(Object.create(Shape.prototype),{constructor:Sphere,volume:function(){return M.PI*this.radius*1.333333},calculateMassInfo:function(t){var i=this.volume()*this.radius*this.radius*this.density;t.mass=i;var s=i*this.radius*this.radius*.4;t.inertia.set(s,0,0,0,s,0,0,0,s)},updateProxy:function(){var t=.005;this.aabb.set(this.position.x-this.radius-t,this.position.x+this.radius+t,this.position.y-this.radius-t,this.position.y+this.radius+t,this.position.z-this.radius-t,this.position.z+this.radius+t),null!=this.proxy&&this.proxy.update()}}),Cylinder.prototype=Object.assign(Object.create(Shape.prototype),{constructor:Cylinder,calculateMassInfo:function(t){var i=this.radius*this.radius,s=M.PI*i*this.height*this.density,h=(.25*i+.0833*this.height*this.height)*s,e=.5*i;t.mass=s,t.inertia.set(h,0,0,0,e,0,0,0,h)},updateProxy:function(){var t,i,s,h,e,o,a,n,r,l,c,m=this.rotation.elements;e=m[1]*m[1],o=m[4]*m[4],a=m[7]*m[7],this.normalDirection.set(m[1],m[4],m[7]),this.halfDirection.scale(this.normalDirection,this.halfHeight),i=1-e,(t=M.sqrt(i*i+e*o+e*a))>0&&(t=this.radius/t),i*=t,s=1-o,(t=M.sqrt(o*e+s*s+o*a))>0&&(t=this.radius/t),s*=t,h=1-a,(t=M.sqrt(a*e+a*o+h*h))>0&&(t=this.radius/t),h*=t,n=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x,r=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y,l=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z,n=i<0?n-i:n+i,r=s<0?r-s:r+s,l=h<0?l-h:l+h,c=.005,this.aabb.set(this.position.x-n-c,this.position.x+n+c,this.position.y-r-c,this.position.y+r+c,this.position.z-l-c,this.position.z+l+c),null!=this.proxy&&this.proxy.update()}}),Plane.prototype=Object.assign(Object.create(Shape.prototype),{constructor:Plane,volume:function(){return Number.MAX_VALUE},calculateMassInfo:function(t){t.mass=this.density;t.inertia.set(1,0,0,0,1,0,0,0,1)},updateProxy:function(){var t=.005,i=-M.INF,s=M.INF,h=this.normal;this.aabb.set(-1===h.x?this.position.x-t:i,1===h.x?this.position.x+t:s,-1===h.y?this.position.y-t:i,1===h.y?this.position.y+t:s,-1===h.z?this.position.z-t:i,1===h.z?this.position.z+t:s),null!=this.proxy&&this.proxy.update()}}),Particle.prototype=Object.assign(Object.create(Shape.prototype),{constructor:Particle,volume:function(){return Number.MAX_VALUE},calculateMassInfo:function(t){t.inertia.set(0,0,0,0,0,0,0,0,0)},updateProxy:function(){this.aabb.set(this.position.x-0,this.position.x+0,this.position.y-0,this.position.y+0,this.position.z-0,this.position.z+0),null!=this.proxy&&this.proxy.update()}}),Object.assign(LimitMotor.prototype,{LimitMotor:!0,setLimit:function(t,i){this.lowerLimit=t,this.upperLimit=i},setMotor:function(t,i){this.motorSpeed=t,this.maxMotorForce=i},setSpring:function(t,i){this.frequency=t,this.dampingRatio=i}}),Object.assign(Constraint.prototype,{Constraint:!0,preSolve:function(t,i){printError("Constraint","Inheritance error.")},solve:function(){printError("Constraint","Inheritance error.")},postSolve:function(){printError("Constraint","Inheritance error.")}}),Joint.prototype=Object.assign(Object.create(Constraint.prototype),{constructor:Joint,setId:function(t){this.id=i},setParent:function(t){this.parent=t,this.scale=this.parent.scale,this.invScale=this.parent.invScale,this.id=this.parent.numJoints,this.name||(this.name="J"+this.id)},updateAnchorPoints:function(){this.relativeAnchorPoint1.copy(this.localAnchorPoint1).applyMatrix3(this.body1.rotation,!0),this.relativeAnchorPoint2.copy(this.localAnchorPoint2).applyMatrix3(this.body2.rotation,!0),this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position),this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)},attach:function(t){this.b1Link.body=this.body2,this.b2Link.body=this.body1,t?(this.body1.jointLink.push(this.b1Link),this.body2.jointLink.push(this.b2Link)):(null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null,this.body1.jointLink=this.b1Link,this.body1.numJoints++,null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null,this.body2.jointLink=this.b2Link,this.body2.numJoints++)},detach:function(t){if(t)this.body1.jointLink.splice(this.body1.jointLink.indexOf(this.b1Link),1),this.body2.jointLink.splice(this.body2.jointLink.indexOf(this.b2Link),1);else{var i=this.b1Link.prev,s=this.b1Link.next;null!=i&&(i.next=s),null!=s&&(s.prev=i),this.body1.jointLink==this.b1Link&&(this.body1.jointLink=s),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.body=null,this.body1.numJoints--,i=this.b2Link.prev,s=this.b2Link.next,null!=i&&(i.next=s),null!=s&&(s.prev=i),this.body2.jointLink==this.b2Link&&(this.body2.jointLink=s),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.body=null,this.body2.numJoints--}this.b1Link.body=null,this.b2Link.body=null},awake:function(){this.body1.awake(),this.body2.awake()},preSolve:function(t,i){},solve:function(){},postSolve:function(){},remove:function(){this.dispose()},dispose:function(){this.parent.removeJoint(this)},getPosition:function(){return[(new Vec3).scale(this.anchorPoint1,this.scale),(new Vec3).scale(this.anchorPoint2,this.scale)]}}),Object.assign(LinearConstraint.prototype,{LinearConstraint:!0,preSolve:function(t,i){this.r1x=this.r1.x,this.r1y=this.r1.y,this.r1z=this.r1.z,this.r2x=this.r2.x,this.r2y=this.r2.y,this.r2z=this.r2.z,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,h=this.ii2.elements;this.ax1x=this.r1z*s[1]+-this.r1y*s[2],this.ax1y=this.r1z*s[4]+-this.r1y*s[5],this.ax1z=this.r1z*s[7]+-this.r1y*s[8],this.ay1x=-this.r1z*s[0]+this.r1x*s[2],this.ay1y=-this.r1z*s[3]+this.r1x*s[5],this.ay1z=-this.r1z*s[6]+this.r1x*s[8],this.az1x=this.r1y*s[0]+-this.r1x*s[1],this.az1y=this.r1y*s[3]+-this.r1x*s[4],this.az1z=this.r1y*s[6]+-this.r1x*s[7],this.ax2x=this.r2z*h[1]+-this.r2y*h[2],this.ax2y=this.r2z*h[4]+-this.r2y*h[5],this.ax2z=this.r2z*h[7]+-this.r2y*h[8],this.ay2x=-this.r2z*h[0]+this.r2x*h[2],this.ay2y=-this.r2z*h[3]+this.r2x*h[5],this.ay2z=-this.r2z*h[6]+this.r2x*h[8],this.az2x=this.r2y*h[0]+-this.r2x*h[1],this.az2y=this.r2y*h[3]+-this.r2x*h[4],this.az2z=this.r2y*h[6]+-this.r2x*h[7];var e=this.m1+this.m2,o=(new Mat33).set(e,0,0,0,e,0,0,0,e).elements;o[0]+=s[4]*this.r1z*this.r1z-(s[7]+s[5])*this.r1y*this.r1z+s[8]*this.r1y*this.r1y,o[1]+=(s[6]*this.r1y+s[5]*this.r1x)*this.r1z-s[3]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,o[2]+=(s[3]*this.r1y-s[4]*this.r1x)*this.r1z-s[6]*this.r1y*this.r1y+s[7]*this.r1x*this.r1y,o[3]+=(s[2]*this.r1y+s[7]*this.r1x)*this.r1z-s[1]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,o[4]+=s[0]*this.r1z*this.r1z-(s[6]+s[2])*this.r1x*this.r1z+s[8]*this.r1x*this.r1x,o[5]+=(s[1]*this.r1x-s[0]*this.r1y)*this.r1z-s[7]*this.r1x*this.r1x+s[6]*this.r1x*this.r1y,o[6]+=(s[1]*this.r1y-s[4]*this.r1x)*this.r1z-s[2]*this.r1y*this.r1y+s[5]*this.r1x*this.r1y,o[7]+=(s[3]*this.r1x-s[0]*this.r1y)*this.r1z-s[5]*this.r1x*this.r1x+s[2]*this.r1x*this.r1y,o[8]+=s[0]*this.r1y*this.r1y-(s[3]+s[1])*this.r1x*this.r1y+s[4]*this.r1x*this.r1x,o[0]+=h[4]*this.r2z*this.r2z-(h[7]+h[5])*this.r2y*this.r2z+h[8]*this.r2y*this.r2y,o[1]+=(h[6]*this.r2y+h[5]*this.r2x)*this.r2z-h[3]*this.r2z*this.r2z-h[8]*this.r2x*this.r2y,o[2]+=(h[3]*this.r2y-h[4]*this.r2x)*this.r2z-h[6]*this.r2y*this.r2y+h[7]*this.r2x*this.r2y,o[3]+=(h[2]*this.r2y+h[7]*this.r2x)*this.r2z-h[1]*this.r2z*this.r2z-h[8]*this.r2x*this.r2y,o[4]+=h[0]*this.r2z*this.r2z-(h[6]+h[2])*this.r2x*this.r2z+h[8]*this.r2x*this.r2x,o[5]+=(h[1]*this.r2x-h[0]*this.r2y)*this.r2z-h[7]*this.r2x*this.r2x+h[6]*this.r2x*this.r2y,o[6]+=(h[1]*this.r2y-h[4]*this.r2x)*this.r2z-h[2]*this.r2y*this.r2y+h[5]*this.r2x*this.r2y,o[7]+=(h[3]*this.r2x-h[0]*this.r2y)*this.r2z-h[5]*this.r2x*this.r2x+h[2]*this.r2x*this.r2y,o[8]+=h[0]*this.r2y*this.r2y-(h[3]+h[1])*this.r2x*this.r2y+h[4]*this.r2x*this.r2x;var a=1/(o[0]*(o[4]*o[8]-o[7]*o[5])+o[3]*(o[7]*o[2]-o[1]*o[8])+o[6]*(o[1]*o[5]-o[4]*o[2]));this.dd=(new Mat33).set(o[4]*o[8]-o[5]*o[7],o[2]*o[7]-o[1]*o[8],o[1]*o[5]-o[2]*o[4],o[5]*o[6]-o[3]*o[8],o[0]*o[8]-o[2]*o[6],o[2]*o[3]-o[0]*o[5],o[3]*o[7]-o[4]*o[6],o[1]*o[6]-o[0]*o[7],o[0]*o[4]-o[1]*o[3]).scaleEqual(a),this.velx=this.p2.x-this.p1.x,this.vely=this.p2.y-this.p1.y,this.velz=this.p2.z-this.p1.z;var n=M.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);n>.005?(n=(.005-n)/n*i*.05,this.velx*=n,this.vely*=n,this.velz*=n):(this.velx=0,this.vely=0,this.velz=0),this.impx*=.95,this.impy*=.95,this.impz*=.95,this.l1.x+=this.impx*this.m1,this.l1.y+=this.impy*this.m1,this.l1.z+=this.impz*this.m1,this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x,this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y,this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z,this.l2.x-=this.impx*this.m2,this.l2.y-=this.impy*this.m2,this.l2.z-=this.impz*this.m2,this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x,this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y,this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var t=this.dd.elements,i=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,s=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,h=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,e=i*t[0]+s*t[1]+h*t[2],o=i*t[3]+s*t[4]+h*t[5],a=i*t[6]+s*t[7]+h*t[8];this.impx+=e,this.impy+=o,this.impz+=a,this.l1.x+=e*this.m1,this.l1.y+=o*this.m1,this.l1.z+=a*this.m1,this.a1.x+=e*this.ax1x+o*this.ay1x+a*this.az1x,this.a1.y+=e*this.ax1y+o*this.ay1y+a*this.az1y,this.a1.z+=e*this.ax1z+o*this.ay1z+a*this.az1z,this.l2.x-=e*this.m2,this.l2.y-=o*this.m2,this.l2.z-=a*this.m2,this.a2.x-=e*this.ax2x+o*this.ay2x+a*this.az2x,this.a2.y-=e*this.ax2y+o*this.ay2y+a*this.az2y,this.a2.z-=e*this.ax2z+o*this.ay2z+a*this.az2z}}),Object.assign(Rotational3Constraint.prototype,{Rotational3Constraint:!0,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor1.frequency,o=this.limitMotor2.frequency,a=this.limitMotor3.frequency,n=e>0,r=o>0,l=a>0,c=this.lowerLimit1<=this.upperLimit1,m=this.lowerLimit2<=this.upperLimit2,p=this.lowerLimit3<=this.upperLimit3,u=this.limitMotor1.angle;c?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-u):u<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-u):u>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-u):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),n||(this.limitVelocity1>.02?this.limitVelocity1-=.02:this.limitVelocity1<-.02?this.limitVelocity1+=.02:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0);var y=this.limitMotor2.angle;m?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-y):y<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-y):y>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-y):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),r||(this.limitVelocity2>.02?this.limitVelocity2-=.02:this.limitVelocity2<-.02?this.limitVelocity2+=.02:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0);var x=this.limitMotor3.angle;if(p?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-x):x<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-x):x>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-x):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),l||(this.limitVelocity3>.02?this.limitVelocity3-=.02:this.limitVelocity3<-.02?this.limitVelocity3+=.02:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||n)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||r)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||l)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0),this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02,this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12,this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22,this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02,this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12,this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22,this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02,this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12,this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22,this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02,this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12,this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22,this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02,this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12,this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22,this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02,this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12,this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22,this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1),this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2),this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3),this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1),this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2),this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3),this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1),this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2),this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3),this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,n&&2!=this.limitState1){var d=6.2831853*e,f=d*d*t,b=i/(f+2*this.limitMotor1.dampingRatio*d);this.cfm1=this.kv00*b,this.limitVelocity1*=f*b}else this.cfm1=0,this.limitVelocity1*=.05*i;r&&2!=this.limitState2?(b=i/((f=(d=6.2831853*o)*d*t)+2*this.limitMotor2.dampingRatio*d),this.cfm2=this.kv11*b,this.limitVelocity2*=f*b):(this.cfm2=0,this.limitVelocity2*=.05*i),l&&2!=this.limitState3?(b=i/((f=(d=6.2831853*a)*d*t)+2*this.limitMotor3.dampingRatio*d),this.cfm3=this.kv22*b,this.limitVelocity3*=f*b):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var v=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*v,this.d01=(this.k02*this.k21-this.k01*this.k22)*v,this.d02=(this.k01*this.k12-this.k02*this.k11)*v,this.d10=(this.k12*this.k20-this.k10*this.k22)*v,this.d11=(this.k00*this.k22-this.k02*this.k20)*v,this.d12=(this.k02*this.k10-this.k00*this.k12)*v,this.d20=(this.k10*this.k21-this.k11*this.k20)*v,this.d21=(this.k01*this.k20-this.k00*this.k21)*v,this.d22=(this.k00*this.k11-this.k01*this.k10)*v,this.limitImpulse1*=.95,this.motorImpulse1*=.95,this.limitImpulse2*=.95,this.motorImpulse2*=.95,this.limitImpulse3*=.95,this.motorImpulse3*=.95;var z=this.limitImpulse1+this.motorImpulse1,N=this.limitImpulse2+this.motorImpulse2,k=this.limitImpulse3+this.motorImpulse3;this.a1.x+=z*this.a1x1+N*this.a1x2+k*this.a1x3,this.a1.y+=z*this.a1y1+N*this.a1y2+k*this.a1y3,this.a1.z+=z*this.a1z1+N*this.a1z2+k*this.a1z3,this.a2.x-=z*this.a2x1+N*this.a2x2+k*this.a2x3,this.a2.y-=z*this.a2y1+N*this.a2y2+k*this.a2y3,this.a2.z-=z*this.a2z1+N*this.a2z2+k*this.a2z3},solve_:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z;this.limitVelocity3=30;var h=t*this.ax1+i*this.ay1+s*this.az1-this.limitVelocity1,e=t*this.ax2+i*this.ay2+s*this.az2-this.limitVelocity2,o=t*this.ax3+i*this.ay3+s*this.az3-this.limitVelocity3,a=h*this.d00+e*this.d01+o*this.d02,n=h*this.d10+e*this.d11+o*this.d12,r=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=a,this.limitImpulse2+=n,this.limitImpulse3+=r,this.a1.x+=a*this.a1x1+n*this.a1x2+r*this.a1x3,this.a1.y+=a*this.a1y1+n*this.a1y2+r*this.a1y3,this.a1.z+=a*this.a1z1+n*this.a1z2+r*this.a1z3,this.a2.x-=a*this.a2x1+n*this.a2x2+r*this.a2x3,this.a2.y-=a*this.a2y1+n*this.a2y2+r*this.a2y3,this.a2.z-=a*this.a2z1+n*this.a2z2+r*this.a2z3},solve:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,o=t*this.ax3+i*this.ay3+s*this.az3,a=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-a),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(o-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,o+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,o-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,u=this.limitImpulse2,y=this.limitImpulse3,x=h*this.d00+e*this.d01+o*this.d02,d=h*this.d10+e*this.d11+o*this.d12,f=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=x,this.limitImpulse2+=d,this.limitImpulse3+=f;var b,v=0;switch((2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(e+=(x=-p)*this.k10,o+=x*this.k20,v|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(h+=(d=-u)*this.k01,o+=d*this.k21,v|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(h+=(f=-y)*this.k02,e+=f*this.k12,v|=4),v){case 1:b=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*o)*b,f=(-this.k21*e+this.k11*o)*b;break;case 2:b=1/(this.k00*this.k22-this.k02*this.k20),x=(this.k22*h+-this.k02*o)*b,f=(-this.k20*h+this.k00*o)*b;break;case 3:f=o/this.k22;break;case 4:b=1/(this.k00*this.k11-this.k01*this.k10),x=(this.k11*h+-this.k01*e)*b,d=(-this.k10*h+this.k00*e)*b;break;case 5:d=e/this.k11;break;case 6:x=h/this.k00}this.limitImpulse1=x+p,this.limitImpulse2=d+u,this.limitImpulse3=f+y;var z=l+x,N=c+d,k=m+f;this.a1.x+=z*this.a1x1+N*this.a1x2+k*this.a1x3,this.a1.y+=z*this.a1y1+N*this.a1y2+k*this.a1y3,this.a1.z+=z*this.a1z1+N*this.a1z2+k*this.a1z3,this.a2.x-=z*this.a2x1+N*this.a2x2+k*this.a2x3,this.a2.y-=z*this.a2y1+N*this.a2y2+k*this.a2y3,this.a2.z-=z*this.a2z1+N*this.a2z2+k*this.a2z3,t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,e=t*this.ax2+i*this.ay2+s*this.az2}}),HingeJoint.prototype=Object.assign(Object.create(Joint.prototype),{constructor:HingeJoint,preSolve:function(t,i){this.updateAnchorPoints(),this.ax1.copy(this.localAxis1).applyMatrix3(this.body1.rotation,!0),this.ax2.copy(this.localAxis2).applyMatrix3(this.body2.rotation,!0),this.an1.copy(this.localAngle1).applyMatrix3(this.body1.rotation,!0),this.an2.copy(this.localAngle2).applyMatrix3(this.body2.rotation,!0),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).normalize(),this.tan.tangent(this.nor).normalize(),this.bin.crossVectors(this.nor,this.tan);var s=M.acosClamp(M.dotVectors(this.an1,this.an2));this.tmp.crossVectors(this.an1,this.an2),M.dotVectors(this.nor,this.tmp)<0?this.limitMotor.angle=-s:this.limitMotor.angle=s,this.tmp.crossVectors(this.ax1,this.ax2),this.r3.limitMotor2.angle=M.dotVectors(this.tan,this.tmp),this.r3.limitMotor3.angle=M.dotVectors(this.bin,this.tmp),this.r3.preSolve(t,i),this.lc.preSolve(t,i)},solve:function(){this.r3.solve(),this.lc.solve()},postSolve:function(){}}),BallAndSocketJoint.prototype=Object.assign(Object.create(Joint.prototype),{constructor:BallAndSocketJoint,preSolve:function(t,i){this.updateAnchorPoints(),this.lc.preSolve(t,i)},solve:function(){this.lc.solve()},postSolve:function(){}}),Object.assign(TranslationalConstraint.prototype,{TranslationalConstraint:!0,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,o=this.p2.y-this.p1.y,a=this.p2.z-this.p1.z,n=e*this.ax+o*this.ay+a*this.az,r=this.limitMotor.frequency,l=r>0;(l&&n>20||n<-20)&&(l=!1),this.lowerLimit<=this.upperLimit?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n<this.lowerLimit?(-1!=this.limitState&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n,l||(n=this.upperLimit)):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),l||(this.limitVelocity>.005?this.limitVelocity-=.005:this.limitVelocity<-.005?this.limitVelocity+=.005:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||l)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0);var c=n*this.ax,m=n*this.ay,p=n*this.az,u=this.m1/(this.m1+this.m2),y=1-u;if(this.r1x=this.r1.x+c*u,this.r1y=this.r1.y+m*u,this.r1z=this.r1.z+p*u,this.r2x=this.r2.x-c*y,this.r2y=this.r2.y-m*y,this.r2z=this.r2.z-p*y,this.t1x=this.r1y*this.az-this.r1z*this.ay,this.t1y=this.r1z*this.ax-this.r1x*this.az,this.t1z=this.r1x*this.ay-this.r1y*this.ax,this.t2x=this.r2y*this.az-this.r2z*this.ay,this.t2y=this.r2z*this.ax-this.r2x*this.az,this.t2z=this.r2x*this.ay-this.r2y*this.ax,this.l1x=this.ax*this.m1,this.l1y=this.ay*this.m1,this.l1z=this.az*this.m1,this.l2x=this.ax*this.m2,this.l2y=this.ay*this.m2,this.l2z=this.az*this.m2,this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02,this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12,this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22,this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02,this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12,this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22,this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x),this.invMotorDenom=1/this.motorDenom,l&&2!=this.limitState){var x=6.2831853*r,d=x*x*t,f=i/(d+2*this.limitMotor.dampingRatio*x);this.cfm=this.motorDenom*f,this.limitVelocity*=d*f}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm);var b=this.limitImpulse+this.motorImpulse;this.l1.x+=b*this.l1x,this.l1.y+=b*this.l1y,this.l1.z+=b*this.l1z,this.a1.x+=b*this.a1x,this.a1.y+=b*this.a1y,this.a1.z+=b*this.a1z,this.l2.x-=b*this.l2x,this.l2.y-=b*this.l2y,this.l2.z-=b*this.l2z,this.a2.x-=b*this.a2x,this.a2.y-=b*this.a2y,this.a2.z-=b*this.a2z},solve:function(){var t,i,s=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;if(this.enableMotor){t=(s-this.motorSpeed)*this.invMotorDenom;var h=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),s-=(t=this.motorImpulse-h)*this.motorDenom}else t=0;if(2!=this.limitState){i=(s-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=i,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),i=this.limitImpulse-e}else i=0;var o=i+t;this.l1.x+=o*this.l1x,this.l1.y+=o*this.l1y,this.l1.z+=o*this.l1z,this.a1.x+=o*this.a1x,this.a1.y+=o*this.a1y,this.a1.z+=o*this.a1z,this.l2.x-=o*this.l2x,this.l2.y-=o*this.l2y,this.l2.z-=o*this.l2z,this.a2.x-=o*this.a2x,this.a2.y-=o*this.a2y,this.a2.z-=o*this.a2z}}),DistanceJoint.prototype=Object.assign(Object.create(Joint.prototype),{constructor:DistanceJoint,preSolve:function(t,i){this.updateAnchorPoints(),this.nor.sub(this.anchorPoint2,this.anchorPoint1).normalize(),this.t.preSolve(t,i)},solve:function(){this.t.solve()},postSolve:function(){}}),Object.assign(AngularConstraint.prototype,{AngularConstraint:!0,preSolve:function(t,i){var s,h,e;this.ii1=this.i1.clone(),this.ii2=this.i2.clone(),s=1/((e=(new Mat33).add(this.ii1,this.ii2).elements)[0]*(e[4]*e[8]-e[7]*e[5])+e[3]*(e[7]*e[2]-e[1]*e[8])+e[6]*(e[1]*e[5]-e[4]*e[2])),this.dd=(new Mat33).set(e[4]*e[8]-e[5]*e[7],e[2]*e[7]-e[1]*e[8],e[1]*e[5]-e[2]*e[4],e[5]*e[6]-e[3]*e[8],e[0]*e[8]-e[2]*e[6],e[2]*e[3]-e[0]*e[5],e[3]*e[7]-e[4]*e[6],e[1]*e[6]-e[0]*e[7],e[0]*e[4]-e[1]*e[3]).multiplyScalar(s),this.relativeOrientation.invert(this.b1.orientation).multiply(this.targetOrientation).multiply(this.b2.orientation),s=2*this.relativeOrientation.w,this.vel.copy(this.relativeOrientation).multiplyScalar(s),(h=this.vel.length())>.02?(h=(.02-h)/h*i*.05,this.vel.multiplyScalar(h)):this.vel.set(0,0,0),this.rn1.copy(this.imp).applyMatrix3(this.ii1,!0),this.rn2.copy(this.imp).applyMatrix3(this.ii2,!0),this.a1.add(this.rn1),this.a2.sub(this.rn2)},solve:function(){var t=this.a2.clone().sub(this.a1).sub(this.vel);this.rn0.copy(t).applyMatrix3(this.dd,!0),this.rn1.copy(this.rn0).applyMatrix3(this.ii1,!0),this.rn2.copy(this.rn0).applyMatrix3(this.ii2,!0),this.imp.add(this.rn0),this.a1.add(this.rn1),this.a2.sub(this.rn2)}}),Object.assign(Translational3Constraint.prototype,{Translational3Constraint:!0,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,o=this.p2.y-this.p1.y,a=this.p2.z-this.p1.z,n=e*this.ax1+o*this.ay1+a*this.az1,r=e*this.ax2+o*this.ay2+a*this.az2,l=e*this.ax3+o*this.ay3+a*this.az3,c=this.limitMotor1.frequency,m=this.limitMotor2.frequency,p=this.limitMotor3.frequency,u=c>0,y=m>0,x=p>0,d=this.lowerLimit1<=this.upperLimit1,f=this.lowerLimit2<=this.upperLimit2,b=this.lowerLimit3<=this.upperLimit3;(u&&n>20||n<-20)&&(u=!1),(y&&r>20||r<-20)&&(y=!1),(x&&l>20||l<-20)&&(x=!1),d?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,u||(n=this.lowerLimit1)):n<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,u||(n=this.lowerLimit1)):n>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-n,u||(n=this.upperLimit1)):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),u||(this.limitVelocity1>.005?this.limitVelocity1-=.005:this.limitVelocity1<-.005?this.limitVelocity1+=.005:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0),f?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,y||(r=this.lowerLimit2)):r<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,y||(r=this.lowerLimit2)):r>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-r,y||(r=this.upperLimit2)):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),y||(this.limitVelocity2>.005?this.limitVelocity2-=.005:this.limitVelocity2<-.005?this.limitVelocity2+=.005:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0),b?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,x||(l=this.lowerLimit3)):l<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,x||(l=this.lowerLimit3)):l>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-l,x||(l=this.upperLimit3)):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),x||(this.limitVelocity3>.005?this.limitVelocity3-=.005:this.limitVelocity3<-.005?this.limitVelocity3+=.005:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||u)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||y)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||x)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0);var v=n*this.ax1+r*this.ax2+l*this.ax2,z=n*this.ay1+r*this.ay2+l*this.ay2,N=n*this.az1+r*this.az2+l*this.az2,k=this.m2/(this.m1+this.m2);this.weight>=0&&(k=this.weight);var V=1-k;this.r1x=this.r1.x+v*k,this.r1y=this.r1.y+z*k,this.r1z=this.r1.z+N*k,this.r2x=this.r2.x-v*V,this.r2y=this.r2.y-z*V,this.r2z=this.r2.z-N*V,this.t1x1=this.r1y*this.az1-this.r1z*this.ay1,this.t1y1=this.r1z*this.ax1-this.r1x*this.az1,this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1,this.t2x1=this.r2y*this.az1-this.r2z*this.ay1,this.t2y1=this.r2z*this.ax1-this.r2x*this.az1,this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1,this.l1x1=this.ax1*this.m1,this.l1y1=this.ay1*this.m1,this.l1z1=this.az1*this.m1,this.l2x1=this.ax1*this.m2,this.l2y1=this.ay1*this.m2,this.l2z1=this.az1*this.m2,this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02,this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12,this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22,this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02,this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12,this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22,this.t1x2=this.r1y*this.az2-this.r1z*this.ay2,this.t1y2=this.r1z*this.ax2-this.r1x*this.az2,this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2,this.t2x2=this.r2y*this.az2-this.r2z*this.ay2,this.t2y2=this.r2z*this.ax2-this.r2x*this.az2,this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2,this.l1x2=this.ax2*this.m1,this.l1y2=this.ay2*this.m1,this.l1z2=this.az2*this.m1,this.l2x2=this.ax2*this.m2,this.l2y2=this.ay2*this.m2,this.l2z2=this.az2*this.m2,this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02,this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12,this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22,this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02,this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12,this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22,this.t1x3=this.r1y*this.az3-this.r1z*this.ay3,this.t1y3=this.r1z*this.ax3-this.r1x*this.az3,this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3,this.t2x3=this.r2y*this.az3-this.r2z*this.ay3,this.t2y3=this.r2z*this.ax3-this.r2x*this.az3,this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3,this.l1x3=this.ax3*this.m1,this.l1y3=this.ay3*this.m1,this.l1z3=this.az3*this.m1,this.l2x3=this.ax3*this.m2,this.l2y3=this.ay3*this.m2,this.l2z3=this.az3*this.m2,this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02,this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12,this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22,this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02,this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12,this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var w=this.m1+this.m2;if(this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*w,this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*w,this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*w,this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*w,this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*w,this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*w,this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*w,this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*w,this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*w,this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1,this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2,this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3,this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1,this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2,this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3,this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1,this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2,this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3,this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1,this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2,this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3,this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1,this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2,this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3,this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1,this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2,this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3,this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,u&&2!=this.limitState1){var M=6.2831853*c,P=M*M*t,g=i/(P+2*this.limitMotor1.dampingRatio*M);this.cfm1=this.kv00*g,this.limitVelocity1*=P*g}else this.cfm1=0,this.limitVelocity1*=.05*i;y&&2!=this.limitState2?(g=i/((P=(M=6.2831853*m)*M*t)+2*this.limitMotor2.dampingRatio*M),this.cfm2=this.kv11*g,this.limitVelocity2*=P*g):(this.cfm2=0,this.limitVelocity2*=.05*i),x&&2!=this.limitState3?(g=i/((P=(M=6.2831853*p)*M*t)+2*this.limitMotor3.dampingRatio*M),this.cfm3=this.kv22*g,this.limitVelocity3*=P*g):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var S=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*S,this.d01=(this.k02*this.k21-this.k01*this.k22)*S,this.d02=(this.k01*this.k12-this.k02*this.k11)*S,this.d10=(this.k12*this.k20-this.k10*this.k22)*S,this.d11=(this.k00*this.k22-this.k02*this.k20)*S,this.d12=(this.k02*this.k10-this.k00*this.k12)*S,this.d20=(this.k10*this.k21-this.k11*this.k20)*S,this.d21=(this.k01*this.k20-this.k00*this.k21)*S,this.d22=(this.k00*this.k11-this.k01*this.k10)*S;var I=this.limitImpulse1+this.motorImpulse1,L=this.limitImpulse2+this.motorImpulse2,C=this.limitImpulse3+this.motorImpulse3;this.l1.x+=I*this.l1x1+L*this.l1x2+C*this.l1x3,this.l1.y+=I*this.l1y1+L*this.l1y2+C*this.l1y3,this.l1.z+=I*this.l1z1+L*this.l1z2+C*this.l1z3,this.a1.x+=I*this.a1x1+L*this.a1x2+C*this.a1x3,this.a1.y+=I*this.a1y1+L*this.a1y2+C*this.a1y3,this.a1.z+=I*this.a1z1+L*this.a1z2+C*this.a1z3,this.l2.x-=I*this.l2x1+L*this.l2x2+C*this.l2x3,this.l2.y-=I*this.l2y1+L*this.l2y2+C*this.l2y3,this.l2.z-=I*this.l2z1+L*this.l2z2+C*this.l2z3,this.a2.x-=I*this.a2x1+L*this.a2x2+C*this.a2x3,this.a2.y-=I*this.a2y1+L*this.a2y2+C*this.a2y3,this.a2.z-=I*this.a2z1+L*this.a2z2+C*this.a2z3},solve:function(){var t=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,i=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,s=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,o=t*this.ax3+i*this.ay3+s*this.az3,a=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-a),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(o-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,o+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,o-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,u=this.limitImpulse2,y=this.limitImpulse3,x=h*this.d00+e*this.d01+o*this.d02,d=h*this.d10+e*this.d11+o*this.d12,f=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=x,this.limitImpulse2+=d,this.limitImpulse3+=f;var b,v=0;switch((2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(e+=(x=-p)*this.k10,o+=x*this.k20,v|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(h+=(d=-u)*this.k01,o+=d*this.k21,v|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(h+=(f=-y)*this.k02,e+=f*this.k12,v|=4),v){case 1:b=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*o)*b,f=(-this.k21*e+this.k11*o)*b;break;case 2:b=1/(this.k00*this.k22-this.k02*this.k20),x=(this.k22*h+-this.k02*o)*b,f=(-this.k20*h+this.k00*o)*b;break;case 3:f=o/this.k22;break;case 4:b=1/(this.k00*this.k11-this.k01*this.k10),x=(this.k11*h+-this.k01*e)*b,d=(-this.k10*h+this.k00*e)*b;break;case 5:d=e/this.k11;break;case 6:x=h/this.k00}this.limitImpulse1=p+x,this.limitImpulse2=u+d,this.limitImpulse3=y+f;var z=l+x,N=c+d,k=m+f;this.l1.x+=z*this.l1x1+N*this.l1x2+k*this.l1x3,this.l1.y+=z*this.l1y1+N*this.l1y2+k*this.l1y3,this.l1.z+=z*this.l1z1+N*this.l1z2+k*this.l1z3,this.a1.x+=z*this.a1x1+N*this.a1x2+k*this.a1x3,this.a1.y+=z*this.a1y1+N*this.a1y2+k*this.a1y3,this.a1.z+=z*this.a1z1+N*this.a1z2+k*this.a1z3,this.l2.x-=z*this.l2x1+N*this.l2x2+k*this.l2x3,this.l2.y-=z*this.l2y1+N*this.l2y2+k*this.l2y3,this.l2.z-=z*this.l2z1+N*this.l2z2+k*this.l2z3,this.a2.x-=z*this.a2x1+N*this.a2x2+k*this.a2x3,this.a2.y-=z*this.a2y1+N*this.a2y2+k*this.a2y3,this.a2.z-=z*this.a2z1+N*this.a2z2+k*this.a2z3}}),PrismaticJoint.prototype=Object.assign(Object.create(Joint.prototype),{constructor:PrismaticJoint,preSolve:function(t,i){this.updateAnchorPoints(),this.ax1.copy(this.localAxis1).applyMatrix3(this.body1.rotation,!0),this.ax2.copy(this.localAxis2).applyMatrix3(this.body2.rotation,!0),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).normalize(),this.tan.tangent(this.nor).normalize(),this.bin.crossVectors(this.nor,this.tan),this.ac.preSolve(t,i),this.t3.preSolve(t,i)},solve:function(){this.ac.solve(),this.t3.solve()},postSolve:function(){}}),SliderJoint.prototype=Object.assign(Object.create(Joint.prototype),{constructor:SliderJoint,preSolve:function(t,i){this.updateAnchorPoints(),this.ax1.copy(this.localAxis1).applyMatrix3(this.body1.rotation,!0),this.an1.copy(this.localAngle1).applyMatrix3(this.body1.rotation,!0),this.ax2.copy(this.localAxis2).applyMatrix3(this.body2.rotation,!0),this.an2.copy(this.localAngle2).applyMatrix3(this.body2.rotation,!0),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).normalize(),this.tan.tangent(this.nor).normalize(),this.bin.crossVectors(this.nor,this.tan),this.tmp.crossVectors(this.an1,this.an2);var s=M.acosClamp(M.dotVectors(this.an1,this.an2));M.dotVectors(this.nor,this.tmp)<0?this.rotationalLimitMotor.angle=-s:this.rotationalLimitMotor.angle=s,this.tmp.crossVectors(this.ax1,this.ax2),this.r3.limitMotor2.angle=M.dotVectors(this.tan,this.tmp),this.r3.limitMotor3.angle=M.dotVectors(this.bin,this.tmp),this.r3.preSolve(t,i),this.t3.preSolve(t,i)},solve:function(){this.r3.solve(),this.t3.solve()},postSolve:function(){}}),WheelJoint.prototype=Object.assign(Object.create(Joint.prototype),{constructor:WheelJoint,preSolve:function(t,i){this.updateAnchorPoints(),this.ax1.copy(this.localAxis1).applyMatrix3(this.body1.rotation,!0),this.an1.copy(this.localAngle1).applyMatrix3(this.body1.rotation,!0),this.ax2.copy(this.localAxis2).applyMatrix3(this.body2.rotation,!0),this.an2.copy(this.localAngle2).applyMatrix3(this.body2.rotation,!0),this.r3.limitMotor1.angle=M.dotVectors(this.ax1,this.ax2);var s=M.dotVectors(this.an1,this.ax2);M.dotVectors(this.ax1,this.tmp.crossVectors(this.an1,this.ax2))<0?this.rotationalLimitMotor1.angle=-s:this.rotationalLimitMotor1.angle=s,s=M.dotVectors(this.an2,this.ax1),M.dotVectors(this.ax2,this.tmp.crossVectors(this.an2,this.ax1))<0?this.rotationalLimitMotor2.angle=-s:this.rotationalLimitMotor2.angle=s,this.nor.crossVectors(this.ax1,this.ax2).normalize(),this.tan.crossVectors(this.nor,this.ax2).normalize(),this.bin.crossVectors(this.nor,this.ax1).normalize(),this.r3.preSolve(t,i),this.t3.preSolve(t,i)},solve:function(){this.r3.solve(),this.t3.solve()},postSolve:function(){}}),ContactManifold.prototype={constructor:ContactManifold,reset:function(t,i){this.body1=t.parent,this.body2=i.parent,this.numPoints=0},addPointVec:function(t,i,s,h){var e=this.points[this.numPoints++];e.position.copy(t),e.localPoint1.sub(t,this.body1.position).applyMatrix3(this.body1.rotation),e.localPoint2.sub(t,this.body2.position).applyMatrix3(this.body2.rotation),e.normal.copy(i),h&&e.normal.negate(),e.normalImpulse=0,e.penetration=s,e.warmStarted=!1},addPoint:function(t,i,s,h,e,o,a,n){var r=this.points[this.numPoints++];r.position.set(t,i,s),r.localPoint1.sub(r.position,this.body1.position).applyMatrix3(this.body1.rotation),r.localPoint2.sub(r.position,this.body2.position).applyMatrix3(this.body2.rotation),r.normalImpulse=0,r.normal.set(h,e,o),n&&r.normal.negate(),r.penetration=a,r.warmStarted=!1}},ContactConstraint.prototype=Object.assign(Object.create(Constraint.prototype),{constructor:ContactConstraint,attach:function(){this.p1=this.body1.position,this.p2=this.body2.position,this.lv1=this.body1.linearVelocity,this.av1=this.body1.angularVelocity,this.lv2=this.body2.linearVelocity,this.av2=this.body2.angularVelocity,this.i1=this.body1.inverseInertia,this.i2=this.body2.inverseInertia},detach:function(){this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null},preSolve:function(t,i){this.m1=this.body1.inverseMass,this.m2=this.body2.inverseMass;var s=this.m1+this.m2;this.num=this.manifold.numPoints;for(var h,e,o,a,n,r,l,c=this.cs,m=0;m<this.num;m++)h=this.ps[m],this.tmpP1.sub(h.position,this.p1),this.tmpP2.sub(h.position,this.p2),this.tmpC1.crossVectors(this.av1,this.tmpP1),this.tmpC2.crossVectors(this.av2,this.tmpP2),c.norImp=h.normalImpulse,c.tanImp=h.tangentImpulse,c.binImp=h.binormalImpulse,c.nor.copy(h.normal),this.tmp.set(this.lv2.x+this.tmpC2.x-(this.lv1.x+this.tmpC1.x),this.lv2.y+this.tmpC2.y-(this.lv1.y+this.tmpC1.y),this.lv2.z+this.tmpC2.z-(this.lv1.z+this.tmpC1.z)),e=M.dotVectors(c.nor,this.tmp),c.tan.set(this.tmp.x-e*c.nor.x,this.tmp.y-e*c.nor.y,this.tmp.z-e*c.nor.z),M.dotVectors(c.tan,c.tan)<=.04&&c.tan.tangent(c.nor),c.tan.normalize(),c.bin.crossVectors(c.nor,c.tan),c.norU1.scale(c.nor,this.m1),c.norU2.scale(c.nor,this.m2),c.tanU1.scale(c.tan,this.m1),c.tanU2.scale(c.tan,this.m2),c.binU1.scale(c.bin,this.m1),c.binU2.scale(c.bin,this.m2),c.norT1.crossVectors(this.tmpP1,c.nor),c.tanT1.crossVectors(this.tmpP1,c.tan),c.binT1.crossVectors(this.tmpP1,c.bin),c.norT2.crossVectors(this.tmpP2,c.nor),c.tanT2.crossVectors(this.tmpP2,c.tan),c.binT2.crossVectors(this.tmpP2,c.bin),r=this.i1,l=this.i2,c.norTU1.copy(c.norT1).applyMatrix3(r,!0),c.tanTU1.copy(c.tanT1).applyMatrix3(r,!0),c.binTU1.copy(c.binT1).applyMatrix3(r,!0),c.norTU2.copy(c.norT2).applyMatrix3(l,!0),c.tanTU2.copy(c.tanT2).applyMatrix3(l,!0),c.binTU2.copy(c.binT2).applyMatrix3(l,!0),this.tmpC1.crossVectors(c.norTU1,this.tmpP1),this.tmpC2.crossVectors(c.norTU2,this.tmpP2),this.tmp.add(this.tmpC1,this.tmpC2),c.norDen=1/(s+M.dotVectors(c.nor,this.tmp)),this.tmpC1.crossVectors(c.tanTU1,this.tmpP1),this.tmpC2.crossVectors(c.tanTU2,this.tmpP2),this.tmp.add(this.tmpC1,this.tmpC2),c.tanDen=1/(s+M.dotVectors(c.tan,this.tmp)),this.tmpC1.crossVectors(c.binTU1,this.tmpP1),this.tmpC2.crossVectors(c.binTU2,this.tmpP2),this.tmp.add(this.tmpC1,this.tmpC2),c.binDen=1/(s+M.dotVectors(c.bin,this.tmp)),h.warmStarted?(o=h.normalImpulse,this.lv1.addScaledVector(c.norU1,o),this.av1.addScaledVector(c.norTU1,o),this.lv2.subScaledVector(c.norU2,o),this.av2.subScaledVector(c.norTU2,o),c.norImp=o,c.tanImp=0,c.binImp=0,e=0):(c.norImp=0,c.tanImp=0,c.binImp=0),e>-1&&(e=0),(a=this.restitution*-e)<(n=-(h.penetration+.005)*i*.05)&&(a=n),c.norTar=a,c.last=m==this.num-1,c=c.next},solve:function(){var t,i,s,h,e,o,a,n,r;this.tmplv1.copy(this.lv1),this.tmplv2.copy(this.lv2),this.tmpav1.copy(this.av1),this.tmpav2.copy(this.av2);for(var l=this.cs;e=l.norImp,o=l.tanImp,a=l.binImp,n=-e*this.friction,this.tmp.sub(this.tmplv2,this.tmplv1),t=o,s=a,(r=(o+=i=(M.dotVectors(this.tmp,l.tan)+M.dotVectors(this.tmpav2,l.tanT2)-M.dotVectors(this.tmpav1,l.tanT1))*l.tanDen)*o+(a+=h=(M.dotVectors(this.tmp,l.bin)+M.dotVectors(this.tmpav2,l.binT2)-M.dotVectors(this.tmpav1,l.binT1))*l.binDen)*a)>n*n&&(o*=r=n/M.sqrt(r),a*=r),i=o-t,h=a-s,this.tmp.set(l.tanU1.x*i+l.binU1.x*h,l.tanU1.y*i+l.binU1.y*h,l.tanU1.z*i+l.binU1.z*h),this.tmplv1.addEqual(this.tmp),this.tmp.set(l.tanTU1.x*i+l.binTU1.x*h,l.tanTU1.y*i+l.binTU1.y*h,l.tanTU1.z*i+l.binTU1.z*h),this.tmpav1.addEqual(this.tmp),this.tmp.set(l.tanU2.x*i+l.binU2.x*h,l.tanU2.y*i+l.binU2.y*h,l.tanU2.z*i+l.binU2.z*h),this.tmplv2.subEqual(this.tmp),this.tmp.set(l.tanTU2.x*i+l.binTU2.x*h,l.tanTU2.y*i+l.binTU2.y*h,l.tanTU2.z*i+l.binTU2.z*h),this.tmpav2.subEqual(this.tmp),this.tmp.sub(this.tmplv2,this.tmplv1),t=e,(e+=i=(M.dotVectors(this.tmp,l.nor)+M.dotVectors(this.tmpav2,l.norT2)-M.dotVectors(this.tmpav1,l.norT1)-l.norTar)*l.norDen)>0&&(e=0),i=e-t,this.tmplv1.addScaledVector(l.norU1,i),this.tmpav1.addScaledVector(l.norTU1,i),this.tmplv2.subScaledVector(l.norU2,i),this.tmpav2.subScaledVector(l.norTU2,i),l.norImp=e,l.tanImp=o,l.binImp=a,!l.last;)l=l.next;this.lv1.copy(this.tmplv1),this.lv2.copy(this.tmplv2),this.av1.copy(this.tmpav1),this.av2.copy(this.tmpav2)},postSolve:function(){for(var t,i=this.cs,s=this.num;s--;)(t=this.ps[s]).normal.copy(i.nor),t.tangent.copy(i.tan),t.binormal.copy(i.bin),t.normalImpulse=i.norImp,t.tangentImpulse=i.tanImp,t.binormalImpulse=i.binImp,t.normalDenominator=i.norDen,t.tangentDenominator=i.tanDen,t.binormalDenominator=i.binDen,i=i.next}}),Object.assign(Contact.prototype,{Contact:!0,mixRestitution:function(t,i){return M.sqrt(t*i)},mixFriction:function(t,i){return M.sqrt(t*i)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution),this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var t=this.manifold.numPoints,i=t;i--;){var s=this.buffer[i],h=this.points[i];s.lp1X=h.localPoint1.x,s.lp1Y=h.localPoint1.y,s.lp1Z=h.localPoint1.z,s.lp2X=h.localPoint2.x,s.lp2Y=h.localPoint2.y,s.lp2Z=h.localPoint2.z,s.impulse=h.normalImpulse}this.manifold.numPoints=0,this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var e=this.manifold.numPoints;if(0==e)return this.touching=!1,this.close=!1,void(this.dist=M.INF);for((this.touching||this.dist<.001)&&(this.close=!0),this.touching=!0,i=e;i--;){for(var o=(h=this.points[i]).localPoint1.x,a=h.localPoint1.y,n=h.localPoint1.z,r=h.localPoint2.x,l=h.localPoint2.y,c=h.localPoint2.z,m=-1,p=4e-4,u=t;u--;){var y=(s=this.buffer[u]).lp1X-o,x=s.lp1Y-a,d=s.lp1Z-n,f=y*y+x*x+d*d,b=(y=s.lp2X-r)*y+(x=s.lp2Y-l)*x+(d=s.lp2Z-c)*d;f<b?f<p&&(p=f,m=u):b<p&&(p=b,m=u),p<this.dist&&(this.dist=p)}if(-1!=m){var v=this.buffer[m];this.buffer[m]=this.buffer[--t],this.buffer[t]=v,h.normalImpulse=v.impulse,h.warmStarted=!0}else h.normalImpulse=0,h.warmStarted=!1}},attach:function(t,i){this.shape1=t,this.shape2=i,this.body1=t.parent,this.body2=i.parent,this.manifold.body1=this.body1,this.manifold.body2=this.body2,this.constraint.body1=this.body1,this.constraint.body2=this.body2,this.constraint.attach(),this.s1Link.shape=i,this.s1Link.body=this.body2,this.s2Link.shape=t,this.s2Link.body=this.body1,null!=t.contactLink?(this.s1Link.next=t.contactLink).prev=this.s1Link:this.s1Link.next=null,t.contactLink=this.s1Link,t.numContacts++,null!=i.contactLink?(this.s2Link.next=i.contactLink).prev=this.s2Link:this.s2Link.next=null,i.contactLink=this.s2Link,i.numContacts++,this.b1Link.shape=i,this.b1Link.body=this.body2,this.b2Link.shape=t,this.b2Link.body=this.body1,null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:this.b1Link.next=null,this.body1.contactLink=this.b1Link,this.body1.numContacts++,null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null,this.body2.contactLink=this.b2Link,this.body2.numContacts++,this.prev=null,this.next=null,this.persisting=!0,this.sleeping=this.body1.sleeping&&this.body2.sleeping,this.manifold.numPoints=0},detach:function(){var t=this.s1Link.prev,i=this.s1Link.next;null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape1.contactLink==this.s1Link&&(this.shape1.contactLink=i),this.s1Link.prev=null,this.s1Link.next=null,this.s1Link.shape=null,this.s1Link.body=null,this.shape1.numContacts--,t=this.s2Link.prev,i=this.s2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=i),this.s2Link.prev=null,this.s2Link.next=null,this.s2Link.shape=null,this.s2Link.body=null,this.shape2.numContacts--,t=this.b1Link.prev,i=this.b1Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body1.contactLink==this.b1Link&&(this.body1.contactLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.shape=null,this.b1Link.body=null,this.body1.numContacts--,t=this.b2Link.prev,i=this.b2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body2.contactLink==this.b2Link&&(this.body2.contactLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.shape=null,this.b2Link.body=null,this.body2.numContacts--,this.manifold.body1=null,this.manifold.body2=null,this.constraint.body1=null,this.constraint.body2=null,this.constraint.detach(),this.shape1=null,this.shape2=null,this.body1=null,this.body2=null}}),Object.assign(RigidBody.prototype,{setParent:function(t){this.parent=t,this.scale=this.parent.scale,this.invScale=this.parent.invScale,this.id=this.parent.numRigidBodies,this.name||(this.name=this.id),this.updateMesh()},addShape:function(t){t.parent&&printError("RigidBody","It is not possible that you add a shape which already has an associated body."),null!=this.shapes&&((this.shapes.prev=t).next=this.shapes),this.shapes=t,t.parent=this,this.parent&&this.parent.addShape(t),this.numShapes++},removeShape:function(t){var i=t;if(i.parent==this){var s=i.prev,h=i.next;null!=s&&(s.next=h),null!=h&&(h.prev=s),this.shapes==i&&(this.shapes=h),i.prev=null,i.next=null,i.parent=null,this.parent&&this.parent.removeShape(i),this.numShapes--}},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(t){this.parent.checkContact(this.name,t)},setupMass:function(t,i){var s=void 0===i||i;this.type=t||2,this.isDynamic=1===this.type,this.isStatic=2===this.type,this.mass=0,this.localInertia.set(0,0,0,0,0,0,0,0,0);for(var h=new Mat33,e=new Vec3,o=this.shapes;null!==o;o=o.next){o.calculateMassInfo(this.massInfo);var a=this.massInfo.mass;e.addScaledVector(o.relativePosition,a),this.mass+=a,this.rotateInertia(o.relativeRotation,this.massInfo.inertia,h),this.localInertia.add(h),this.localInertia.addOffset(a,o.relativePosition)}if(this.inverseMass=1/this.mass,e.scaleEqual(this.inverseMass),s){for(this.position.add(e),o=this.shapes;null!==o;o=o.next)o.relativePosition.subEqual(e);this.localInertia.subOffset(this.mass,e)}this.inverseLocalInertia.invert(this.localInertia),2===this.type&&(this.inverseMass=0,this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0)),this.syncShapes(),this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1,this.sleepTime=0;for(var t=this.contactLink;null!=t;)t.body.sleepTime=0,t.body.sleeping=!1,t=t.next;for(var i=this.jointLink;null!=i;)i.body.sleepTime=0,i.body.sleeping=!1,i=i.next;for(var s=this.shapes;null!=s;s=s.next)s.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0;for(var t=this.shapes;null!=t;t=t.next)t.updateProxy()}},testWakeUp:function(){(this.linearVelocity.testZero()||this.angularVelocity.testZero()||this.position.testDiff(this.sleepPosition)||this.orientation.testDiff(this.sleepOrientation))&&this.awake()},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(t){switch(this.type){case 2:this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1),this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case 1:this.isKinematic&&(this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0)),this.controlPos&&(this.linearVelocity.subVectors(this.newPosition,this.position).multiplyScalar(1/t),this.controlPos=!1),this.controlRot&&(this.angularVelocity.copy(this.getAxis()),this.orientation.copy(this.newOrientation),this.controlRot=!1),this.position.addScaledVector(this.linearVelocity,t),this.orientation.addTime(this.angularVelocity,t),this.updateMesh();break;default:printError("RigidBody","Invalid type.")}this.syncShapes(),this.updateMesh()},getAxis:function(){return new Vec3(0,1,0).applyMatrix3(this.inverseLocalInertia,!0).normalize()},rotateInertia:function(t,i,s){this.tmpInertia.multiplyMatrices(t,i),s.multiplyMatrices(this.tmpInertia,t,!0)},syncShapes:function(){this.rotation.setQuat(this.orientation),this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var t=this.shapes;null!=t;t=t.next)t.position.copy(t.relativePosition).applyMatrix3(this.rotation,!0).add(this.position),t.rotation.multiplyMatrices(this.rotation,t.relativeRotation),t.updateProxy()},applyImpulse:function(t,i){this.linearVelocity.addScaledVector(i,this.inverseMass);var s=(new Vec3).copy(t).sub(this.position).cross(i).applyMatrix3(this.inverseInertia,!0);this.angularVelocity.add(s)},setPosition:function(t){this.newPosition.copy(t).multiplyScalar(this.invScale),this.controlPos=!0,this.isKinematic||(this.isKinematic=!0)},setQuaternion:function(t){this.newOrientation.set(t.x,t.y,t.z,t.w),this.controlRot=!0,this.isKinematic||(this.isKinematic=!0)},setRotation:function(t){this.newOrientation=(new Quat).setFromEuler(t.x*M.degtorad,t.y*M.degtorad,t.z*M.degtorad),this.controlRot=!0},resetPosition:function(t,i,s){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.position.set(t,i,s).multiplyScalar(this.invScale),this.awake()},resetQuaternion:function(t){this.angularVelocity.set(0,0,0),this.orientation=new Quat(t.x,t.y,t.z,t.w),this.awake()},resetRotation:function(t,i,s){this.angularVelocity.set(0,0,0),this.orientation=(new Quat).setFromEuler(t*M.degtorad,i*M.degtorad,s*M.degtorad),this.awake()},getPosition:function(){return this.pos},getQuaternion:function(){return this.quaternion},connectMesh:function(t){this.mesh=t,this.updateMesh()},updateMesh:function(){this.pos.scale(this.position,this.scale),this.quaternion.copy(this.orientation),null!==this.mesh&&(this.mesh.position.copy(this.getPosition()),this.mesh.quaternion.copy(this.getQuaternion()))}}),Object.assign(BroadPhase.prototype,{BroadPhase:!0,createProxy:function(t){printError("BroadPhase","Inheritance error.")},addProxy:function(t){printError("BroadPhase","Inheritance error.")},removeProxy:function(t){printError("BroadPhase","Inheritance error.")},isAvailablePair:function(t,i){var s,h=t.parent,e=i.parent;if(h==e||!h.isDynamic&&!e.isDynamic||0==(t.belongsTo&i.collidesWith)||0==(i.belongsTo&t.collidesWith))return!1;for(s=h.numJoints<e.numJoints?h.jointLink:e.jointLink;null!==s;){var o=s.joint;if(!o.allowCollision&&(o.body1==h&&o.body2==e||o.body1==e&&o.body2==h))return!1;s=s.next}return!0},detectPairs:function(){this.pairs=[],this.numPairs=0,this.numPairChecks=0,this.collectPairs()},collectPairs:function(){},addPair:function(t,i){var s=new Pair(t,i);this.pairs.push(s),this.numPairs++}});var g=0;function Proxy(t){this.shape=t,this.aabb=t.aabb}function BasicProxy(t){Proxy.call(this,t),this.id=g++}function BruteForceBroadPhase(){BroadPhase.call(this),this.types=r,this.proxies=[]}function SAPAxis(){this.numElements=0,this.bufferSize=256,this.elements=[],this.elements.length=this.bufferSize,this.stack=new Float32Array(64)}function SAPElement(t,i){this.proxy=t,this.pair=null,this.min1=null,this.max1=null,this.min2=null,this.max2=null,this.max=i,this.value=0}function SAPProxy(t,i){Proxy.call(this,i),this.belongsTo=0,this.max=[],this.min=[],this.sap=t,this.min[0]=new SAPElement(this,!1),this.max[0]=new SAPElement(this,!0),this.min[1]=new SAPElement(this,!1),this.max[1]=new SAPElement(this,!0),this.min[2]=new SAPElement(this,!1),this.max[2]=new SAPElement(this,!0),this.max[0].pair=this.min[0],this.max[1].pair=this.min[1],this.max[2].pair=this.min[2],this.min[0].min1=this.min[1],this.min[0].max1=this.max[1],this.min[0].min2=this.min[2],this.min[0].max2=this.max[2],this.min[1].min1=this.min[0],this.min[1].max1=this.max[0],this.min[1].min2=this.min[2],this.min[1].max2=this.max[2],this.min[2].min1=this.min[0],this.min[2].max1=this.max[0],this.min[2].min2=this.min[1],this.min[2].max2=this.max[1]}function SAPBroadPhase(){BroadPhase.call(this),this.types=l,this.numElementsD=0,this.numElementsS=0,this.axesD=[new SAPAxis,new SAPAxis,new SAPAxis],this.axesS=[new SAPAxis,new SAPAxis,new SAPAxis],this.index1=0,this.index2=1}function DBVTNode(){this.child1=null,this.child2=null,this.parent=null,this.proxy=null,this.height=0,this.aabb=new AABB}function DBVT(){this.root=null,this.freeNodes=[],this.freeNodes.length=16384,this.numFreeNodes=0,this.aabb=new AABB}function DBVTProxy(t){Proxy.call(this,t),this.leaf=new DBVTNode,this.leaf.proxy=this}function DBVTBroadPhase(){BroadPhase.call(this),this.types=c,this.tree=new DBVT,this.stack=[],this.leaves=[],this.numLeaves=0}function CollisionDetector(){this.flip=!1}function BoxBoxCollisionDetector(){CollisionDetector.call(this),this.clipVertices1=new Float32Array(24),this.clipVertices2=new Float32Array(24),this.used=new Float32Array(8),this.INF=1/0}function BoxCylinderCollisionDetector(t){CollisionDetector.call(this),this.flip=t}function CylinderCylinderCollisionDetector(){CollisionDetector.call(this)}function SphereBoxCollisionDetector(t){CollisionDetector.call(this),this.flip=t}function SphereCylinderCollisionDetector(t){CollisionDetector.call(this),this.flip=t}function SphereSphereCollisionDetector(){CollisionDetector.call(this)}function SpherePlaneCollisionDetector(t){CollisionDetector.call(this),this.flip=t,this.n=new Vec3,this.p=new Vec3}function BoxPlaneCollisionDetector(t){CollisionDetector.call(this),this.flip=t,this.n=new Vec3,this.p=new Vec3,this.dix=new Vec3,this.diy=new Vec3,this.diz=new Vec3,this.cc=new Vec3,this.cc2=new Vec3}function World(t){switch(t instanceof Object||(t={}),this.scale=t.worldscale||1,this.invScale=1/this.scale,this.timeStep=t.timestep||.01666,this.timerate=1e3*this.timeStep,this.timer=null,this.preLoop=null,this.postLoop=null,this.numIterations=t.iterations||8,t.broadphase||2){case 1:this.broadPhase=new BruteForceBroadPhase;break;case 2:default:this.broadPhase=new SAPBroadPhase;break;case 3:this.broadPhase=new DBVTBroadPhase}this.Btypes=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"],this.broadPhaseType=this.Btypes[t.broadphase||2],this.performance=null,this.isStat=void 0!==t.info&&t.info,this.isStat&&(this.performance=new InfoDisplay(this)),this.enableRandomizer=void 0===t.random||t.random,this.rigidBodies=null,this.numRigidBodies=0,this.contacts=null,this.unusedContacts=null,this.numContacts=0,this.numContactPoints=0,this.joints=null,this.numJoints=0,this.numIslands=0,this.gravity=new Vec3(0,-9.8,0),void 0!==t.gravity&&this.gravity.fromArray(t.gravity);this.detectors=[],this.detectors.length=5;for(var i=5;i--;)this.detectors[i]=[],this.detectors[i].length=5;this.detectors[u][u]=new SphereSphereCollisionDetector,this.detectors[u][y]=new SphereBoxCollisionDetector(!1),this.detectors[y][u]=new SphereBoxCollisionDetector(!0),this.detectors[y][y]=new BoxBoxCollisionDetector,this.detectors[x][x]=new CylinderCylinderCollisionDetector,this.detectors[x][y]=new BoxCylinderCollisionDetector(!0),this.detectors[y][x]=new BoxCylinderCollisionDetector(!1),this.detectors[x][u]=new SphereCylinderCollisionDetector(!0),this.detectors[u][x]=new SphereCylinderCollisionDetector(!1),this.detectors[d][u]=new SpherePlaneCollisionDetector(!0),this.detectors[u][d]=new SpherePlaneCollisionDetector(!1),this.detectors[d][y]=new BoxPlaneCollisionDetector(!0),this.detectors[y][d]=new BoxPlaneCollisionDetector(!1),this.randX=65535,this.randA=98765,this.randB=123456789,this.islandRigidBodies=[],this.islandStack=[],this.islandConstraints=[]}Object.assign(Proxy.prototype,{Proxy:!0,update:function(){printError("Proxy","Inheritance error.")}}),BasicProxy.prototype=Object.assign(Object.create(Proxy.prototype),{constructor:BasicProxy,update:function(){}}),BruteForceBroadPhase.prototype=Object.assign(Object.create(BroadPhase.prototype),{constructor:BruteForceBroadPhase,createProxy:function(t){return new BasicProxy(t)},addProxy:function(t){this.proxies.push(t)},removeProxy:function(t){var i=this.proxies.indexOf(t);i>-1&&this.proxies.splice(i,1)},collectPairs:function(){var t,i,s,h=0,e=this.proxies,o=e.length;for(this.numPairChecks=o*(o-1)>>1;h<o;)for(i=e[h++],t=h+1;t<o;)s=e[t++],!i.aabb.intersectTest(s.aabb)&&this.isAvailablePair(i.shape,s.shape)&&this.addPair(i.shape,s.shape)}}),Object.assign(SAPAxis.prototype,{SAPAxis:!0,addElements:function(t,i){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var s=[],h=this.numElements;h--;)s[h]=this.elements[h]}this.elements[this.numElements++]=t,this.elements[this.numElements++]=i},removeElements:function(t,i){for(var s=-1,h=-1,e=0,o=this.numElements;e<o;e++){var a=this.elements[e];if(a==t||a==i){if(-1!=s){h=e;break}s=e}}for(e=s+1,o=h;e<o;e++)this.elements[e-1]=this.elements[e];for(e=h+1,o=this.numElements;e<o;e++)this.elements[e-2]=this.elements[e];this.elements[--this.numElements]=null,this.elements[--this.numElements]=null},sort:function(){for(var t=0,i=1;this.numElements>>i!=0;)i++;i=i*this.numElements>>2,t=0;for(var s=!1,h=this.elements,e=1,o=this.numElements;e<o;e++){var a=h[e],n=a.value,r=h[e-1];if(r.value>n){var l=e;do{if(h[l]=r,0==--l)break;r=h[l-1]}while(r.value>n);if(h[l]=a,(t+=e-l)>i){s=!0;break}}}if(s){t=2;var c=this.stack;for(c[0]=0,c[1]=this.numElements-1;t>0;){var m=c[--t],p=c[--t],u=m-p;if(u>16){var y=p+M.floor(.5*u);for(a=h[y],h[y]=h[m],h[m]=a,n=a.value,e=p-1,l=m;;){var x,d;do{x=h[++e]}while(x.value<n);do{d=h[--l]}while(n<d.value&&l!=p);if(e>=l)break;h[e]=d,h[l]=x}h[m]=h[e],h[e]=a,e-p>m-e?(c[t++]=p,c[t++]=e-1,c[t++]=e+1,c[t++]=m):(c[t++]=e+1,c[t++]=m,c[t++]=p,c[t++]=e-1)}else for(e=p+1;e<=m;e++)if(n=(a=h[e]).value,(r=h[e-1]).value>n){l=e;do{if(h[l]=r,0==--l)break;r=h[l-1]}while(r.value>n);h[l]=a}}}},calculateTestCount:function(){for(var t=1,i=0,s=1,h=this.numElements;s<h;s++)this.elements[s].max?t--:(i+=t,t++);return i}}),SAPProxy.prototype=Object.assign(Object.create(Proxy.prototype),{constructor:SAPProxy,isDynamic:function(){var t=this.shape.parent;return t.isDynamic&&!t.sleeping},update:function(){var t=this.aabb.elements;this.min[0].value=t[0],this.min[1].value=t[1],this.min[2].value=t[2],this.max[0].value=t[3],this.max[1].value=t[4],this.max[2].value=t[5],(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())&&(this.sap.removeProxy(this),this.sap.addProxy(this))}}),SAPBroadPhase.prototype=Object.assign(Object.create(BroadPhase.prototype),{constructor:SAPBroadPhase,createProxy:function(t){return new SAPProxy(this,t)},addProxy:function(t){var i=t;i.isDynamic()?(this.axesD[0].addElements(i.min[0],i.max[0]),this.axesD[1].addElements(i.min[1],i.max[1]),this.axesD[2].addElements(i.min[2],i.max[2]),i.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(i.min[0],i.max[0]),this.axesS[1].addElements(i.min[1],i.max[1]),this.axesS[2].addElements(i.min[2],i.max[2]),i.belongsTo=2,this.numElementsS+=2)},removeProxy:function(t){var i=t;if(0!=i.belongsTo){switch(i.belongsTo){case 1:this.axesD[0].removeElements(i.min[0],i.max[0]),this.axesD[1].removeElements(i.min[1],i.max[1]),this.axesD[2].removeElements(i.min[2],i.max[2]),this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(i.min[0],i.max[0]),this.axesS[1].removeElements(i.min[1],i.max[1]),this.axesS[2].removeElements(i.min[2],i.max[2]),this.numElementsS-=2}i.belongsTo=0}},collectPairs:function(){if(0!=this.numElementsD){var t,i,s,h,e=this.axesD[this.index1],o=this.axesD[this.index2];e.sort(),o.sort(),e.calculateTestCount()<=o.calculateTestCount()?((o=this.axesS[this.index1]).sort(),t=e.elements,i=o.elements):((e=this.axesS[this.index2]).sort(),t=o.elements,i=e.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var a=0,n=0;a<this.numElementsD;){var r,l;if(n==this.numElementsS)r=t[a],l=!0,a++;else{var c=t[a],m=i[n];c.value<m.value?(r=c,l=!0,a++):(r=m,l=!1,n++)}if(r.max){var p=r.pair;if(l){if(p==s){s=s.pair;continue}r=s}else{if(p==h){h=h.pair;continue}r=h}for(;r;){if((b=r.pair)==p){r.pair=b.pair;break}r=b}}else{for(var u=r.proxy.shape,y=r.min1.value,x=r.max1.value,d=r.min2.value,f=r.max2.value,b=s;null!=b;b=b.pair){var v=b.proxy.shape;this.numPairChecks++,y>b.max1.value||x<b.min1.value||d>b.max2.value||f<b.min2.value||!this.isAvailablePair(u,v)||this.addPair(u,v)}if(l){for(b=h;null!=b;b=b.pair)v=b.proxy.shape,this.numPairChecks++,y>b.max1.value||x<b.min1.value||d>b.max2.value||f<b.min2.value||!this.isAvailablePair(u,v)||this.addPair(u,v);r.pair=s,s=r}else r.pair=h,h=r}}this.index2=3^(this.index1|this.index2)}}}),Object.assign(DBVT.prototype,{DBVT:!0,moveLeaf:function(t){this.deleteLeaf(t),this.insertLeaf(t)},insertLeaf:function(t){if(null!=this.root){for(var i,s,h=t.aabb,e=this.root;null==e.proxy;){var o=e.child1,a=e.child2,n=e.aabb,r=o.aabb,l=a.aabb;i=n.surfaceArea(),this.aabb.combine(h,n);var c=2*(s=this.aabb.surfaceArea()),m=2*(s-i),p=m;this.aabb.combine(h,r),null!=o.proxy?p+=this.aabb.surfaceArea():p+=this.aabb.surfaceArea()-r.surfaceArea();var u=m;if(this.aabb.combine(h,l),null!=a.proxy?u+=this.aabb.surfaceArea():u+=this.aabb.surfaceArea()-l.surfaceArea(),p<u){if(c<p)break;e=o}else{if(c<u)break;e=a}}var y,x=e.parent;(y=this.numFreeNodes>0?this.freeNodes[--this.numFreeNodes]:new DBVTNode).parent=x,y.child1=t,y.child2=e,y.aabb.combine(t.aabb,e.aabb),y.height=e.height+1,e.parent=y,t.parent=y,e==this.root?this.root=y:x.child1==e?x.child1=y:x.child2=y;do{y=this.balance(y),this.fix(y),y=y.parent}while(null!=y)}else this.root=t},getBalance:function(t){return null!=t.proxy?0:t.child1.height-t.child2.height},deleteLeaf:function(t){if(t!=this.root){var i,s=t.parent;if(i=s.child1==t?s.child2:s.child1,s==this.root)return this.root=i,void(i.parent=null);var h=s.parent;i.parent=h,h.child1==s?h.child1=i:h.child2=i,this.numFreeNodes<16384&&(this.freeNodes[this.numFreeNodes++]=s);do{h=this.balance(h),this.fix(h),h=h.parent}while(null!=h)}else this.root=null},balance:function(t){var i=t.height;if(i<2)return t;var s,h=t.parent,e=t.child1,o=t.child2,a=e.height,n=o.height,r=a-n;if(r>1){var l=e.child1,c=e.child2,m=l.height,p=c.height;return m>p?(e.child2=t,t.parent=e,t.child1=c,c.parent=t,t.aabb.combine(c.aabb,o.aabb),s=p-n,t.height=p-(s&s>>31)+1,e.aabb.combine(l.aabb,t.aabb),s=m-i,e.height=m-(s&s>>31)+1):(e.child1=t,t.parent=e,t.child1=l,l.parent=t,t.aabb.combine(l.aabb,o.aabb),s=m-n,t.height=m-(s&s>>31)+1,e.aabb.combine(t.aabb,c.aabb),s=i-p,e.height=i-(s&s>>31)+1),null!=h?h.child1==t?h.child1=e:h.child2=e:this.root=e,e.parent=h,e}if(r<-1){var u=o.child1,y=o.child2,x=u.height,d=y.height;return x>d?(o.child2=t,t.parent=o,t.child2=y,y.parent=t,t.aabb.combine(e.aabb,y.aabb),s=a-d,t.height=a-(s&s>>31)+1,o.aabb.combine(u.aabb,t.aabb),s=x-i,o.height=x-(s&s>>31)+1):(o.child1=t,t.parent=o,t.child2=u,u.parent=t,t.aabb.combine(e.aabb,u.aabb),s=a-x,t.height=a-(s&s>>31)+1,o.aabb.combine(t.aabb,y.aabb),s=i-d,o.height=i-(s&s>>31)+1),null!=h?h.child1==t?h.child1=o:h.child2=o:this.root=o,o.parent=h,o}return t},fix:function(t){var i=t.child1,s=t.child2;t.aabb.combine(i.aabb,s.aabb),t.height=i.height<s.height?s.height+1:i.height+1}}),DBVTProxy.prototype=Object.assign(Object.create(Proxy.prototype),{constructor:DBVTProxy,update:function(){}}),DBVTBroadPhase.prototype=Object.assign(Object.create(BroadPhase.prototype),{constructor:DBVTBroadPhase,createProxy:function(t){return new DBVTProxy(t)},addProxy:function(t){this.tree.insertLeaf(t.leaf),this.leaves.push(t.leaf),this.numLeaves++},removeProxy:function(t){this.tree.deleteLeaf(t.leaf);var i=this.leaves.indexOf(t.leaf);i>-1&&(this.leaves.splice(i,1),this.numLeaves--)},collectPairs:function(){if(!(this.numLeaves<2))for(var t,i=this.numLeaves;i--;)(t=this.leaves[i]).proxy.aabb.intersectTestTwo(t.aabb)&&(t.aabb.copy(t.proxy.aabb,.1),this.tree.deleteLeaf(t),this.tree.insertLeaf(t),this.collide(t,this.tree.root))},collide:function(t,i){var s,h,e,o,a,n,r=2;for(this.stack[0]=t,this.stack[1]=i;r>0;)if(e=this.stack[--r],o=this.stack[--r],a=null!=e.proxy,n=null!=o.proxy,this.numPairChecks++,a&&n){if((s=e.proxy.shape)==(h=o.proxy.shape)||s.aabb.intersectTest(h.aabb)||!this.isAvailablePair(s,h))continue;this.addPair(s,h)}else{if(e.aabb.intersectTest(o.aabb))continue;n||!a&&e.aabb.surfaceArea()>o.aabb.surfaceArea()?(this.stack[r++]=e.child1,this.stack[r++]=o,this.stack[r++]=e.child2,this.stack[r++]=o):(this.stack[r++]=e,this.stack[r++]=o.child1,this.stack[r++]=e,this.stack[r++]=o.child2)}}}),Object.assign(CollisionDetector.prototype,{CollisionDetector:!0,detectCollision:function(t,i,s){printError("CollisionDetector","Inheritance error.")}}),BoxBoxCollisionDetector.prototype=Object.assign(Object.create(CollisionDetector.prototype),{constructor:BoxBoxCollisionDetector,detectCollision:function(t,i,s){var h,e;t.id<i.id?(h=t,e=i):(h=i,e=t);var o,a,n,r,l,c,m,p,u,y,x,d,f,b,v,z,N,k,V,w,P,g,S,I,L,C,T,A,D,B,j,O,E,F,R,q=h.elements,J=e.elements,U=h.dimentions,_=e.dimentions,W=h.position,H=e.position,Q=W.x,X=W.y,Y=W.z,Z=H.x,K=H.y,G=H.z,$=Z-Q,tt=K-X,it=G-Y,st=h.halfWidth,ht=h.halfHeight,et=h.halfDepth,ot=e.halfWidth,at=e.halfHeight,nt=e.halfDepth,rt=U[0],lt=U[1],ct=U[2],mt=U[3],pt=U[4],ut=U[5],yt=U[6],xt=U[7],dt=U[8],ft=U[9],bt=U[10],vt=U[11],zt=U[12],Nt=U[13],kt=U[14],Vt=U[15],wt=U[16],Mt=U[17],Pt=_[0],gt=_[1],St=_[2],It=_[3],Lt=_[4],Ct=_[5],Tt=_[6],At=_[7],Dt=_[8],Bt=_[9],jt=_[10],Ot=_[11],Et=_[12],Ft=_[13],Rt=_[14],qt=_[15],Jt=_[16],Ut=_[17],_t=lt*St-ct*gt,Wt=ct*Pt-rt*St,Ht=rt*gt-lt*Pt,Qt=lt*Ct-ct*Lt,Xt=ct*It-rt*Ct,Yt=rt*Lt-lt*It,Zt=lt*Dt-ct*At,Kt=ct*Tt-rt*Dt,Gt=rt*At-lt*Tt,$t=pt*St-ut*gt,ti=ut*Pt-mt*St,ii=mt*gt-pt*Pt,si=pt*Ct-ut*Lt,hi=ut*It-mt*Ct,ei=mt*Lt-pt*It,oi=pt*Dt-ut*At,ai=ut*Tt-mt*Dt,ni=mt*At-pt*Tt,ri=xt*St-dt*gt,li=dt*Pt-yt*St,ci=yt*gt-xt*Pt,mi=xt*Ct-dt*Lt,pi=dt*It-yt*Ct,ui=yt*Lt-xt*It,yi=xt*Dt-dt*At,xi=dt*Tt-yt*Dt,di=yt*At-xt*Tt,fi=!1,bi=!1,vi=!1,zi=!1,Ni=!1,ki=!1,Vi=!1,wi=!1,Mi=!1;if((o=(j=rt*$+lt*tt+ct*it)>0)||(j=-j),(E=rt*Pt+lt*gt+ct*St)<0&&(E=-E),(F=rt*It+lt*Lt+ct*Ct)<0&&(F=-F),(R=rt*Tt+lt*At+ct*Dt)<0&&(R=-R),!((z=j-(O=st)-(E*ot+F*at+R*nt))>0||((a=(j=mt*$+pt*tt+ut*it)>0)||(j=-j),(E=mt*Pt+pt*gt+ut*St)<0&&(E=-E),(F=mt*It+pt*Lt+ut*Ct)<0&&(F=-F),(R=mt*Tt+pt*At+ut*Dt)<0&&(R=-R),(N=j-(O=ht)-(E*ot+F*at+R*nt))>0||((n=(j=yt*$+xt*tt+dt*it)>0)||(j=-j),(E=yt*Pt+xt*gt+dt*St)<0&&(E=-E),(F=yt*It+xt*Lt+dt*Ct)<0&&(F=-F),(R=yt*Tt+xt*At+dt*Dt)<0&&(R=-R),(k=j-(O=et)-(E*ot+F*at+R*nt))>0||((r=(j=Pt*$+gt*tt+St*it)>0)||(j=-j),(E=Pt*rt+gt*lt+St*ct)<0&&(E=-E),(F=Pt*mt+gt*pt+St*ut)<0&&(F=-F),(R=Pt*yt+gt*xt+St*dt)<0&&(R=-R),(V=1*(j-(O=E*st+F*ht+R*et)-ot))>0||((l=(j=It*$+Lt*tt+Ct*it)>0)||(j=-j),(E=It*rt+Lt*lt+Ct*ct)<0&&(E=-E),(F=It*mt+Lt*pt+Ct*ut)<0&&(F=-F),(R=It*yt+Lt*xt+Ct*dt)<0&&(R=-R),(w=1*(j-(O=E*st+F*ht+R*et)-at))>0||((c=(j=Tt*$+At*tt+Dt*it)>0)||(j=-j),(E=Tt*rt+At*lt+Dt*ct)<0&&(E=-E),(F=Tt*mt+At*pt+Dt*ut)<0&&(F=-F),(R=Tt*yt+At*xt+Dt*dt)<0&&(R=-R),(P=1*(j-(O=E*st+F*ht+R*et)-nt))>0))))))){if((j=_t*_t+Wt*Wt+Ht*Ht)>1e-5){if((m=(j=(_t*=j=1/M.sqrt(j))*$+(Wt*=j)*tt+(Ht*=j)*it)>0)||(j=-j),(E=_t*mt+Wt*pt+Ht*ut)<0&&(E=-E),(F=_t*yt+Wt*xt+Ht*dt)<0&&(F=-F),O=E*ht+F*et,(E=_t*It+Wt*Lt+Ht*Ct)<0&&(E=-E),(F=_t*Tt+Wt*At+Ht*Dt)<0&&(F=-F),(g=j-O-(E*at+F*nt))>0)return}else m=!1,g=0,fi=!0;if((j=Qt*Qt+Xt*Xt+Yt*Yt)>1e-5){if((p=(j=(Qt*=j=1/M.sqrt(j))*$+(Xt*=j)*tt+(Yt*=j)*it)>0)||(j=-j),(E=Qt*mt+Xt*pt+Yt*ut)<0&&(E=-E),(F=Qt*yt+Xt*xt+Yt*dt)<0&&(F=-F),O=E*ht+F*et,(E=Qt*Pt+Xt*gt+Yt*St)<0&&(E=-E),(F=Qt*Tt+Xt*At+Yt*Dt)<0&&(F=-F),(S=j-O-(E*ot+F*nt))>0)return}else p=!1,S=0,bi=!0;if((j=Zt*Zt+Kt*Kt+Gt*Gt)>1e-5){if((u=(j=(Zt*=j=1/M.sqrt(j))*$+(Kt*=j)*tt+(Gt*=j)*it)>0)||(j=-j),(E=Zt*mt+Kt*pt+Gt*ut)<0&&(E=-E),(F=Zt*yt+Kt*xt+Gt*dt)<0&&(F=-F),O=E*ht+F*et,(E=Zt*Pt+Kt*gt+Gt*St)<0&&(E=-E),(F=Zt*It+Kt*Lt+Gt*Ct)<0&&(F=-F),(I=j-O-(E*ot+F*at))>0)return}else u=!1,I=0,vi=!0;if((j=$t*$t+ti*ti+ii*ii)>1e-5){if((y=(j=($t*=j=1/M.sqrt(j))*$+(ti*=j)*tt+(ii*=j)*it)>0)||(j=-j),(E=$t*rt+ti*lt+ii*ct)<0&&(E=-E),(F=$t*yt+ti*xt+ii*dt)<0&&(F=-F),O=E*st+F*et,(E=$t*It+ti*Lt+ii*Ct)<0&&(E=-E),(F=$t*Tt+ti*At+ii*Dt)<0&&(F=-F),(L=j-O-(E*at+F*nt))>0)return}else y=!1,L=0,zi=!0;if((j=si*si+hi*hi+ei*ei)>1e-5){if((x=(j=(si*=j=1/M.sqrt(j))*$+(hi*=j)*tt+(ei*=j)*it)>0)||(j=-j),(E=si*rt+hi*lt+ei*ct)<0&&(E=-E),(F=si*yt+hi*xt+ei*dt)<0&&(F=-F),O=E*st+F*et,(E=si*Pt+hi*gt+ei*St)<0&&(E=-E),(F=si*Tt+hi*At+ei*Dt)<0&&(F=-F),(C=j-O-(E*ot+F*nt))>0)return}else x=!1,C=0,Ni=!0;if((j=oi*oi+ai*ai+ni*ni)>1e-5){if((d=(j=(oi*=j=1/M.sqrt(j))*$+(ai*=j)*tt+(ni*=j)*it)>0)||(j=-j),(E=oi*rt+ai*lt+ni*ct)<0&&(E=-E),(F=oi*yt+ai*xt+ni*dt)<0&&(F=-F),O=E*st+F*et,(E=oi*Pt+ai*gt+ni*St)<0&&(E=-E),(F=oi*It+ai*Lt+ni*Ct)<0&&(F=-F),(T=j-O-(E*ot+F*at))>0)return}else d=!1,T=0,ki=!0;if((j=ri*ri+li*li+ci*ci)>1e-5){if((f=(j=(ri*=j=1/M.sqrt(j))*$+(li*=j)*tt+(ci*=j)*it)>0)||(j=-j),(E=ri*rt+li*lt+ci*ct)<0&&(E=-E),(F=ri*mt+li*pt+ci*ut)<0&&(F=-F),O=E*st+F*ht,(E=ri*It+li*Lt+ci*Ct)<0&&(E=-E),(F=ri*Tt+li*At+ci*Dt)<0&&(F=-F),(A=j-O-(E*at+F*nt))>0)return}else f=!1,A=0,Vi=!0;if((j=mi*mi+pi*pi+ui*ui)>1e-5){if((b=(j=(mi*=j=1/M.sqrt(j))*$+(pi*=j)*tt+(ui*=j)*it)>0)||(j=-j),(E=mi*rt+pi*lt+ui*ct)<0&&(E=-E),(F=mi*mt+pi*pt+ui*ut)<0&&(F=-F),O=E*st+F*ht,(E=mi*Pt+pi*gt+ui*St)<0&&(E=-E),(F=mi*Tt+pi*At+ui*Dt)<0&&(F=-F),(D=j-O-(E*ot+F*nt))>0)return}else b=!1,D=0,wi=!0;if((j=yi*yi+xi*xi+di*di)>1e-5){if((v=(j=(yi*=j=1/M.sqrt(j))*$+(xi*=j)*tt+(di*=j)*it)>0)||(j=-j),(E=yi*rt+xi*lt+di*ct)<0&&(E=-E),(F=yi*mt+xi*pt+di*ut)<0&&(F=-F),O=E*st+F*ht,(E=yi*Pt+xi*gt+di*St)<0&&(E=-E),(F=yi*It+xi*Lt+di*Ct)<0&&(F=-F),(B=j-O-(E*ot+F*at))>0)return}else v=!1,B=0,Mi=!0;var Pi=z,gi=z,Si=0,Ii=o;N>gi&&(Pi=N,gi=N,Si=1,Ii=a),k>gi&&(Pi=k,gi=k,Si=2,Ii=n),V>gi&&(Pi=V,gi=V,Si=3,Ii=r),w>gi&&(Pi=w,gi=w,Si=4,Ii=l),P>gi&&(Pi=P,gi=P,Si=5,Ii=c),g-.01>gi&&!fi&&(Pi=g,gi=g-.01,Si=6,Ii=m),S-.01>gi&&!bi&&(Pi=S,gi=S-.01,Si=7,Ii=p),I-.01>gi&&!vi&&(Pi=I,gi=I-.01,Si=8,Ii=u),L-.01>gi&&!zi&&(Pi=L,gi=L-.01,Si=9,Ii=y),C-.01>gi&&!Ni&&(Pi=C,gi=C-.01,Si=10,Ii=x),T-.01>gi&&!ki&&(Pi=T,gi=T-.01,Si=11,Ii=d),A-.01>gi&&!Vi&&(Pi=A,gi=A-.01,Si=12,Ii=f),D-.01>gi&&!wi&&(Pi=D,gi=D-.01,Si=13,Ii=b),B-.01>gi&&!Mi&&(Pi=B,Si=14,Ii=v);var Li=0,Ci=0,Ti=0,Ai=0,Di=0,Bi=0,ji=0,Oi=0,Ei=0,Fi=0,Ri=0,qi=0,Ji=0,Ui=0,_i=0,Wi=0,Hi=0,Qi=0,Xi=!1;if(0==Si?(Ii?(Fi=Q+ft,Ri=X+bt,qi=Y+vt,Li=rt,Ci=lt,Ti=ct):(Fi=Q-ft,Ri=X-bt,qi=Y-vt,Li=-rt,Ci=-lt,Ti=-ct),Ji=zt,Ui=Nt,_i=kt,Ai=-mt,Di=-pt,Bi=-ut,Wi=Vt,Hi=wt,Qi=Mt,ji=-yt,Oi=-xt,Ei=-dt):1==Si?(Ii?(Fi=Q+zt,Ri=X+Nt,qi=Y+kt,Li=mt,Ci=pt,Ti=ut):(Fi=Q-zt,Ri=X-Nt,qi=Y-kt,Li=-mt,Ci=-pt,Ti=-ut),Ji=ft,Ui=bt,_i=vt,Ai=-rt,Di=-lt,Bi=-ct,Wi=Vt,Hi=wt,Qi=Mt,ji=-yt,Oi=-xt,Ei=-dt):2==Si?(Ii?(Fi=Q+Vt,Ri=X+wt,qi=Y+Mt,Li=yt,Ci=xt,Ti=dt):(Fi=Q-Vt,Ri=X-wt,qi=Y-Mt,Li=-yt,Ci=-xt,Ti=-dt),Ji=ft,Ui=bt,_i=vt,Ai=-rt,Di=-lt,Bi=-ct,Wi=zt,Hi=Nt,Qi=kt,ji=-mt,Oi=-pt,Ei=-ut):3==Si?(Xi=!0,Ii?(Fi=Z-Bt,Ri=K-jt,qi=G-Ot,Li=-Pt,Ci=-gt,Ti=-St):(Fi=Z+Bt,Ri=K+jt,qi=G+Ot,Li=Pt,Ci=gt,Ti=St),Ji=Et,Ui=Ft,_i=Rt,Ai=-It,Di=-Lt,Bi=-Ct,Wi=qt,Hi=Jt,Qi=Ut,ji=-Tt,Oi=-At,Ei=-Dt):4==Si?(Xi=!0,Ii?(Fi=Z-Et,Ri=K-Ft,qi=G-Rt,Li=-It,Ci=-Lt,Ti=-Ct):(Fi=Z+Et,Ri=K+Ft,qi=G+Rt,Li=It,Ci=Lt,Ti=Ct),Ji=Bt,Ui=jt,_i=Ot,Ai=-Pt,Di=-gt,Bi=-St,Wi=qt,Hi=Jt,Qi=Ut,ji=-Tt,Oi=-At,Ei=-Dt):5==Si?(Xi=!0,Ii?(Fi=Z-qt,Ri=K-Jt,qi=G-Ut,Li=-Tt,Ci=-At,Ti=-Dt):(Fi=Z+qt,Ri=K+Jt,qi=G+Ut,Li=Tt,Ci=At,Ti=Dt),Ji=Bt,Ui=jt,_i=Ot,Ai=-Pt,Di=-gt,Bi=-St,Wi=Et,Hi=Ft,Qi=Rt,ji=-It,Oi=-Lt,Ei=-Ct):6==Si?(Li=_t,Ci=Wt,Ti=Ht,Ai=rt,Di=lt,Bi=ct,ji=Pt,Oi=gt,Ei=St):7==Si?(Li=Qt,Ci=Xt,Ti=Yt,Ai=rt,Di=lt,Bi=ct,ji=It,Oi=Lt,Ei=Ct):8==Si?(Li=Zt,Ci=Kt,Ti=Gt,Ai=rt,Di=lt,Bi=ct,ji=Tt,Oi=At,Ei=Dt):9==Si?(Li=$t,Ci=ti,Ti=ii,Ai=mt,Di=pt,Bi=ut,ji=Pt,Oi=gt,Ei=St):10==Si?(Li=si,Ci=hi,Ti=ei,Ai=mt,Di=pt,Bi=ut,ji=It,Oi=Lt,Ei=Ct):11==Si?(Li=oi,Ci=ai,Ti=ni,Ai=mt,Di=pt,Bi=ut,ji=Tt,Oi=At,Ei=Dt):12==Si?(Li=ri,Ci=li,Ti=ci,Ai=yt,Di=xt,Bi=dt,ji=Pt,Oi=gt,Ei=St):13==Si?(Li=mi,Ci=pi,Ti=ui,Ai=yt,Di=xt,Bi=dt,ji=It,Oi=Lt,Ei=Ct):14==Si&&(Li=yi,Ci=xi,Ti=di,Ai=yt,Di=xt,Bi=dt,ji=Tt,Oi=At,Ei=Dt),Si>5){var Yi,Zi,Ki,Gi,$i,ts,is,ss,hs,es,os;Ii||(Li=-Li,Ci=-Ci,Ti=-Ti),Zi=Li*(ts=q[0])+Ci*(is=q[1])+Ti*(ss=q[2]),(Yi=Li*(Ki=q[3])+Ci*(Gi=q[4])+Ti*($i=q[5]))>Zi&&(Zi=Yi,ts=Ki,is=Gi,ss=$i),(Yi=Li*(Ki=q[6])+Ci*(Gi=q[7])+Ti*($i=q[8]))>Zi&&(Zi=Yi,ts=Ki,is=Gi,ss=$i),(Yi=Li*(Ki=q[9])+Ci*(Gi=q[10])+Ti*($i=q[11]))>Zi&&(Zi=Yi,ts=Ki,is=Gi,ss=$i),(Yi=Li*(Ki=q[12])+Ci*(Gi=q[13])+Ti*($i=q[14]))>Zi&&(Zi=Yi,ts=Ki,is=Gi,ss=$i),(Yi=Li*(Ki=q[15])+Ci*(Gi=q[16])+Ti*($i=q[17]))>Zi&&(Zi=Yi,ts=Ki,is=Gi,ss=$i),(Yi=Li*(Ki=q[18])+Ci*(Gi=q[19])+Ti*($i=q[20]))>Zi&&(Zi=Yi,ts=Ki,is=Gi,ss=$i),(Yi=Li*(Ki=q[21])+Ci*(Gi=q[22])+Ti*($i=q[23]))>Zi&&(Zi=Yi,ts=Ki,is=Gi,ss=$i),Zi=Li*(hs=J[0])+Ci*(es=J[1])+Ti*(os=J[2]),(Yi=Li*(Ki=J[3])+Ci*(Gi=J[4])+Ti*($i=J[5]))<Zi&&(Zi=Yi,hs=Ki,es=Gi,os=$i),(Yi=Li*(Ki=J[6])+Ci*(Gi=J[7])+Ti*($i=J[8]))<Zi&&(Zi=Yi,hs=Ki,es=Gi,os=$i),(Yi=Li*(Ki=J[9])+Ci*(Gi=J[10])+Ti*($i=J[11]))<Zi&&(Zi=Yi,hs=Ki,es=Gi,os=$i),(Yi=Li*(Ki=J[12])+Ci*(Gi=J[13])+Ti*($i=J[14]))<Zi&&(Zi=Yi,hs=Ki,es=Gi,os=$i),(Yi=Li*(Ki=J[15])+Ci*(Gi=J[16])+Ti*($i=J[17]))<Zi&&(Zi=Yi,hs=Ki,es=Gi,os=$i),(Yi=Li*(Ki=J[18])+Ci*(Gi=J[19])+Ti*($i=J[20]))<Zi&&(Zi=Yi,hs=Ki,es=Gi,os=$i),(Yi=Li*(Ki=J[21])+Ci*(Gi=J[22])+Ti*($i=J[23]))<Zi&&(Zi=Yi,hs=Ki,es=Gi,os=$i);var as=((Ki=hs-ts)*(Ai-ji*(E=Ai*ji+Di*Oi+Bi*Ei))+(Gi=es-is)*(Di-Oi*E)+($i=os-ss)*(Bi-Ei*E))/(1-E*E);s.addPoint(ts+Ai*as+Li*Pi*.5,is+Di*as+Ci*Pi*.5,ss+Bi*as+Ti*Pi*.5,Li,Ci,Ti,Pi,!1)}else{var ns,rs,ls,cs,ms,ps,us,ys,xs,ds,fs,bs,vs,zs,Ns,ks,Vs,ws,Ms,Ps,gs,Ss=1,Is=0,Ls=0;Xi?((Is=rt*Li+lt*Ci+ct*Ti)<Ss&&(Ss=Is,Ls=0),-Is<Ss&&(Ss=-Is,Ls=1),(Is=mt*Li+pt*Ci+ut*Ti)<Ss&&(Ss=Is,Ls=2),-Is<Ss&&(Ss=-Is,Ls=3),(Is=yt*Li+xt*Ci+dt*Ti)<Ss&&(Ss=Is,Ls=4),-Is<Ss&&(Ss=-Is,Ls=5),0==Ls?(ns=q[0],rs=q[1],ls=q[2],cs=q[6],ms=q[7],ps=q[8],us=q[9],ys=q[10],xs=q[11],ds=q[3],fs=q[4],bs=q[5]):1==Ls?(ns=q[15],rs=q[16],ls=q[17],cs=q[21],ms=q[22],ps=q[23],us=q[18],ys=q[19],xs=q[20],ds=q[12],fs=q[13],bs=q[14]):2==Ls?(ns=q[12],rs=q[13],ls=q[14],cs=q[0],ms=q[1],ps=q[2],us=q[3],ys=q[4],xs=q[5],ds=q[15],fs=q[16],bs=q[17]):3==Ls?(ns=q[21],rs=q[22],ls=q[23],cs=q[9],ms=q[10],ps=q[11],us=q[6],ys=q[7],xs=q[8],ds=q[18],fs=q[19],bs=q[20]):4==Ls?(ns=q[12],rs=q[13],ls=q[14],cs=q[18],ms=q[19],ps=q[20],us=q[6],ys=q[7],xs=q[8],ds=q[0],fs=q[1],bs=q[2]):5==Ls&&(ns=q[3],rs=q[4],ls=q[5],cs=J[9],ms=J[10],ps=J[11],us=q[21],ys=q[22],xs=q[23],ds=q[15],fs=q[16],bs=q[17])):((Is=Pt*Li+gt*Ci+St*Ti)<Ss&&(Ss=Is,Ls=0),-Is<Ss&&(Ss=-Is,Ls=1),(Is=It*Li+Lt*Ci+Ct*Ti)<Ss&&(Ss=Is,Ls=2),-Is<Ss&&(Ss=-Is,Ls=3),(Is=Tt*Li+At*Ci+Dt*Ti)<Ss&&(Ss=Is,Ls=4),-Is<Ss&&(Ss=-Is,Ls=5),0==Ls?(ns=J[0],rs=J[1],ls=J[2],cs=J[6],ms=J[7],ps=J[8],us=J[9],ys=J[10],xs=J[11],ds=J[3],fs=J[4],bs=J[5]):1==Ls?(ns=J[15],rs=J[16],ls=J[17],cs=J[21],ms=J[22],ps=J[23],us=J[18],ys=J[19],xs=J[20],ds=J[12],fs=J[13],bs=J[14]):2==Ls?(ns=J[12],rs=J[13],ls=J[14],cs=J[0],ms=J[1],ps=J[2],us=J[3],ys=J[4],xs=J[5],ds=J[15],fs=J[16],bs=J[17]):3==Ls?(ns=J[21],rs=J[22],ls=J[23],cs=J[9],ms=J[10],ps=J[11],us=J[6],ys=J[7],xs=J[8],ds=J[18],fs=J[19],bs=J[20]):4==Ls?(ns=J[12],rs=J[13],ls=J[14],cs=J[18],ms=J[19],ps=J[20],us=J[6],ys=J[7],xs=J[8],ds=J[0],fs=J[1],bs=J[2]):5==Ls&&(ns=J[3],rs=J[4],ls=J[5],cs=J[9],ms=J[10],ps=J[11],us=J[21],ys=J[22],xs=J[23],ds=J[15],fs=J[16],bs=J[17])),this.clipVertices1[0]=ns,this.clipVertices1[1]=rs,this.clipVertices1[2]=ls,this.clipVertices1[3]=cs,this.clipVertices1[4]=ms,this.clipVertices1[5]=ps,this.clipVertices1[6]=us,this.clipVertices1[7]=ys,this.clipVertices1[8]=xs,this.clipVertices1[9]=ds,this.clipVertices1[10]=fs,this.clipVertices1[11]=bs,zs=0,E=((ks=this.clipVertices1[9])-Fi-Ji)*Ai+((Vs=this.clipVertices1[10])-Ri-Ui)*Di+((ws=this.clipVertices1[11])-qi-_i)*Bi;for(var Cs=0;Cs<4;Cs++)Ns=3*Cs,F=((Ms=this.clipVertices1[Ns])-Fi-Ji)*Ai+((Ps=this.clipVertices1[Ns+1])-Ri-Ui)*Di+((gs=this.clipVertices1[Ns+2])-qi-_i)*Bi,E>0?F>0?(Ns=3*zs,zs++,this.clipVertices2[Ns]=Ms,this.clipVertices2[Ns+1]=Ps,this.clipVertices2[Ns+2]=gs):(Ns=3*zs,zs++,as=E/(E-F),this.clipVertices2[Ns]=ks+(Ms-ks)*as,this.clipVertices2[Ns+1]=Vs+(Ps-Vs)*as,this.clipVertices2[Ns+2]=ws+(gs-ws)*as):F>0&&(Ns=3*zs,zs++,as=E/(E-F),this.clipVertices2[Ns]=ks+(Ms-ks)*as,this.clipVertices2[Ns+1]=Vs+(Ps-Vs)*as,this.clipVertices2[Ns+2]=ws+(gs-ws)*as,Ns=3*zs,zs++,this.clipVertices2[Ns]=Ms,this.clipVertices2[Ns+1]=Ps,this.clipVertices2[Ns+2]=gs),ks=Ms,Vs=Ps,ws=gs,E=F;if(0!=(vs=zs)){for(zs=0,Ns=3*(vs-1),E=((ks=this.clipVertices2[Ns])-Fi-Wi)*ji+((Vs=this.clipVertices2[Ns+1])-Ri-Hi)*Oi+((ws=this.clipVertices2[Ns+2])-qi-Qi)*Ei,Cs=0;Cs<vs;Cs++)Ns=3*Cs,F=((Ms=this.clipVertices2[Ns])-Fi-Wi)*ji+((Ps=this.clipVertices2[Ns+1])-Ri-Hi)*Oi+((gs=this.clipVertices2[Ns+2])-qi-Qi)*Ei,E>0?F>0?(Ns=3*zs,zs++,this.clipVertices1[Ns]=Ms,this.clipVertices1[Ns+1]=Ps,this.clipVertices1[Ns+2]=gs):(Ns=3*zs,zs++,as=E/(E-F),this.clipVertices1[Ns]=ks+(Ms-ks)*as,this.clipVertices1[Ns+1]=Vs+(Ps-Vs)*as,this.clipVertices1[Ns+2]=ws+(gs-ws)*as):F>0&&(Ns=3*zs,zs++,as=E/(E-F),this.clipVertices1[Ns]=ks+(Ms-ks)*as,this.clipVertices1[Ns+1]=Vs+(Ps-Vs)*as,this.clipVertices1[Ns+2]=ws+(gs-ws)*as,Ns=3*zs,zs++,this.clipVertices1[Ns]=Ms,this.clipVertices1[Ns+1]=Ps,this.clipVertices1[Ns+2]=gs),ks=Ms,Vs=Ps,ws=gs,E=F;if(0!=(vs=zs)){for(zs=0,Ns=3*(vs-1),E=((ks=this.clipVertices1[Ns])-Fi+Ji)*-Ai+((Vs=this.clipVertices1[Ns+1])-Ri+Ui)*-Di+((ws=this.clipVertices1[Ns+2])-qi+_i)*-Bi,Cs=0;Cs<vs;Cs++)Ns=3*Cs,F=((Ms=this.clipVertices1[Ns])-Fi+Ji)*-Ai+((Ps=this.clipVertices1[Ns+1])-Ri+Ui)*-Di+((gs=this.clipVertices1[Ns+2])-qi+_i)*-Bi,E>0?F>0?(Ns=3*zs,zs++,this.clipVertices2[Ns]=Ms,this.clipVertices2[Ns+1]=Ps,this.clipVertices2[Ns+2]=gs):(Ns=3*zs,zs++,as=E/(E-F),this.clipVertices2[Ns]=ks+(Ms-ks)*as,this.clipVertices2[Ns+1]=Vs+(Ps-Vs)*as,this.clipVertices2[Ns+2]=ws+(gs-ws)*as):F>0&&(Ns=3*zs,zs++,as=E/(E-F),this.clipVertices2[Ns]=ks+(Ms-ks)*as,this.clipVertices2[Ns+1]=Vs+(Ps-Vs)*as,this.clipVertices2[Ns+2]=ws+(gs-ws)*as,Ns=3*zs,zs++,this.clipVertices2[Ns]=Ms,this.clipVertices2[Ns+1]=Ps,this.clipVertices2[Ns+2]=gs),ks=Ms,Vs=Ps,ws=gs,E=F;if(0!=(vs=zs)){for(zs=0,Ns=3*(vs-1),E=((ks=this.clipVertices2[Ns])-Fi+Wi)*-ji+((Vs=this.clipVertices2[Ns+1])-Ri+Hi)*-Oi+((ws=this.clipVertices2[Ns+2])-qi+Qi)*-Ei,Cs=0;Cs<vs;Cs++)Ns=3*Cs,F=((Ms=this.clipVertices2[Ns])-Fi+Wi)*-ji+((Ps=this.clipVertices2[Ns+1])-Ri+Hi)*-Oi+((gs=this.clipVertices2[Ns+2])-qi+Qi)*-Ei,E>0?F>0?(Ns=3*zs,zs++,this.clipVertices1[Ns]=Ms,this.clipVertices1[Ns+1]=Ps,this.clipVertices1[Ns+2]=gs):(Ns=3*zs,zs++,as=E/(E-F),this.clipVertices1[Ns]=ks+(Ms-ks)*as,this.clipVertices1[Ns+1]=Vs+(Ps-Vs)*as,this.clipVertices1[Ns+2]=ws+(gs-ws)*as):F>0&&(Ns=3*zs,zs++,as=E/(E-F),this.clipVertices1[Ns]=ks+(Ms-ks)*as,this.clipVertices1[Ns+1]=Vs+(Ps-Vs)*as,this.clipVertices1[Ns+2]=ws+(gs-ws)*as,Ns=3*zs,zs++,this.clipVertices1[Ns]=Ms,this.clipVertices1[Ns+1]=Ps,this.clipVertices1[Ns+2]=gs),ks=Ms,Vs=Ps,ws=gs,E=F;if(Xi){var Ts=h;h=e,e=Ts}if(0!=(vs=zs)){var As=h!=t;if(vs>4){Ai=ns-(ks=.25*(ns+cs+us+ds)),Di=rs-(Vs=.25*(rs+ms+ys+fs)),Bi=ls-(ws=.25*(ls+ps+xs+bs)),ji=cs-ks,Oi=ms-Vs,Ei=ps-ws;var Ds=0,Bs=0,js=0,Os=0,Es=-this.INF;for(Ss=this.INF,Cs=0;Cs<vs;Cs++)this.used[Cs]=!1,Ns=3*Cs,(Is=(ks=this.clipVertices1[Ns])*Ai+(Vs=this.clipVertices1[Ns+1])*Di+(ws=this.clipVertices1[Ns+2])*Bi)<Ss&&(Ss=Is,Ds=Cs),Is>Es&&(Es=Is,js=Cs);for(this.used[Ds]=!0,this.used[js]=!0,Es=-this.INF,Ss=this.INF,Cs=0;Cs<vs;Cs++)this.used[Cs]||(Ns=3*Cs,(Is=(ks=this.clipVertices1[Ns])*ji+(Vs=this.clipVertices1[Ns+1])*Oi+(ws=this.clipVertices1[Ns+2])*Ei)<Ss&&(Ss=Is,Bs=Cs),Is>Es&&(Es=Is,Os=Cs));Ns=3*Ds,(Is=((ks=this.clipVertices1[Ns])-Fi)*Li+((Vs=this.clipVertices1[Ns+1])-Ri)*Ci+((ws=this.clipVertices1[Ns+2])-qi)*Ti)<0&&s.addPoint(ks,Vs,ws,Li,Ci,Ti,Is,As),Ns=3*Bs,(Is=((ks=this.clipVertices1[Ns])-Fi)*Li+((Vs=this.clipVertices1[Ns+1])-Ri)*Ci+((ws=this.clipVertices1[Ns+2])-qi)*Ti)<0&&s.addPoint(ks,Vs,ws,Li,Ci,Ti,Is,As),Ns=3*js,(Is=((ks=this.clipVertices1[Ns])-Fi)*Li+((Vs=this.clipVertices1[Ns+1])-Ri)*Ci+((ws=this.clipVertices1[Ns+2])-qi)*Ti)<0&&s.addPoint(ks,Vs,ws,Li,Ci,Ti,Is,As),Ns=3*Os,(Is=((ks=this.clipVertices1[Ns])-Fi)*Li+((Vs=this.clipVertices1[Ns+1])-Ri)*Ci+((ws=this.clipVertices1[Ns+2])-qi)*Ti)<0&&s.addPoint(ks,Vs,ws,Li,Ci,Ti,Is,As)}else for(Cs=0;Cs<vs;Cs++)Ns=3*Cs,(Is=((ks=this.clipVertices1[Ns])-Fi)*Li+((Vs=this.clipVertices1[Ns+1])-Ri)*Ci+((ws=this.clipVertices1[Ns+2])-qi)*Ti)<0&&s.addPoint(ks,Vs,ws,Li,Ci,Ti,Is,As)}}}}}}}}),BoxCylinderCollisionDetector.prototype=Object.assign(Object.create(CollisionDetector.prototype),{constructor:BoxCylinderCollisionDetector,getSep:function(t,i,s,h,e){var o,a,n,r,l,c,m,p,u,y,x,d,f,b=new Vec3,v=t.position.x,z=t.position.y,N=t.position.z,k=i.position.x,V=i.position.y,w=i.position.z,P=k-v,g=V-z,S=w-N;P*P+g*g+S*S==0&&(g=.001);var I=-P,L=-g,C=-S;this.supportPointB(t,-I,-L,-C,b);var T=b.x,A=b.y,D=b.z;this.supportPointC(i,I,L,C,b);var B=b.x,j=b.y,O=b.z,E=B-T,F=j-A,R=O-D;if(E*I+F*L+R*C<=0)return!1;if((I=F*S-R*g)*I+(L=R*P-E*S)*L+(C=E*g-F*P)*C==0)return s.set(E-P,F-g,R-S).normalize(),h.set(.5*(T+B),.5*(A+j),.5*(D+O)),!0;this.supportPointB(t,-I,-L,-C,b);var q=b.x,J=b.y,U=b.z;this.supportPointC(i,I,L,C,b);var _=b.x,W=b.y,H=b.z,Q=_-q,X=W-J,Y=H-U;if(Q*I+X*L+Y*C<=0)return!1;(I=(a=F-g)*(c=Y-S)-(n=R-S)*(l=X-g))*P+(L=n*(r=Q-P)-(o=E-P)*c)*g+(C=o*l-a*r)*S>0&&(o=E,a=F,n=R,E=Q,F=X,R=Y,Q=o,X=a,Y=n,o=T,a=A,n=D,T=q,A=J,D=U,q=o,J=a,U=n,o=B,a=j,n=O,B=_,j=W,O=H,_=o,W=a,H=n,I=-I,L=-L,C=-C);for(var Z=0;;){if(++Z>100)return!1;this.supportPointB(t,-I,-L,-C,b);var K=b.x,G=b.y,$=b.z;this.supportPointC(i,I,L,C,b);var tt=b.x,it=b.y,st=b.z,ht=tt-K,et=it-G,ot=st-$;if(ht*I+et*L+ot*C<=0)return!1;if((F*ot-R*et)*P+(R*ht-E*ot)*g+(E*et-F*ht)*S<0)Q=ht,X=et,Y=ot,q=K,J=G,U=$,_=tt,W=it,H=st,I=(a=F-g)*(c=ot-S)-(n=R-S)*(l=et-g),L=n*(r=ht-P)-(o=E-P)*c,C=o*l-a*r;else if((et*Y-ot*X)*P+(ot*Q-ht*Y)*g+(ht*X-et*Q)*S<0)E=ht,F=et,R=ot,T=K,A=G,D=$,B=tt,j=it,O=st,I=(a=et-g)*(c=Y-S)-(n=ot-S)*(l=X-g),L=n*(r=Q-P)-(o=ht-P)*c,C=o*l-a*r;else for(var at=!1;;){if(I=(a=X-F)*(c=ot-R)-(n=Y-R)*(l=et-F),L=n*(r=ht-E)-(o=Q-E)*c,C=o*l-a*r,(I*=m=1/M.sqrt(I*I+L*L+C*C))*E+(L*=m)*F+(C*=m)*R>=0&&!at){var nt=(F*Y-R*X)*ht+(R*Q-E*Y)*et+(E*X-F*Q)*ot,rt=(et*Y-ot*X)*P+(ot*Q-ht*Y)*g+(ht*X-et*Q)*S,lt=(g*R-S*F)*ht+(S*E-P*R)*et+(P*F-g*E)*ot,ct=(X*R-Y*F)*P+(Y*E-Q*R)*g+(Q*F-X*E)*S,mt=nt+rt+lt+ct;mt<=0&&(nt=0,mt=(rt=(X*ot-Y*et)*I+(Y*ht-Q*ot)*L+(Q*et-X*ht)*C)+(lt=(et*Y-ot*X)*I+(ot*Q-ht*Y)*L+(ht*X-et*Q)*C)+(ct=(F*Y-R*X)*I+(R*Q-E*Y)*L+(E*X-F*Q)*C));var pt=1/mt;p=(v*nt+T*rt+q*lt+K*ct)*pt,u=(z*nt+A*rt+J*lt+G*ct)*pt,y=(N*nt+D*rt+U*lt+$*ct)*pt,x=(k*nt+B*rt+_*lt+tt*ct)*pt,d=(V*nt+j*rt+W*lt+it*ct)*pt,f=(w*nt+O*rt+H*lt+st*ct)*pt,at=!0}this.supportPointB(t,-I,-L,-C,b);var ut=b.x,yt=b.y,xt=b.z;this.supportPointC(i,I,L,C,b);var dt=b.x,ft=b.y,bt=b.z,vt=dt-ut,zt=ft-yt,Nt=bt-xt,kt=-(vt*I+zt*L+Nt*C);if((vt-ht)*I+(zt-et)*L+(Nt-ot)*C<=.01||kt>=0)return!!at&&(s.set(-I,-L,-C),h.set(.5*(p+x),.5*(u+d),.5*(y+f)),e.x=kt,!0);(zt*R-Nt*F)*P+(Nt*E-vt*R)*g+(vt*F-zt*E)*S<0?(zt*Y-Nt*X)*P+(Nt*Q-vt*Y)*g+(vt*X-zt*Q)*S<0?(E=vt,F=zt,R=Nt,T=ut,A=yt,D=xt,B=dt,j=ft,O=bt):(ht=vt,et=zt,ot=Nt,K=ut,G=yt,$=xt,tt=dt,it=ft,st=bt):(zt*ot-Nt*et)*P+(Nt*ht-vt*ot)*g+(vt*et-zt*ht)*S<0?(Q=vt,X=zt,Y=Nt,q=ut,J=yt,U=xt,_=dt,W=ft,H=bt):(E=vt,F=zt,R=Nt,T=ut,A=yt,D=xt,B=dt,j=ft,O=bt)}}},supportPointB:function(t,i,s,h,e){var o,a,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=t.halfWidth,u=t.halfHeight,y=t.halfDepth;o=l<0?-p:p,a=c<0?-u:u,n=m<0?-y:y,l=r[0]*o+r[1]*a+r[2]*n+t.position.x,c=r[3]*o+r[4]*a+r[5]*n+t.position.y,m=r[6]*o+r[7]*a+r[8]*n+t.position.z,e.set(l,c,m)},supportPointC:function(t,i,s,h,e){var o,a,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=l,u=m,y=p*p+u*u,x=t.radius,d=t.halfHeight;0==y?c<0?(o=x,a=-d,n=0):(o=x,a=d,n=0):(y=t.radius/M.sqrt(y),c<0?(o=p*y,a=-d,n=u*y):(o=p*y,a=d,n=u*y)),l=r[0]*o+r[1]*a+r[2]*n+t.position.x,c=r[3]*o+r[4]*a+r[5]*n+t.position.y,m=r[6]*o+r[7]*a+r[8]*n+t.position.z,e.set(l,c,m)},detectCollision:function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var o=new Vec3,a=new Vec3,n=new Vec3;if(this.getSep(h,e,o,a,n)){var r=h.position.x,l=h.position.y,c=h.position.z,m=e.position.x,p=e.position.y,u=e.position.z,y=h.halfWidth,x=h.halfHeight,d=h.halfDepth,f=e.halfHeight,b=e.radius,v=h.dimentions,z=v[0],N=v[1],k=v[2],V=v[3],w=v[4],P=v[5],g=v[6],S=v[7],I=v[8],L=v[9],C=v[10],T=v[11],A=v[12],D=v[13],B=v[14],j=v[15],O=v[16],E=v[17],F=e.normalDirection.x,R=e.normalDirection.y,q=e.normalDirection.z,J=e.halfDirection.x,U=e.halfDirection.y,_=e.halfDirection.z,W=o.x,H=o.y,Q=o.z,X=W*z+H*N+Q*k,Y=W*V+H*w+Q*P,Z=W*g+H*S+Q*I,K=W*F+H*R+Q*q,G=X>0,$=Y>0,tt=Z>0,it=K>0;G||(X=-X),$||(Y=-Y),tt||(Z=-Z),it||(K=-K);var st,ht,et,ot,at,nt,rt,lt,ct,mt,pt,ut,yt,xt,dt,ft,bt,vt,zt,Nt,kt,Vt,wt,Mt,Pt,gt,St,It,Lt,Ct,Tt,At,Dt,Bt,jt,Ot,Et,Ft,Rt,qt,Jt,Ut,_t,Wt,Ht,Qt,Xt,Yt,Zt,Kt,Gt,$t,ti,ii=0;if(K>.999?ii=X>.999?X>K?1:4:Y>.999?Y>K?2:4:Z>.999&&Z>K?3:4:X>.999?ii=1:Y>.999?ii=2:Z>.999&&(ii=3),0==ii)s.addPoint(a.x,a.y,a.z,W,H,Q,n.x,this.flip);else if(4==ii){var si,hi,ei,oi,ai,ni,ri,li,ci,mi,pi,ui;it?(ot=m-J,at=p-U,nt=u-_,W=-F,H=-R,Q=-q):(ot=m+J,at=p+U,nt=u+_,W=F,H=R,Q=q),ii=0,(_t=z*W+N*H+k*Q)<(Nt=1)&&(Nt=_t,ii=0),-_t<Nt&&(Nt=-_t,ii=1),(_t=V*W+w*H+P*Q)<Nt&&(Nt=_t,ii=2),-_t<Nt&&(Nt=-_t,ii=3),(_t=g*W+S*H+I*Q)<Nt&&(Nt=_t,ii=4),-_t<Nt&&(Nt=-_t,ii=5);var yi=h.elements;switch(ii){case 0:si=yi[0],hi=yi[1],ei=yi[2],oi=yi[6],ai=yi[7],ni=yi[8],ri=yi[9],li=yi[10],ci=yi[11],mi=yi[3],pi=yi[4],ui=yi[5];break;case 1:si=yi[15],hi=yi[16],ei=yi[17],oi=yi[21],ai=yi[22],ni=yi[23],ri=yi[18],li=yi[19],ci=yi[20],mi=yi[12],pi=yi[13],ui=yi[14];break;case 2:si=yi[12],hi=yi[13],ei=yi[14],oi=yi[0],ai=yi[1],ni=yi[2],ri=yi[3],li=yi[4],ci=yi[5],mi=yi[15],pi=yi[16],ui=yi[17];break;case 3:si=yi[21],hi=yi[22],ei=yi[23],oi=yi[9],ai=yi[10],ni=yi[11],ri=yi[6],li=yi[7],ci=yi[8],mi=yi[18],pi=yi[19],ui=yi[20];break;case 4:si=yi[12],hi=yi[13],ei=yi[14],oi=yi[18],ai=yi[19],ni=yi[20],ri=yi[6],li=yi[7],ci=yi[8],mi=yi[0],pi=yi[1],ui=yi[2];break;case 5:si=yi[3],hi=yi[4],ei=yi[5],oi=yi[9],ai=yi[10],ni=yi[11],ri=yi[21],li=yi[22],ci=yi[23],mi=yi[15],pi=yi[16],ui=yi[17]}(zt=W*(si-ot)+H*(hi-at)+Q*(ei-nt))<=0&&s.addPoint(si,hi,ei,-W,-H,-Q,zt,this.flip),(zt=W*(oi-ot)+H*(ai-at)+Q*(ni-nt))<=0&&s.addPoint(oi,ai,ni,-W,-H,-Q,zt,this.flip),(zt=W*(ri-ot)+H*(li-at)+Q*(ci-nt))<=0&&s.addPoint(ri,li,ci,-W,-H,-Q,zt,this.flip),(zt=W*(mi-ot)+H*(pi-at)+Q*(ui-nt))<=0&&s.addPoint(mi,pi,ui,-W,-H,-Q,zt,this.flip)}else{switch(ii){case 1:G?(st=r+L,ht=l+C,et=c+T,W=z,H=N,Q=k):(st=r-L,ht=l-C,et=c-T,W=-z,H=-N,Q=-k),Qt=V,Xt=w,Yt=P,$t=x,Zt=g,Kt=S,Gt=I,ti=d;break;case 2:$?(st=r+A,ht=l+D,et=c+B,W=V,H=w,Q=P):(st=r-A,ht=l-D,et=c-B,W=-V,H=-w,Q=-P),Qt=z,Xt=N,Yt=k,$t=y,Zt=g,Kt=S,Gt=I,ti=d;break;case 3:tt?(st=r+j,ht=l+O,et=c+E,W=g,H=S,Q=I):(st=r-j,ht=l-O,et=c-E,W=-g,H=-S,Q=-I),Qt=z,Xt=N,Yt=k,$t=y,Zt=V,Kt=w,Gt=P,ti=x}if(ot=m+(kt=(Nt=W*F+H*R+Q*q)<0?f:-f)*F,at=p+kt*R,nt=u+kt*q,K>=.999999?(Vt=-H,wt=Q,Mt=W):(Vt=W,wt=H,Mt=Q),gt=(kt=Vt*F+wt*R+Mt*q)*F-Vt,St=kt*R-wt,It=kt*q-Mt,0==(kt=M.sqrt(gt*gt+St*St+It*It)))return;if(Vt=ot+(gt*=kt=b/kt),wt=at+(St*=kt),Mt=nt+(It*=kt),Nt<-.96||Nt>.96)rt=F*F*1.5-.5,lt=F*R*1.5-.866025403*q,ct=F*q*1.5+.866025403*R,mt=R*F*1.5+.866025403*q,pt=R*R*1.5-.5,ut=R*q*1.5-.866025403*F,yt=q*F*1.5-.866025403*R,xt=q*R*1.5+.866025403*F,dt=q*q*1.5-.5,(Ft=Qt*(Vt=(ft=Vt)-(zt=W*(ft-st)+H*((bt=wt)-ht)+Q*((vt=Mt)-et))*W-st)+Xt*(wt=bt-zt*H-ht)+Yt*(Mt=vt-zt*Q-et))<-$t?Ft=-$t:Ft>$t&&(Ft=$t),(Ut=Zt*Vt+Kt*wt+Gt*Mt)<-ti?Ut=-ti:Ut>ti&&(Ut=ti),ft=st+(Vt=Ft*Qt+Ut*Zt),bt=ht+(wt=Ft*Xt+Ut*Kt),vt=et+(Mt=Ft*Yt+Ut*Gt),s.addPoint(ft,bt,vt,W,H,Q,zt,this.flip),bt=gt*mt+St*pt+It*ut,vt=gt*yt+St*xt+It*dt,(zt=W*((ft=(gt=ft=gt*rt+St*lt+It*ct)+ot)-st)+H*((bt=(St=bt)+at)-ht)+Q*((vt=(It=vt)+nt)-et))<=0&&((Ft=Qt*(Vt=ft-zt*W-st)+Xt*(wt=bt-zt*H-ht)+Yt*(Mt=vt-zt*Q-et))<-$t?Ft=-$t:Ft>$t&&(Ft=$t),(Ut=Zt*Vt+Kt*wt+Gt*Mt)<-ti?Ut=-ti:Ut>ti&&(Ut=ti),ft=st+(Vt=Ft*Qt+Ut*Zt),bt=ht+(wt=Ft*Xt+Ut*Kt),vt=et+(Mt=Ft*Yt+Ut*Gt),s.addPoint(ft,bt,vt,W,H,Q,zt,this.flip)),bt=gt*mt+St*pt+It*ut,vt=gt*yt+St*xt+It*dt,(zt=W*((ft=(gt=ft=gt*rt+St*lt+It*ct)+ot)-st)+H*((bt=(St=bt)+at)-ht)+Q*((vt=(It=vt)+nt)-et))<=0&&((Ft=Qt*(Vt=ft-zt*W-st)+Xt*(wt=bt-zt*H-ht)+Yt*(Mt=vt-zt*Q-et))<-$t?Ft=-$t:Ft>$t&&(Ft=$t),(Ut=Zt*Vt+Kt*wt+Gt*Mt)<-ti?Ut=-ti:Ut>ti&&(Ut=ti),ft=st+(Vt=Ft*Qt+Ut*Zt),bt=ht+(wt=Ft*Xt+Ut*Kt),vt=et+(Mt=Ft*Yt+Ut*Gt),s.addPoint(ft,bt,vt,W,H,Q,zt,this.flip));else{if(jt=Vt,Nt>0?(Rt=Vt+2*J,qt=wt+2*U,Jt=Mt+2*_):(Rt=Vt-2*J,qt=wt-2*U,Jt=Mt-2*_),Vt=(Rt-=(Ut=W*(Rt-st)+H*(qt-ht)+Q*(Jt-et))*W)-(jt-=(Ft=W*(jt-st)+H*((Ot=wt)-ht)+Q*((Et=Mt)-et))*W),wt=(qt-=Ut*H)-(Ot-=Ft*H),Mt=(Jt-=Ut*Q)-(Et-=Ft*Q),Pt=Ut-Ft,Wt=(Y=(At=Rt-st)*Qt+(Dt=qt-ht)*Xt+(Bt=Jt-et)*Yt)-$t,(_t=(X=(Lt=jt-st)*Qt+(Ct=Ot-ht)*Xt+(Tt=Et-et)*Yt)-$t)>0){if(Wt>0)return;X=(Lt=(jt+=Vt*(Ht=_t/(_t-Wt)))-st)*Qt+(Ct=(Ot+=wt*Ht)-ht)*Xt+(Tt=(Et+=Mt*Ht)-et)*Yt,Vt=Rt-jt,wt=qt-Ot,Mt=Jt-Et,Pt=Ut-(Ft+=Pt*Ht)}else Wt>0&&(Y=(At=(Rt=jt+Vt*(Ht=_t/(_t-Wt)))-st)*Qt+(Dt=(qt=Ot+wt*Ht)-ht)*Xt+(Bt=(Jt=Et+Mt*Ht)-et)*Yt,Vt=Rt-jt,wt=qt-Ot,Mt=Jt-Et,Pt=(Ut=Ft+Pt*Ht)-Ft);if(Wt=Y+$t,(_t=X+$t)<0){if(Wt<0)return;Lt=(jt+=Vt*(Ht=_t/(_t-Wt)))-st,Ct=(Ot+=wt*Ht)-ht,Tt=(Et+=Mt*Ht)-et,Vt=Rt-jt,wt=qt-Ot,Mt=Jt-Et,Pt=Ut-(Ft+=Pt*Ht)}else Wt<0&&(At=(Rt=jt+Vt*(Ht=_t/(_t-Wt)))-st,Dt=(qt=Ot+wt*Ht)-ht,Bt=(Jt=Et+Mt*Ht)-et,Vt=Rt-jt,wt=qt-Ot,Mt=Jt-Et,Pt=(Ut=Ft+Pt*Ht)-Ft);if(Wt=(Y=At*Zt+Dt*Kt+Bt*Gt)-ti,(_t=(X=Lt*Zt+Ct*Kt+Tt*Gt)-ti)>0){if(Wt>0)return;X=(Lt=(jt+=Vt*(Ht=_t/(_t-Wt)))-st)*Zt+(Ct=(Ot+=wt*Ht)-ht)*Kt+(Tt=(Et+=Mt*Ht)-et)*Gt,Vt=Rt-jt,wt=qt-Ot,Mt=Jt-Et,Pt=Ut-(Ft+=Pt*Ht)}else Wt>0&&(Y=(At=(Rt=jt+Vt*(Ht=_t/(_t-Wt)))-st)*Zt+(Dt=(qt=Ot+wt*Ht)-ht)*Kt+(Bt=(Jt=Et+Mt*Ht)-et)*Gt,Vt=Rt-jt,wt=qt-Ot,Mt=Jt-Et,Pt=(Ut=Ft+Pt*Ht)-Ft);if(Wt=Y+ti,(_t=X+ti)<0){if(Wt<0)return;jt+=Vt*(Ht=_t/(_t-Wt)),Ot+=wt*Ht,Et+=Mt*Ht,Ft+=Pt*Ht}else Wt<0&&(Rt=jt+Vt*(Ht=_t/(_t-Wt)),qt=Ot+wt*Ht,Jt=Et+Mt*Ht,Ut=Ft+Pt*Ht);Ft<0&&s.addPoint(jt,Ot,Et,W,H,Q,Ft,this.flip),Ut<0&&s.addPoint(Rt,qt,Jt,W,H,Q,Ut,this.flip)}}}}}),CylinderCylinderCollisionDetector.prototype=Object.assign(Object.create(CollisionDetector.prototype),{constructor:CylinderCylinderCollisionDetector,getSep:function(t,i,s,h,e){var o,a,n,r,l,c,m,p,u,y,x,d,f,b=new Vec3,v=t.position.x,z=t.position.y,N=t.position.z,k=i.position.x,V=i.position.y,w=i.position.z,P=k-v,g=V-z,S=w-N;P*P+g*g+S*S==0&&(g=.001);var I=-P,L=-g,C=-S;this.supportPoint(t,-I,-L,-C,b);var T=b.x,A=b.y,D=b.z;this.supportPoint(i,I,L,C,b);var B=b.x,j=b.y,O=b.z,E=B-T,F=j-A,R=O-D;if(E*I+F*L+R*C<=0)return!1;if((I=F*S-R*g)*I+(L=R*P-E*S)*L+(C=E*g-F*P)*C==0)return s.set(E-P,F-g,R-S).normalize(),h.set(.5*(T+B),.5*(A+j),.5*(D+O)),!0;this.supportPoint(t,-I,-L,-C,b);var q=b.x,J=b.y,U=b.z;this.supportPoint(i,I,L,C,b);var _=b.x,W=b.y,H=b.z,Q=_-q,X=W-J,Y=H-U;if(Q*I+X*L+Y*C<=0)return!1;(I=(a=F-g)*(c=Y-S)-(n=R-S)*(l=X-g))*P+(L=n*(r=Q-P)-(o=E-P)*c)*g+(C=o*l-a*r)*S>0&&(o=E,a=F,n=R,E=Q,F=X,R=Y,Q=o,X=a,Y=n,o=T,a=A,n=D,T=q,A=J,D=U,q=o,J=a,U=n,o=B,a=j,n=O,B=_,j=W,O=H,_=o,W=a,H=n,I=-I,L=-L,C=-C);for(var Z=0;;){if(++Z>100)return!1;this.supportPoint(t,-I,-L,-C,b);var K=b.x,G=b.y,$=b.z;this.supportPoint(i,I,L,C,b);var tt=b.x,it=b.y,st=b.z,ht=tt-K,et=it-G,ot=st-$;if(ht*I+et*L+ot*C<=0)return!1;if((F*ot-R*et)*P+(R*ht-E*ot)*g+(E*et-F*ht)*S<0)Q=ht,X=et,Y=ot,q=K,J=G,U=$,_=tt,W=it,H=st,I=(a=F-g)*(c=ot-S)-(n=R-S)*(l=et-g),L=n*(r=ht-P)-(o=E-P)*c,C=o*l-a*r;else if((et*Y-ot*X)*P+(ot*Q-ht*Y)*g+(ht*X-et*Q)*S<0)E=ht,F=et,R=ot,T=K,A=G,D=$,B=tt,j=it,O=st,I=(a=et-g)*(c=Y-S)-(n=ot-S)*(l=X-g),L=n*(r=Q-P)-(o=ht-P)*c,C=o*l-a*r;else for(var at=!1;;){if(I=(a=X-F)*(c=ot-R)-(n=Y-R)*(l=et-F),L=n*(r=ht-E)-(o=Q-E)*c,C=o*l-a*r,(I*=m=1/M.sqrt(I*I+L*L+C*C))*E+(L*=m)*F+(C*=m)*R>=0&&!at){var nt=(F*Y-R*X)*ht+(R*Q-E*Y)*et+(E*X-F*Q)*ot,rt=(et*Y-ot*X)*P+(ot*Q-ht*Y)*g+(ht*X-et*Q)*S,lt=(g*R-S*F)*ht+(S*E-P*R)*et+(P*F-g*E)*ot,ct=(X*R-Y*F)*P+(Y*E-Q*R)*g+(Q*F-X*E)*S,mt=nt+rt+lt+ct;mt<=0&&(nt=0,mt=(rt=(X*ot-Y*et)*I+(Y*ht-Q*ot)*L+(Q*et-X*ht)*C)+(lt=(et*Y-ot*X)*I+(ot*Q-ht*Y)*L+(ht*X-et*Q)*C)+(ct=(F*Y-R*X)*I+(R*Q-E*Y)*L+(E*X-F*Q)*C));var pt=1/mt;p=(v*nt+T*rt+q*lt+K*ct)*pt,u=(z*nt+A*rt+J*lt+G*ct)*pt,y=(N*nt+D*rt+U*lt+$*ct)*pt,x=(k*nt+B*rt+_*lt+tt*ct)*pt,d=(V*nt+j*rt+W*lt+it*ct)*pt,f=(w*nt+O*rt+H*lt+st*ct)*pt,at=!0}this.supportPoint(t,-I,-L,-C,b);var ut=b.x,yt=b.y,xt=b.z;this.supportPoint(i,I,L,C,b);var dt=b.x,ft=b.y,bt=b.z,vt=dt-ut,zt=ft-yt,Nt=bt-xt,kt=-(vt*I+zt*L+Nt*C);if((vt-ht)*I+(zt-et)*L+(Nt-ot)*C<=.01||kt>=0)return!!at&&(s.set(-I,-L,-C),h.set(.5*(p+x),.5*(u+d),.5*(y+f)),e.x=kt,!0);(zt*R-Nt*F)*P+(Nt*E-vt*R)*g+(vt*F-zt*E)*S<0?(zt*Y-Nt*X)*P+(Nt*Q-vt*Y)*g+(vt*X-zt*Q)*S<0?(E=vt,F=zt,R=Nt,T=ut,A=yt,D=xt,B=dt,j=ft,O=bt):(ht=vt,et=zt,ot=Nt,K=ut,G=yt,$=xt,tt=dt,it=ft,st=bt):(zt*ot-Nt*et)*P+(Nt*ht-vt*ot)*g+(vt*et-zt*ht)*S<0?(Q=vt,X=zt,Y=Nt,q=ut,J=yt,U=xt,_=dt,W=ft,H=bt):(E=vt,F=zt,R=Nt,T=ut,A=yt,D=xt,B=dt,j=ft,O=bt)}}},supportPoint:function(t,i,s,h,e){var o,a,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=l,u=m,y=p*p+u*u,x=t.radius,d=t.halfHeight;0==y?c<0?(o=x,a=-d,n=0):(o=x,a=d,n=0):(y=t.radius/M.sqrt(y),c<0?(o=p*y,a=-d,n=u*y):(o=p*y,a=d,n=u*y)),l=r[0]*o+r[1]*a+r[2]*n+t.position.x,c=r[3]*o+r[4]*a+r[5]*n+t.position.y,m=r[6]*o+r[7]*a+r[8]*n+t.position.z,e.set(l,c,m)},detectCollision:function(t,i,s){var h,e;t.id<i.id?(h=t,e=i):(h=i,e=t);var o,a,n,r,l,c,m,p,u,y,x,d,f,b,v,z,N,k,V,w,P,g=h.position,S=e.position,I=g.x,L=g.y,C=g.z,T=S.x,A=S.y,D=S.z,B=h.halfHeight,j=e.halfHeight,O=h.normalDirection,E=e.normalDirection,F=h.halfDirection,R=e.halfDirection,q=h.radius,J=e.radius,U=O.x,_=O.y,W=O.z,H=E.x,Q=E.y,X=E.z,Y=F.x,Z=F.y,K=F.z,G=R.x,$=R.y,tt=R.z,it=I-T,st=L-A,ht=C-D,et=new Vec3,ot=new Vec3,at=new Vec3;if(this.getSep(h,e,et,ot,at)){var nt=et.x*U+et.y*_+et.z*W,rt=et.x*H+et.y*Q+et.z*X,lt=nt>0,ct=rt>0;lt||(nt=-nt),ct||(rt=-rt);var mt,pt,ut,yt=0;(nt>.999||rt>.999)&&(yt=nt>rt?1:2);var xt,dt,ft,bt,vt,zt,Nt,kt,Vt,wt,Mt,Pt,gt,St,It,Lt,Ct=at.x;switch(mt=et.x,pt=et.y,ut=et.z,yt){case 0:s.addPoint(ot.x,ot.y,ot.z,mt,pt,ut,Ct,!1);break;case 1:if(lt?(a=I+Y,n=L+Z,r=C+K,mt=U,pt=_,ut=W):(a=I-Y,n=L-Z,r=C-K,mt=-U,pt=-_,ut=-W),l=T+(o=(V=mt*H+pt*Q+ut*X)<0?j:-j)*H,c=A+o*Q,m=D+o*X,rt>=.999999?(p=-pt,u=ut,y=mt):(p=mt,u=pt,y=ut),it=(o=p*H+u*Q+y*X)*H-p,st=o*Q-u,ht=o*X-y,0==(o=M.sqrt(it*it+st*st+ht*ht)))break;if(p=l+(it*=o=J/o),u=c+(st*=o),y=m+(ht*=o),V<-.96||V>.96)xt=H*H*1.5-.5,dt=H*Q*1.5-.866025403*X,ft=H*X*1.5+.866025403*Q,bt=Q*H*1.5+.866025403*X,vt=Q*Q*1.5-.5,zt=Q*X*1.5-.866025403*H,Nt=X*H*1.5-.866025403*Q,kt=X*Q*1.5+.866025403*H,Vt=X*X*1.5-.5,(o=(p=(wt=p)-(gt=mt*(wt-a)+pt*((Mt=u)-n)+ut*((Pt=y)-r))*mt-a)*p+(u=Mt-gt*pt-n)*u+(y=Pt-gt*ut-r)*y)>q*q&&(p*=o=q/M.sqrt(o),u*=o,y*=o),wt=a+p,Mt=n+u,Pt=r+y,s.addPoint(wt,Mt,Pt,mt,pt,ut,gt,!1),Mt=it*bt+st*vt+ht*zt,Pt=it*Nt+st*kt+ht*Vt,(gt=mt*((wt=(it=wt=it*xt+st*dt+ht*ft)+l)-a)+pt*((Mt=(st=Mt)+c)-n)+ut*((Pt=(ht=Pt)+m)-r))<=0&&((o=(p=wt-gt*mt-a)*p+(u=Mt-gt*pt-n)*u+(y=Pt-gt*ut-r)*y)>q*q&&(p*=o=q/M.sqrt(o),u*=o,y*=o),wt=a+p,Mt=n+u,Pt=r+y,s.addPoint(wt,Mt,Pt,mt,pt,ut,gt,!1)),Mt=it*bt+st*vt+ht*zt,Pt=it*Nt+st*kt+ht*Vt,(gt=mt*((wt=(it=wt=it*xt+st*dt+ht*ft)+l)-a)+pt*((Mt=(st=Mt)+c)-n)+ut*((Pt=(ht=Pt)+m)-r))<=0&&((o=(p=wt-gt*mt-a)*p+(u=Mt-gt*pt-n)*u+(y=Pt-gt*ut-r)*y)>q*q&&(p*=o=q/M.sqrt(o),u*=o,y*=o),wt=a+p,Mt=n+u,Pt=r+y,s.addPoint(wt,Mt,Pt,mt,pt,ut,gt,!1));else{if(x=p,V>0?(b=p+H*j*2,v=u+Q*j*2,z=y+X*j*2):(b=p-H*j*2,v=u-Q*j*2,z=y-X*j*2),(Lt=(St=(it=a-(x-=(N=mt*(x-a)+pt*((d=u)-n)+ut*((f=y)-r))*mt))*(p=(b-=(k=mt*(b-a)+pt*(v-n)+ut*(z-r))*mt)-x)+(st=n-(d-=N*pt))*(u=(v-=k*pt)-d)+(ht=r-(f-=N*ut))*(y=(z-=k*ut)-f))*St-(It=p*p+u*u+y*y)*(it*it+st*st+ht*ht-q*q))<0)break;(P=(St-(Lt=M.sqrt(Lt)))/It)<(w=(St+Lt)/It)&&(o=w,w=P,P=o),P>1&&(P=1),w<0&&(w=0),p=x+(b-x)*w,u=d+(v-d)*w,y=f+(z-f)*w,b=x+(b-x)*P,v=d+(v-d)*P,z=f+(z-f)*P,x=p,d=u,f=y,o=N+(k-N)*w,k=N+(k-N)*P,(N=o)<0&&s.addPoint(x,d,f,mt,pt,ut,gt,!1),k<0&&s.addPoint(b,v,z,mt,pt,ut,gt,!1)}break;case 2:if(ct?(l=T-G,c=A-$,m=D-tt,mt=-H,pt=-Q,ut=-X):(l=T+G,c=A+$,m=D+tt,mt=H,pt=Q,ut=X),a=I+(o=(V=mt*U+pt*_+ut*W)<0?B:-B)*U,n=L+o*_,r=C+o*W,nt>=.999999?(p=-pt,u=ut,y=mt):(p=mt,u=pt,y=ut),it=(o=p*U+u*_+y*W)*U-p,st=o*_-u,ht=o*W-y,0==(o=M.sqrt(it*it+st*st+ht*ht)))break;if(p=a+(it*=o=q/o),u=n+(st*=o),y=r+(ht*=o),V<-.96||V>.96)xt=U*U*1.5-.5,dt=U*_*1.5-.866025403*W,ft=U*W*1.5+.866025403*_,bt=_*U*1.5+.866025403*W,vt=_*_*1.5-.5,zt=_*W*1.5-.866025403*U,Nt=W*U*1.5-.866025403*_,kt=W*_*1.5+.866025403*U,Vt=W*W*1.5-.5,(o=(p=(wt=p)-(gt=mt*(wt-l)+pt*((Mt=u)-c)+ut*((Pt=y)-m))*mt-l)*p+(u=Mt-gt*pt-c)*u+(y=Pt-gt*ut-m)*y)>J*J&&(p*=o=J/M.sqrt(o),u*=o,y*=o),wt=l+p,Mt=c+u,Pt=m+y,s.addPoint(wt,Mt,Pt,-mt,-pt,-ut,gt,!1),Mt=it*bt+st*vt+ht*zt,Pt=it*Nt+st*kt+ht*Vt,(gt=mt*((wt=(it=wt=it*xt+st*dt+ht*ft)+a)-l)+pt*((Mt=(st=Mt)+n)-c)+ut*((Pt=(ht=Pt)+r)-m))<=0&&((o=(p=wt-gt*mt-l)*p+(u=Mt-gt*pt-c)*u+(y=Pt-gt*ut-m)*y)>J*J&&(p*=o=J/M.sqrt(o),u*=o,y*=o),wt=l+p,Mt=c+u,Pt=m+y,s.addPoint(wt,Mt,Pt,-mt,-pt,-ut,gt,!1)),Mt=it*bt+st*vt+ht*zt,Pt=it*Nt+st*kt+ht*Vt,(gt=mt*((wt=(it=wt=it*xt+st*dt+ht*ft)+a)-l)+pt*((Mt=(st=Mt)+n)-c)+ut*((Pt=(ht=Pt)+r)-m))<=0&&((o=(p=wt-gt*mt-l)*p+(u=Mt-gt*pt-c)*u+(y=Pt-gt*ut-m)*y)>J*J&&(p*=o=J/M.sqrt(o),u*=o,y*=o),wt=l+p,Mt=c+u,Pt=m+y,s.addPoint(wt,Mt,Pt,-mt,-pt,-ut,gt,!1));else{if(x=p,V>0?(b=p+U*B*2,v=u+_*B*2,z=y+W*B*2):(b=p-U*B*2,v=u-_*B*2,z=y-W*B*2),(Lt=(St=(it=l-(x-=(N=mt*(x-l)+pt*((d=u)-c)+ut*((f=y)-m))*mt))*(p=(b-=(k=mt*(b-l)+pt*(v-c)+ut*(z-m))*mt)-x)+(st=c-(d-=N*pt))*(u=(v-=k*pt)-d)+(ht=m-(f-=N*ut))*(y=(z-=k*ut)-f))*St-(It=p*p+u*u+y*y)*(it*it+st*st+ht*ht-J*J))<0)break;(P=(St-(Lt=M.sqrt(Lt)))/It)<(w=(St+Lt)/It)&&(o=w,w=P,P=o),P>1&&(P=1),w<0&&(w=0),p=x+(b-x)*w,u=d+(v-d)*w,y=f+(z-f)*w,b=x+(b-x)*P,v=d+(v-d)*P,z=f+(z-f)*P,x=p,d=u,f=y,o=N+(k-N)*w,k=N+(k-N)*P,(N=o)<0&&s.addPoint(x,d,f,-mt,-pt,-ut,N,!1),k<0&&s.addPoint(b,v,z,-mt,-pt,-ut,k,!1)}}}}}),SphereBoxCollisionDetector.prototype=Object.assign(Object.create(CollisionDetector.prototype),{constructor:SphereBoxCollisionDetector,detectCollision:function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var o,a,n,r,l,c=e.dimentions,m=h.position,p=m.x,u=m.y,y=m.z,x=e.position,d=x.x,f=x.y,b=x.z,v=h.radius,z=e.halfWidth,N=e.halfHeight,k=e.halfDepth,V=p-d,w=u-f,P=y-b,g=c[0]*V+c[1]*w+c[2]*P,S=c[3]*V+c[4]*w+c[5]*P,I=c[6]*V+c[7]*w+c[8]*P,L=0;g>z?g=z:g<-z?g=-z:L=1,S>N?S=N:S<-N?S=-N:L|=2,I>k?I=k:I<-k?I=-k:L|=4,7==L?(P=I<0?k+I:k-I,(V=g<0?z+g:z-g)<(w=S<0?N+S:N-S)?V<P?(r=V-z,g<0?(g=-z,V=c[0],w=c[1],P=c[2]):(g=z,V=-c[0],w=-c[1],P=-c[2])):(r=P-k,I<0?(I=-k,V=c[6],w=c[7],P=c[8]):(I=k,V=-c[6],w=-c[7],P=-c[8])):w<P?(r=w-N,S<0?(S=-N,V=c[3],w=c[4],P=c[5]):(S=N,V=-c[3],w=-c[4],P=-c[5])):(r=P-k,I<0?(I=-k,V=c[6],w=c[7],P=c[8]):(I=k,V=-c[6],w=-c[7],P=-c[8])),o=d+g*c[0]+S*c[3]+I*c[6],a=f+g*c[1]+S*c[4]+I*c[7],n=b+g*c[2]+S*c[5]+I*c[8],s.addPoint(p+v*V,u+v*w,y+v*P,V,w,P,r-v,this.flip)):(o=d+g*c[0]+S*c[3]+I*c[6],a=f+g*c[1]+S*c[4]+I*c[7],n=b+g*c[2]+S*c[5]+I*c[8],(r=(V=o-m.x)*V+(w=a-m.y)*w+(P=n-m.z)*P)>0&&r<v*v&&(V*=l=1/(r=M.sqrt(r)),w*=l,P*=l,s.addPoint(p+v*V,u+v*w,y+v*P,V,w,P,r-v,this.flip)))}}),SphereCylinderCollisionDetector.prototype=Object.assign(Object.create(CollisionDetector.prototype),{constructor:SphereCylinderCollisionDetector,detectCollision:function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var o=h.position,a=o.x,n=o.y,r=o.z,l=e.position,c=l.x,m=l.y,p=l.z,u=e.normalDirection.x,y=e.normalDirection.y,x=e.normalDirection.z,d=h.radius,f=e.radius,b=d+f,v=e.halfHeight,z=a-c,N=n-m,k=r-p,V=z*u+N*y+k*x;if(!(V<-v-d||V>v+d)){var w,P=c+V*u,g=m+V*y,S=p+V*x,I=a-P,L=n-g,C=r-S,T=I*I+L*L+C*C;if(!(T>b*b))T>f*f&&(I*=T=f/M.sqrt(T),L*=T,C*=T),V<-v?V=-v:V>v&&(V=v),(T=(z=(P=c+V*u+I)-a)*z+(N=(g=m+V*y+L)-n)*N+(k=(S=p+V*x+C)-r)*k)>0&&T<d*d&&(z*=w=1/(T=M.sqrt(T)),N*=w,k*=w,s.addPoint(a+z*d,n+N*d,r+k*d,z,N,k,T-d,this.flip))}}}),SphereSphereCollisionDetector.prototype=Object.assign(Object.create(CollisionDetector.prototype),{constructor:SphereSphereCollisionDetector,detectCollision:function(t,i,s){var h=t,e=i,o=h.position,a=e.position,n=a.x-o.x,r=a.y-o.y,l=a.z-o.z,c=n*n+r*r+l*l,m=h.radius,p=m+e.radius;if(c>0&&c<p*p){var u=1/(c=M.sqrt(c));n*=u,r*=u,l*=u,s.addPoint(o.x+n*m,o.y+r*m,o.z+l*m,n,r,l,c-p,!1)}}}),SpherePlaneCollisionDetector.prototype=Object.assign(Object.create(CollisionDetector.prototype),{constructor:SpherePlaneCollisionDetector,detectCollision:function(t,i,s){var h,e=this.n,o=this.p,a=this.flip?i:t,n=this.flip?t:i,r=a.radius;e.sub(a.position,n.position),e.x*=n.normal.x,e.y*=n.normal.y,e.z*=n.normal.z,(h=e.lengthSq())>0&&h<r*r&&(h=M.sqrt(h),e.copy(n.normal).negate(),o.copy(a.position).addScaledVector(e,r),s.addPointVec(o,e,h-r,this.flip))}}),BoxPlaneCollisionDetector.prototype=Object.assign(Object.create(CollisionDetector.prototype),{constructor:BoxPlaneCollisionDetector,detectCollision:function(t,i,s){var h,e=this.n,o=this.p,a=this.cc,n=this.flip?i:t,r=this.flip?t:i,l=n.dimentions,c=n.halfWidth,m=n.halfHeight,p=n.halfDepth,u=0;this.dix.set(l[0],l[1],l[2]),this.diy.set(l[3],l[4],l[5]),this.diz.set(l[6],l[7],l[8]),e.sub(n.position,r.position),e.x*=r.normal.x,e.y*=r.normal.y,e.z*=r.normal.z,a.set(M.dotVectors(this.dix,e),M.dotVectors(this.diy,e),M.dotVectors(this.diz,e)),a.x>c?a.x=c:a.x<-c?a.x=-c:u=1,a.y>m?a.y=m:a.y<-m?a.y=-m:u|=2,a.z>p?a.z=p:a.z<-p?a.z=-p:u|=4,7===u&&(e.set(a.x<0?c+a.x:c-a.x,a.y<0?m+a.y:m-a.y,a.z<0?p+a.z:p-a.z),e.x<e.y?e.x<e.z?(h=e.x-c,a.x<0?(a.x=-c,e.copy(this.dix)):(a.x=c,e.subEqual(this.dix))):(h=e.z-p,a.z<0?(a.z=-p,e.copy(this.diz)):(a.z=p,e.subEqual(this.diz))):e.y<e.z?(h=e.y-m,a.y<0?(a.y=-m,e.copy(this.diy)):(a.y=m,e.subEqual(this.diy))):(h=e.z-p,a.z<0?(a.z=-p,e.copy(this.diz)):(a.z=p,e.subEqual(this.diz))),o.copy(r.position).addScaledVector(e,1),s.addPointVec(o,e,h,this.flip))}}),Object.assign(World.prototype,{World:!0,play:function(){if(null===this.timer){var t=this;this.timer=setInterval(function(){t.step()},this.timerate)}},stop:function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)},setGravity:function(t){this.gravity.fromArray(t)},getInfo:function(){return this.isStat?this.performance.show():""},clear:function(){for(this.stop(),this.preLoop=null,this.postLoop=null,this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies)},addRigidBody:function(t){t.parent&&printError("World","It is not possible to be added to more than one world one of the rigid body"),t.setParent(this);for(var i=t.shapes;null!==i;i=i.next)this.addShape(i);null!==this.rigidBodies&&((this.rigidBodies.prev=t).next=this.rigidBodies),this.rigidBodies=t,this.numRigidBodies++},removeRigidBody:function(t){var i=t;if(i.parent===this){i.awake();for(var s=i.jointLink;null!=s;){var h=s.joint;s=s.next,this.removeJoint(h)}for(var e=t.shapes;null!==e;e=e.next)this.removeShape(e);var o=i.prev,a=i.next;null!==o&&(o.next=a),null!==a&&(a.prev=o),this.rigidBodies==i&&(this.rigidBodies=a),i.prev=null,i.next=null,i.parent=null,this.numRigidBodies--}},getByName:function(t){for(var i=this.rigidBodies;null!==i;){if(i.name===t)return i;i=i.next}for(var s=this.joints;null!==s;){if(s.name===t)return s;s=s.next}return null},addShape:function(t){t.parent&&t.parent.parent||printError("World","It is not possible to be added alone to shape world"),t.proxy=this.broadPhase.createProxy(t),t.updateProxy(),this.broadPhase.addProxy(t.proxy)},removeShape:function(t){this.broadPhase.removeProxy(t.proxy),t.proxy=null},addJoint:function(t){t.parent&&printError("World","It is not possible to be added to more than one world one of the joint"),null!=this.joints&&((this.joints.prev=t).next=this.joints),this.joints=t,t.setParent(this),this.numJoints++,t.awake(),t.attach()},removeJoint:function(t){var i=t,s=i.prev,h=i.next;null!==s&&(s.next=h),null!==h&&(h.prev=s),this.joints==i&&(this.joints=h),i.prev=null,i.next=null,this.numJoints--,i.awake(),i.detach(),i.parent=null},addContact:function(t,i){var s;null!==this.unusedContacts?(s=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):s=new Contact,s.attach(t,i),s.detector=this.detectors[t.type][i.type],this.contacts&&((this.contacts.prev=s).next=this.contacts),this.contacts=s,this.numContacts++},removeContact:function(t){var i=t.prev,s=t.next;s&&(s.prev=i),i&&(i.next=s),this.contacts==t&&(this.contacts=s),t.prev=null,t.next=null,t.detach(),t.next=this.unusedContacts,this.unusedContacts=t,this.numContacts--},getContact:function(t,i){var s,h;t=t.constructor===RigidBody?t.name:t,i=i.constructor===RigidBody?i.name:i;for(var e=this.contacts;null!==e;){if(s=e.body1.name,h=e.body2.name,s===t&&h===i||h===t&&s===i)return e.touching?e:null;e=e.next}return null},checkContact:function(t,i){for(var s,h,e=this.contacts;null!==e;){if(s=e.body1.name||" ",h=e.body2.name||" ",s==t&&h==i||h==t&&s==i)return!!e.touching;e=e.next}},callSleep:function(t){return!!t.allowSleep&&(!(t.linearVelocity.lengthSq()>.04)&&!(t.angularVelocity.lengthSq()>.25))},step:function(){var t=this.isStat;t&&this.performance.setTime(0);for(var i=this.rigidBodies;null!==i;)i.addedToIsland=!1,i.sleeping&&i.testWakeUp(),i=i.next;t&&this.performance.setTime(1),this.broadPhase.detectPairs();for(var s=this.broadPhase.pairs,h=this.broadPhase.numPairs;h--;){var e,o,a,n=s[h];n.shape1.id<n.shape2.id?(e=n.shape1,o=n.shape2):(e=n.shape2,o=n.shape1),a=e.numContacts<o.numContacts?e.contactLink:o.contactLink;for(var r=!1;a;){if((z=a.contact).shape1==e&&z.shape2==o){z.persisting=!0,r=!0;break}a=a.next}r||this.addContact(e,o)}for(t&&this.performance.calcBroadPhase(),this.numContactPoints=0,z=this.contacts;null!==z;)if(z.persisting){var l=z.body1,c=z.body2;(l.isDynamic&&!l.sleeping||c.isDynamic&&!c.sleeping)&&z.updateManifold(),this.numContactPoints+=z.manifold.numPoints,z.persisting=!1,z.constraint.addedToIsland=!1,z=z.next}else{var m=z.next;this.removeContact(z),z=m}t&&this.performance.calcNarrowPhase();var p,u,y=1/this.timeStep;for(p=this.joints;null!==p;p=p.next)p.addedToIsland=!1;this.islandRigidBodies=[],this.islandConstraints=[],this.islandStack=[],t&&this.performance.setTime(1),this.numIslands=0;for(var x=this.rigidBodies;null!==x;x=x.next)if(!(x.addedToIsland||x.isStatic||x.sleeping))if(x.isLonely())x.isDynamic&&x.linearVelocity.addScaledVector(this.gravity,this.timeStep),this.callSleep(x)?(x.sleepTime+=this.timeStep,x.sleepTime>.5?x.sleep():x.updatePosition(this.timeStep)):(x.sleepTime=0,x.updatePosition(this.timeStep)),this.numIslands++;else{var d=0,f=0,b=1;this.islandStack[0]=x,x.addedToIsland=!0;do{if(i=this.islandStack[--b],this.islandStack[b]=null,i.sleeping=!1,this.islandRigidBodies[d++]=i,!i.isStatic){for(var v=i.contactLink;null!==v;v=v.next){var z;if(!(u=(z=v.contact).constraint).addedToIsland&&z.touching)this.islandConstraints[f++]=u,u.addedToIsland=!0,(m=v.body).addedToIsland||(this.islandStack[b++]=m,m.addedToIsland=!0)}for(var N=i.jointLink;null!==N;N=N.next)(u=N.joint).addedToIsland||(this.islandConstraints[f++]=u,u.addedToIsland=!0,!(m=N.body).addedToIsland&&m.isDynamic&&(this.islandStack[b++]=m,m.addedToIsland=!0))}}while(0!=b);for(var k=(new Vec3).addScaledVector(this.gravity,this.timeStep),V=d;V--;)(i=this.islandRigidBodies[V]).isDynamic&&i.linearVelocity.addEqual(k);if(this.enableRandomizer)for(V=f;V--;)if(0!==V){var w=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*V|0;u=this.islandConstraints[V],this.islandConstraints[V]=this.islandConstraints[w],this.islandConstraints[w]=u}for(V=f;V--;)this.islandConstraints[V].preSolve(this.timeStep,y);for(var M=this.numIterations;M--;)for(V=f;V--;)this.islandConstraints[V].solve();for(V=f;V--;)this.islandConstraints[V].postSolve(),this.islandConstraints[V]=null;var P=10;for(V=d;V--;)i=this.islandRigidBodies[V],this.callSleep(i)?(i.sleepTime+=this.timeStep,i.sleepTime<P&&(P=i.sleepTime)):(i.sleepTime=0,P=0);if(P>.5)for(V=d;V--;)this.islandRigidBodies[V].sleep(),this.islandRigidBodies[V]=null;else for(V=d;V--;)this.islandRigidBodies[V].updatePosition(this.timeStep),this.islandRigidBodies[V]=null;this.numIslands++}t&&this.performance.calcEnd(),null!==this.postLoop&&this.postLoop()},remove:function(t){},add:function(t){var i=(t=t||{}).type||"box";return i.constructor===String&&(i=[i]),"joint"===i[0].substring(0,5)?this.initJoint(i[0],t):this.initBody(i,t)},initBody:function(t,i){var s=this.invScale,h=i.move||!1,e=i.kinematic||!1,o=i.pos||[0,0,0];o=o.map(function(t){return t*s});var a=i.posShape||[0,0,0];a=a.map(function(t){return t*s});var n=i.rot||[0,0,0];n=n.map(function(t){return t*M.degtorad});var r=i.rotShape;r=n.map(function(t){return t*M.degtorad});var l=void 0===i.size?[1,1,1]:i.size;1===l.length&&(l[1]=l[0]),2===l.length&&(l[2]=l[0]),l=l.map(function(t){return t*s});var c=new ShapeConfig;void 0!==i.density&&(c.density=i.density),void 0!==i.friction&&(c.friction=i.friction),void 0!==i.restitution&&(c.restitution=i.restitution),void 0!==i.belongsTo&&(c.belongsTo=i.belongsTo),void 0!==i.collidesWith&&(c.collidesWith=i.collidesWith),void 0!==i.config&&(void 0!==i.config[0]&&(c.density=i.config[0]),void 0!==i.config[1]&&(c.friction=i.config[1]),void 0!==i.config[2]&&(c.restitution=i.config[2]),void 0!==i.config[3]&&(c.belongsTo=i.config[3]),void 0!==i.config[4]&&(c.collidesWith=i.config[4]));for(var m,p,u=new RigidBody(new Vec3(o[0],o[1],o[2]),(new Quat).setFromEuler(n[0],n[1],n[2])),y=0;y<t.length;y++){switch(void 0!==a[p=3*y]&&c.relativePosition.set(a[p],a[p+1],a[p+2]),void 0!==r[p]&&c.relativeRotation.setQuat((new Quat).setFromEuler(r[p],r[p+1],r[p+2])),t[y]){case"sphere":m=new Sphere(c,l[p]);break;case"cylinder":m=new Cylinder(c,l[p],l[p+1]);break;case"box":m=new Box(c,l[p],l[p+1],l[p+2]);break;case"plane":m=new Plane(c)}u.addShape(m)}return i.neverSleep||e?u.allowSleep=!1:u.allowSleep=!0,u.isKinematic=e,h?i.massPos||i.massRot?u.setupMass(1,!1):u.setupMass(1,!0):u.setupMass(2),void 0!==i.name&&(u.name=i.name),this.addRigidBody(u),h&&(i.sleep?u.sleep():u.awake()),u},initJoint:function(t,i){var s,h,e=this.invScale,o=i.axe1||[1,0,0],a=i.axe2||[1,0,0],n=i.pos1||[0,0,0],r=i.pos2||[0,0,0];n=n.map(function(t){return t*e}),r=r.map(function(t){return t*e}),"jointDistance"===t?(s=i.min||0,h=i.max||10,s*=e,h*=e):(s=i.min||57.29578,h=i.max||0,s*=M.degtorad,h*=M.degtorad);var l=i.limit||null,c=i.spring||null,m=i.motor||null,p=new JointConfig;p.scale=this.scale,p.invScale=this.invScale,p.allowCollision=i.collision||!1,p.localAxis1.set(o[0],o[1],o[2]),p.localAxis2.set(a[0],a[1],a[2]),p.localAnchorPoint1.set(n[0],n[1],n[2]),p.localAnchorPoint2.set(r[0],r[1],r[2]);var u,y=null,x=null;if(void 0===i.body1||void 0===i.body2)return printError("World","Can't add joint if attach rigidbodys not define !");if(i.body1.constructor===String?y=this.getByName(i.body1):i.body1.constructor===Number?y=this.getByName(i.body1):i.body1.constructor===RigidBody&&(y=i.body1),i.body2.constructor===String?x=this.getByName(i.body2):i.body2.constructor===Number?x=this.getByName(i.body2):i.body2.constructor===RigidBody&&(x=i.body2),null===y||null===x)return printError("World","Can't add joint attach rigidbodys not find !");switch(p.body1=y,p.body2=x,t){case"jointDistance":u=new DistanceJoint(p,s,h),null!==c&&u.limitMotor.setSpring(c[0],c[1]),null!==m&&u.limitMotor.setMotor(m[0],m[1]);break;case"jointHinge":case"joint":u=new HingeJoint(p,s,h),null!==c&&u.limitMotor.setSpring(c[0],c[1]),null!==m&&u.limitMotor.setMotor(m[0],m[1]);break;case"jointPrisme":u=new PrismaticJoint(p,s,h);break;case"jointSlide":u=new SliderJoint(p,s,h);break;case"jointBall":u=new BallAndSocketJoint(p);break;case"jointWheel":u=new WheelJoint(p),null!==l&&u.rotationalLimitMotor1.setLimit(l[0],l[1]),null!==c&&u.rotationalLimitMotor1.setSpring(c[0],c[1]),null!==m&&u.rotationalLimitMotor1.setMotor(m[0],m[1])}return u.name=i.name||"",this.addJoint(u),u}}),t.AABB_PROX=.005,t.BODY_DYNAMIC=1,t.BODY_GHOST=4,t.BODY_KINEMATIC=3,t.BODY_NULL=m,t.BODY_STATIC=2,t.BR_BOUNDING_VOLUME_TREE=c,t.BR_BRUTE_FORCE=r,t.BR_NULL=n,t.BR_SWEEP_AND_PRUNE=l,t.BallAndSocketJoint=BallAndSocketJoint,t.Box=Box,t.Cylinder=Cylinder,t.DistanceJoint=DistanceJoint,t.HingeJoint=HingeJoint,t.InfoDisplay=InfoDisplay,t.JOINT_BALL_AND_SOCKET=z,t.JOINT_DISTANCE=v,t.JOINT_HINGE=N,t.JOINT_NULL=b,t.JOINT_PRISMATIC=w,t.JOINT_SLIDER=V,t.JOINT_WHEEL=k,t.JointConfig=JointConfig,t.LimitMotor=LimitMotor,t.Mat33=Mat33,t.Math=M,t.Particle=Particle,t.Plane=Plane,t.PrismaticJoint=PrismaticJoint,t.Quat=Quat,t.REVISION=a,t.RigidBody=RigidBody,t.SHAPE_BOX=y,t.SHAPE_CYLINDER=x,t.SHAPE_NULL=p,t.SHAPE_PARTICLE=f,t.SHAPE_PLANE=d,t.SHAPE_SPHERE=u,t.SHAPE_TETRA=6,t.Shape=Shape,t.ShapeConfig=ShapeConfig,t.SliderJoint=SliderJoint,t.Sphere=Sphere,t.Vec3=Vec3,t.WheelJoint=WheelJoint,t.World=World,t.printError=printError,Object.defineProperty(t,"__esModule",{value:!0})});